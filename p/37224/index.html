<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><!-- hexo injector head_begin start --><link href="https://cdn.jsdelivr.net/npm/hexo-widget-tree@0.2.2/css/index.css" rel="stylesheet"/><!-- hexo injector head_begin end --><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>C++ä»é›¶å¼€å§‹ï¼ˆå¼€æºï¼‰ï¼šä¸€æ–‡è¯»æ‡‚muduo | royhuang's blog</title><meta name="author" content="Wanghui Huang"><meta name="copyright" content="Wanghui Huang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ğŸŒŸã€ŠC++ä»é›¶å¼€å§‹ã€‹ ç³»åˆ—ï¼Œå·¥ä½œå¿«ä¸€å¹´ï¼Œç»ˆäºåˆå¼€å§‹æ›´æ–°äº†â€¦ğŸ¥—  C++ä»é›¶å¼€å§‹https:&#x2F;&#x2F;hwh.zone&#x2F;p&#x2F;62712 åœ¨å­¦æ ¡æ¥è§¦C++æ¯”è¾ƒå°‘ï¼Œä¸»è¦æ˜¯ç”¨Java ã€Pythonè¾ƒå¤šã€‚å…¥èŒè…¾è®¯å‰ï¼Œä¸ºäº†æ¶è¡¥ä¸‹C++ç½‘ç»œç›¸å…³åŸºç¡€ï¼Œè¯»äº†ä¸€äº›ç»å…¸çš„demoçº§ å¼€æºåº“ï¼Œå¦‚ Tinyhttpd ã€Zavar ç­‰ã€‚å…¥èŒåå¤§å¤šæ•°æ—¶å€™åœ¨ä¸šåŠ¡å±å±±ä¸Šç©è€ï¼Œå†…éƒ¨ä¹Ÿæœ‰å°è£…å¥½çš„ç½‘ç»œæ¡†æ¶ï¼Œä½†ä¸€ç›´å¯¹ç½‘ç»œé€šä¿¡åº•å±‚æŒºæ„Ÿå…´">
<meta property="og:type" content="article">
<meta property="og:title" content="C++ä»é›¶å¼€å§‹ï¼ˆå¼€æºï¼‰ï¼šä¸€æ–‡è¯»æ‡‚muduo">
<meta property="og:url" content="https://hwh.zone/p/37224/index.html">
<meta property="og:site_name" content="royhuang&#39;s blog">
<meta property="og:description" content="ğŸŒŸã€ŠC++ä»é›¶å¼€å§‹ã€‹ ç³»åˆ—ï¼Œå·¥ä½œå¿«ä¸€å¹´ï¼Œç»ˆäºåˆå¼€å§‹æ›´æ–°äº†â€¦ğŸ¥—  C++ä»é›¶å¼€å§‹https:&#x2F;&#x2F;hwh.zone&#x2F;p&#x2F;62712 åœ¨å­¦æ ¡æ¥è§¦C++æ¯”è¾ƒå°‘ï¼Œä¸»è¦æ˜¯ç”¨Java ã€Pythonè¾ƒå¤šã€‚å…¥èŒè…¾è®¯å‰ï¼Œä¸ºäº†æ¶è¡¥ä¸‹C++ç½‘ç»œç›¸å…³åŸºç¡€ï¼Œè¯»äº†ä¸€äº›ç»å…¸çš„demoçº§ å¼€æºåº“ï¼Œå¦‚ Tinyhttpd ã€Zavar ç­‰ã€‚å…¥èŒåå¤§å¤šæ•°æ—¶å€™åœ¨ä¸šåŠ¡å±å±±ä¸Šç©è€ï¼Œå†…éƒ¨ä¹Ÿæœ‰å°è£…å¥½çš„ç½‘ç»œæ¡†æ¶ï¼Œä½†ä¸€ç›´å¯¹ç½‘ç»œé€šä¿¡åº•å±‚æŒºæ„Ÿå…´">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/about-bg.jpg">
<meta property="article:published_time" content="2023-03-11T05:48:01.602Z">
<meta property="article:modified_time" content="2023-03-12T03:07:15.211Z">
<meta property="article:author" content="Wanghui Huang">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="æ•™ç¨‹">
<meta property="article:tag" content="muduo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/about-bg.jpg"><link rel="shortcut icon" href="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/cat-modified.png"><link rel="canonical" href="https://hwh.zone/p/37224/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":"true# copy button","highlightLang":false,"highlightHeightLimit":400},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":80,"languages":{"author":"ä½œè€…: Wanghui Huang","link":"é“¾æ¥: ","source":"æ¥æº: royhuang's blog","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'C++ä»é›¶å¼€å§‹ï¼ˆå¼€æºï¼‰ï¼šä¸€æ–‡è¯»æ‡‚muduo',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-12 11:07:15'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="google-site-verification" content="uO6C17u7YuZfMWvThEQ9nOGQS4GIN2zAM6hC4tH-RiM" /><meta name="baidu-site-verification" content="code-nRnoDyQJPT" /><script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?13a4aefcbad9616a1f5859538d0d882e"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.min.css" media="defer" onload="this.media='all'"><script async src="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/carousel-touch.min.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/cat.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">31</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fa-fw fa-fw fas fa-comment-dots"></i><span> è¯´è¯´</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> ç›®å½•</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> aboutME</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">royhuang's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fa-fw fa-fw fas fa-comment-dots"></i><span> è¯´è¯´</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> ç›®å½•</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> aboutME</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">C++ä»é›¶å¼€å§‹ï¼ˆå¼€æºï¼‰ï¼šä¸€æ–‡è¯»æ‡‚muduo</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-03-11T05:48:01.602Z" title="å‘è¡¨äº 2023-03-11 13:48:01">2023-03-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-03-12T03:07:15.211Z" title="æ›´æ–°äº 2023-03-12 11:07:15">2023-03-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C++</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B/">ä»é›¶å¼€å§‹</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">14.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>51åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="C++ä»é›¶å¼€å§‹ï¼ˆå¼€æºï¼‰ï¼šä¸€æ–‡è¯»æ‡‚muduo"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="twikoo_visitors"></span></span></div></div></div><article class="post-content" id="article-container"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote>
<p>ğŸŒŸ<a href="https://hwh.zone/p/62712/">ã€ŠC++ä»é›¶å¼€å§‹ã€‹</a> ç³»åˆ—ï¼Œå·¥ä½œå¿«ä¸€å¹´ï¼Œç»ˆäºåˆå¼€å§‹æ›´æ–°äº†â€¦ğŸ¥—</p>
</blockquote>
<div class="tag link"><a class="link-card" title="C++ä»é›¶å¼€å§‹" href="https://hwh.zone/p/62712"><div class="left"><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/cat-modified.png"/></div><div class="right"><p class="text">C++ä»é›¶å¼€å§‹</p><p class="url">https://hwh.zone/p/62712</p></div></a></div>
<p>åœ¨å­¦æ ¡æ¥è§¦C++æ¯”è¾ƒå°‘ï¼Œä¸»è¦æ˜¯ç”¨Java ã€Pythonè¾ƒå¤šã€‚å…¥èŒè…¾è®¯å‰ï¼Œä¸ºäº†æ¶è¡¥ä¸‹C++ç½‘ç»œç›¸å…³åŸºç¡€ï¼Œè¯»äº†ä¸€äº›ç»å…¸çš„<u>demoçº§</u> å¼€æºåº“ï¼Œå¦‚ <a target="_blank" rel="noopener" href="https://github.com/EZLippi/Tinyhttpd">Tinyhttpd</a> ã€<a target="_blank" rel="noopener" href="https://github.com/zyearn/zaver">Zavar</a> ç­‰ã€‚å…¥èŒåå¤§å¤šæ•°æ—¶å€™åœ¨ä¸šåŠ¡å±å±±ä¸Šç©è€ï¼Œå†…éƒ¨ä¹Ÿæœ‰å°è£…å¥½çš„ç½‘ç»œæ¡†æ¶ï¼Œä½†ä¸€ç›´å¯¹ç½‘ç»œé€šä¿¡åº•å±‚æŒºæ„Ÿå…´è¶£ã€‚</p>
<p>ç–«æƒ…è¿‡åï¼Œæ‰€åœ¨çš„ä¸šåŠ¡æ”¶ç¼©ï¼ˆåƒä¸‡PCUâ€“&gt;ç™¾ä¸‡PCUï¼‰ï¼Œå¹¶å‘æ•°ä¸‹é™äº†ä¸€ä¸ªé‡çº§ã€‚ä¹Ÿç®—æœ‰äº†éš¾å¾—çš„æ—¶é—´ï¼Œæ¥é™ä¸‹æ¥å¿ƒæ¥è¯»ä¸€äº›<u>å·¥ä¸šçº§</u>åˆ«çš„å¼€æºåº“ã€‚ç»è¿‡è°ƒç ”ï¼Œé”å®šåœ¨<a target="_blank" rel="noopener" href="https://github.com/S1mpleBug/muduo_cpp11">muduo-cpp11</a> ã€<a href="">brpc</a> ä¸¤ä¸ªé¡¹ç›®ï¼Œå…ˆèŠ±äº†ä¸€å‘¨å…ˆè¯»å®Œäº†ç›¸å¯¹ç®€å•çš„muduoï¼Œå†™ç¯‡æ–‡ç« ç»™è‡ªå·±æ€»ç»“å›é¡¾ï¼Œä¹Ÿç»™åæ¥è€…ä¸€ä»½å…¨é¢æ¸…æ™°åœ°å‚è€ƒå§ã€‚</p>
<h1>ä¸€ã€Muduoæ•´ä½“æ¶æ„</h1>
<blockquote>
<p>æ³¨æ„ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/chenshuo/muduo">muduo</a> æºç *@chenshuo<em>åŸºäºboostï¼Œæœ¬æ–‡ä»£ç å¼•ç”¨</em>@S1mpleBug*åŸºäºC++11æ”¹å†™çš„<a target="_blank" rel="noopener" href="https://github.com/S1mpleBug/muduo_cpp11">muduo-cpp11</a>ã€‚</p>
</blockquote>
<h2 id="1-1-ä»EchoServerè¯´èµ·">1.1 ä»EchoServerè¯´èµ·</h2>
<h3 id="1-1-1-å¿«é€Ÿå¼€å§‹">1.1.1 å¿«é€Ÿå¼€å§‹</h3>
<p>ä¸‹å¥½æºç åï¼Œæˆ‘ä»¬ç¼–è¯‘ä¸€ä¸‹é¡¹ç›®ä¸­EchoServerç¤ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/S1mpleBug/muduo_cpp11</span><br><span class="line">cd muduo_cpp11/example/ &amp; make</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªç®€å•â€œå¤è¯»æœºâ€æœåŠ¡å™¨ä¾¿è¯ç”Ÿäº†ï¼š</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230227171908955.png" alt="image-20230227171908955"></p>
<h3 id="1-1-2-â€œå¤è¯»æœºâ€œæœåŠ¡å™¨ä¸šåŠ¡å±‚å®ç°">1.1.2 â€œå¤è¯»æœºâ€œæœåŠ¡å™¨ä¸šåŠ¡å±‚å®ç°</h3>
<p>muduoçš„æ¥å£ä½¿ç”¨ç›¸å½“æ–¹ä¾¿å’Œç²¾ç®€ï¼š</p>
<ol>
<li>
<p><strong>é¦–å…ˆå®šä¹‰ä¸€ä¸ªEchoServerç±»</strong></p>
<p>è¯¥ç±»ä¸»è¦æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>å°è£…äº†TcpServerç±»å¯¹è±¡<code>server_</code>ï¼Œåœ¨muduoä¸­ï¼ŒTcpServeræ˜¯æ•´ä¸ªæ¡†æ¶é€»è¾‘å±‚é¢çš„å…¥å£ï¼›</li>
<li>ç”¨æˆ·æ³¨å†Œè‡ªå®šä¹‰çš„äº‹ä»¶ï¼ˆæ–°å®¢æˆ·ç«¯è¿æ¥ã€å®¢æˆ·ç«¯æ¶ˆæ¯å“åº”ï¼‰å›è°ƒå‡½æ•°ï¼Œä¹Ÿå³æ˜¯ä¸šåŠ¡å±‚é¢é€»è¾‘å¤„ç†ã€‚</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mymuduo/TcpServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mymuduo/Logger.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoServer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">EchoServer</span>(EventLoop *loop, <span class="keyword">const</span> InetAddress &amp;addr, <span class="keyword">const</span> std::string &amp;name)</span><br><span class="line">        : <span class="built_in">server_</span>(loop, addr, name) <span class="comment">// TcpServer server_; TcpServerå¯¹è±¡åˆå§‹åŒ–</span></span><br><span class="line">        , <span class="built_in">loop_</span>(loop)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// æ³¨å†Œå›è°ƒå‡½æ•°</span></span><br><span class="line">        server_.<span class="built_in">setConnectionCallback</span>( <span class="comment">// onConnectionï¼Œæ‰“å°ä¸‹è¿æ¥çš„å®¢æˆ·ç«¯ip+port</span></span><br><span class="line">            std::<span class="built_in">bind</span>(&amp;EchoServer::onConnection, <span class="keyword">this</span>, std::placeholders::_1));</span><br><span class="line">        </span><br><span class="line">        server_.<span class="built_in">setMessageCallback</span>( <span class="comment">// onMessageï¼šå°†å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯åŸæ ·è¿”å›send</span></span><br><span class="line">            std::<span class="built_in">bind</span>(&amp;EchoServer::onMessage, </span><br><span class="line">                        <span class="keyword">this</span>, </span><br><span class="line">                        std::placeholders::_1,</span><br><span class="line">                        std::placeholders::_2,</span><br><span class="line">                        std::placeholders::_3));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®åˆé€‚çš„subloopçº¿ç¨‹æ•°é‡</span></span><br><span class="line">        server_.<span class="built_in">setThreadNum</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        server_.<span class="built_in">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// è¿æ¥å»ºç«‹æˆ–æ–­å¼€çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onConnection</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr &amp;conn)</span>   </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (conn-&gt;<span class="built_in">connected</span>())</span><br><span class="line">            <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Connection UP : %s&quot;</span>, conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>().<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Connection DOWN : %s&quot;</span>, conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯è¯»å†™äº‹ä»¶å›è°ƒ</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="keyword">const</span> TcpConnectionPtr &amp;conn, Buffer *buf, Timestamp time)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::string msg = buf-&gt;<span class="built_in">retrieveAllAsString</span>();</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(<span class="string">&quot;muduo: &quot;</span> + msg);</span><br><span class="line">        <span class="comment">// conn-&gt;shutdown();   // å…³é—­å†™ç«¯ åº•å±‚å“åº”EPOLLHUP =&gt; æ‰§è¡ŒcloseCallback_</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EventLoop *loop_;</span><br><span class="line">    TcpServer server_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>å¯åŠ¨æœåŠ¡å™¨</strong></p>
<p>EchoServerå¯¹è±¡start()ï¼Œmain loopå¼€å¯äº‹ä»¶å¾ªç¯loop()ã€‚æ•´ä¸ªæœåŠ¡å™¨ä¾¿é¡ºåˆ©å¯åŠ¨äº†ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1.ç”¨æˆ·è‡ªå®šä¹‰çš„loopä½œä¸ºmain loop</span></span><br><span class="line">    EventLoop loop;</span><br><span class="line">    <span class="comment">// 2. å¯¹socketç¼–ç¨‹ä¸­çš„sockaddr_inè¿›è¡Œå°è£…</span></span><br><span class="line">    <span class="function">InetAddress <span class="title">addr</span><span class="params">(<span class="number">8002</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 3.EchoServeråˆå§‹åŒ–</span></span><br><span class="line">    <span class="function">EchoServer <span class="title">server</span><span class="params">(&amp;loop, addr, <span class="string">&quot;EchoServer&quot;</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 4.å¯åŠ¨æœåŠ¡å™¨server</span></span><br><span class="line">    server.<span class="built_in">start</span>();</span><br><span class="line">    <span class="comment">// 5.å¼€å¯main loopäº‹ä»¶å¾ªç¯ï¼šepoll_waitç­‰å¾…listenfdçš„accpetè¿æ¥äº‹ä»¶</span></span><br><span class="line">    loop.<span class="built_in">loop</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>å³ä½¿ä½ ç›®å‰å¯¹ä¸Šè¿°å‡ºç°<code>loop</code> ã€<code>äº‹ä»¶å¾ªç¯</code> ç­‰æ¦‚å¿µè¿˜ä¸€æ— æ‰€çŸ¥ã€‚ä½†è¶³å¤Ÿç®€æ´çš„APIæ¥å£ï¼Œåšä¸šåŠ¡å±‚çš„å¼€å‘ï¼Œå´å·²ç»å¯ä»¥å®ç°ä¸€ä¸ªè‡ªå·±çš„é«˜æ€§èƒ½â€œå¤è¯»æœºâ€æœåŠ¡å™¨äº†ï¼</p>
<h2 id="1-2-æ•´ä½“æ¶æ„ï¼šMulti-Reactor">1.2 æ•´ä½“æ¶æ„ï¼šMulti-Reactor</h2>
<h3 id="1-2-1-é«˜å¹¶å‘ä¹‹ç½‘ç»œIOæ¨¡å‹">1.2.1 é«˜å¹¶å‘ä¹‹ç½‘ç»œIOæ¨¡å‹</h3>
<p>é«˜å¹¶å‘å³æˆ‘ä»¬æ‰€è¯´çš„ C10Kï¼ˆä¸€ä¸ª server æœåŠ¡ 1w ä¸ª clientï¼‰, C10Mï¼ˆä¸€ä¸ª server æœåŠ¡ 1M ä¸ª clientï¼‰ ã€‚è¿™èŠ‚å°†ä¸»è¦å¾ªåºæ¸è¿‘åœ°ï¼Œä»‹ç»å¦‚ä½•è®¾è®¡å‡ºä¸€ä¸ªé«˜å¹¶å‘ç½‘ç»œ IO æ¡†æ¶ï¼š</p>
<ul>
<li>ä¼ ç»Ÿç½‘ç»œ IO æ¨¡å‹çš„ç¼ºé™·</li>
<li>é’ˆå¯¹ä¼ ç»Ÿç½‘ç»œ IO æ¨¡å‹ç¼ºé™·çš„æ”¹è¿›ï¼šå¤šçº¿ç¨‹/å¤šè¿›ç¨‹</li>
<li>IO å¤šè·¯å¤ç”¨</li>
<li>Reactoræ¨¡å‹</li>
</ul>
<h4 id="ä¼ ç»Ÿç½‘ç»œ-IO-æ¨¡å‹çš„ç¼ºé™·">ä¼ ç»Ÿç½‘ç»œ IO æ¨¡å‹çš„ç¼ºé™·</h4>
<p>åœ¨è¯¥å°èŠ‚æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ol>
<li><strong>ä¼ ç»Ÿç½‘ç»œ IO æ¨¡å‹æœ‰å“ªäº›ç¼ºé™·</strong>ï¼Ÿ</li>
<li><strong>ä¼ ç»Ÿç½‘ç»œ IO æ¨¡å‹é˜»å¡ç‚¹æœ‰å“ªäº›</strong>ï¼Ÿ</li>
</ol>
<p>å…ˆæ¥çœ‹ä¸‹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åŸºäºTCPçš„é€šä¿¡æµç¨‹ï¼š</p>
<ol>
<li><strong>æœåŠ¡ç«¯</strong>ï¼šserver åˆ›å»ºç›‘å¬ socket åï¼Œæ‰§è¡Œ bind() ç»‘å®š IP å’Œç«¯å£ï¼Œç„¶åè°ƒç”¨ listen() ç›‘å¬ï¼Œä»£è¡¨ server å·²ç»å‡†å¤‡å¥½æ¥æ”¶è¯·æ±‚äº†ï¼Œlisten çš„ä¸»è¦ä½œç”¨å…¶å®æ˜¯åˆå§‹åŒ–åŠè¿æ¥å’Œå…¨è¿æ¥é˜Ÿåˆ—å¤§å°</li>
<li><strong>å®¢æˆ·ç«¯</strong>ï¼šserver å‡†å¤‡å¥½åï¼Œclient ä¹Ÿåˆ›å»º socket ï¼Œç„¶åæ‰§è¡Œ connect å‘ server å‘èµ·è¿æ¥è¯·æ±‚ï¼Œ<strong>è¿™ä¸€æ­¥ä¼šè¢«é˜»å¡</strong>ï¼Œéœ€è¦ç­‰å¾…ä¸‰æ¬¡æ¡æ‰‹å®Œæˆï¼š
<ul>
<li>ç¬¬ä¸€æ¬¡æ¡æ‰‹å®Œæˆï¼ŒæœåŠ¡ç«¯ä¼šåˆ›å»º socketï¼ˆè¿™ä¸ª socket æ˜¯è¿æ¥ socketï¼Œæ³¨æ„ä¸è¦å’Œç¬¬ä¸€æ­¥çš„ç›‘å¬ socket ææ··äº†ï¼‰,å°†å…¶æ”¾å…¥åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼›</li>
<li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹å®Œæˆï¼Œç³»ç»Ÿä¼šæŠŠ socket ä»åŠè¿æ¥é˜Ÿåˆ—æ‘˜ä¸‹æ”¾å…¥å…¨è¿æ¥é˜Ÿåˆ—ä¸­ï¼Œç„¶å accept ä¼šå°†å…¶ä»å…¨è¿æ¥é˜Ÿåˆ—ä¸­æ‘˜ä¸‹ï¼Œä¹‹åæ­¤ socket å°±å¯ä»¥ä¸å®¢æˆ·ç«¯ socket æ­£å¸¸é€šä¿¡äº†ï¼Œé»˜è®¤æƒ…å†µä¸‹å¦‚æœå…¨è¿æ¥é˜Ÿåˆ—é‡Œæ²¡æœ‰ socketï¼Œåˆ™ accept ä¼š<strong>é˜»å¡ç­‰å¾…</strong>ä¸‰æ¬¡æ¡æ‰‹å®Œæˆã€‚</li>
</ul>
</li>
<li>æ­¤åè¿›è¡Œread/writeï¼Œä½†è¿™ä¸ªä¹Ÿå¾ˆå¯èƒ½ä¼šè¢«<strong>é˜»å¡</strong>ã€‚</li>
</ol>
<table>
<thead>
<tr>
<th>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯TCPé€šä¿¡æµç¨‹</th>
<th>ä¼ªä»£ç </th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/90dbe13651eaa48fb760dd13f9d6c1ad.png" alt="img"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230309160413142.png" alt="image-20230309160413142"></td>
</tr>
</tbody>
</table>
<p>å¼€å¤´çš„é—®é¢˜ä¹Ÿå°±å¾ˆå¥½å›ç­”äº†ï¼š</p>
<ul>
<li><strong>é˜»å¡ç‚¹</strong>ï¼šä¼ ç»Ÿçš„socketé€šä¿¡ä¼šé˜»å¡åœ¨connectï¼Œacceptï¼Œread/write è¿™å‡ ä¸ªæ“ä½œä¸Šã€‚</li>
<li><strong>ç¼ºé™·ç‚¹</strong>ï¼šæ€§èƒ½ä½ä¸‹ï¼Œå¦‚å•è¿›ç¨‹/çº¿ç¨‹ï¼Œåªè¦ server é˜»å¡ï¼Œå°±ä¸èƒ½å†æ¥æ”¶å…¶ä»– client çš„å¤„ç†äº†ã€‚</li>
</ul>
<h4 id="é’ˆå¯¹ä¼ ç»Ÿç½‘ç»œ-IO-æ¨¡å‹ç¼ºé™·çš„æ”¹è¿›">é’ˆå¯¹ä¼ ç»Ÿç½‘ç»œ IO æ¨¡å‹ç¼ºé™·çš„æ”¹è¿›</h4>
<p>é’ˆå¯¹ä¸Šé¢çš„é˜»å¡ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åšå¦‚ä¸‹è¿›è¡Œæ”¹è¿›ã€‚</p>
<h5 id="å¤šè¿›ç¨‹-çº¿ç¨‹ï¼šé¿å…read-writeé˜»å¡">å¤šè¿›ç¨‹/çº¿ç¨‹ï¼šé¿å…read/writeé˜»å¡</h5>
<p>å¦‚æœ server æ˜¯å•è¿›ç¨‹/çº¿ç¨‹ï¼Œread/writeé˜»å¡ä¼šå¯¼è‡´ serveræ— æ³•å†å¤„ç†å…¶ä»–clientè¯·æ±‚äº†ï¼Œé‚£å¦‚æœæŠŠread/writeäº¤ç»™å­è¿›ç¨‹/çº¿ç¨‹å¤„ç†ï¼Ÿè¿™æ ·ä¸€å®šç¨‹åº¦ä¸Šå¯æé«˜æœåŠ¡å™¨å¹¶å‘ã€‚</p>
<blockquote>
<p>ä¸€èˆ¬æ˜¯ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œå› ä¸º<u>å¤šè¿›ç¨‹</u>ç›¸å¯¹<u>å¤šè¿›ç¨‹</u>è´Ÿæ‹…æ›´å¤§ï¼š</p>
<ol>
<li>
<p>è¦è€ƒè™‘â€œ<u>å­è¿›ç¨‹å–„å</u>â€ï¼š</p>
<ul>
<li>
<p>å½“ã€Œå­è¿›ç¨‹ã€é€€å‡ºæ—¶ï¼Œå®é™…ä¸Šå†…æ ¸é‡Œè¿˜ä¼šä¿ç•™è¯¥è¿›ç¨‹çš„ä¸€äº›ä¿¡æ¯ï¼Œä¹Ÿæ˜¯ä¼šå ç”¨å†…å­˜çš„ï¼Œå¦‚æœä¸åšå¥½â€œå›æ”¶â€å·¥ä½œï¼Œå°±ä¼šå˜æˆ<strong>åƒµå°¸è¿›ç¨‹</strong>ï¼Œæ…¢æ…¢è€—å°½æˆ‘ä»¬çš„ç³»ç»Ÿèµ„æºï¼›</p>
</li>
<li>
<p>å› æ­¤ï¼Œçˆ¶è¿›ç¨‹è¦åœ¨å­è¿›ç¨‹é€€å‡ºåå›æ”¶èµ„æºï¼Œåˆ†åˆ«æ˜¯è°ƒç”¨ <code>wait()</code> å’Œ <code>waitpid()</code> å‡½æ•°ã€‚</p>
</li>
</ul>
</li>
<li>
<p>è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸ä»…åŒ…å«äº†è™šæ‹Ÿå†…å­˜ã€æ ˆã€å…¨å±€å˜é‡ç­‰ç”¨æˆ·ç©ºé—´çš„èµ„æºï¼Œè¿˜åŒ…æ‹¬äº†å†…æ ¸å †æ ˆã€å¯„å­˜å™¨ç­‰å†…æ ¸ç©ºé—´çš„èµ„æºï¼›</p>
</li>
<li>
<p>è¿›ç¨‹åˆ›å»º/å¼€é”€å¤§ã€‚</p>
</li>
</ol>
</blockquote>
<ul>
<li><strong>çˆ¶è¿›ç¨‹/çº¿ç¨‹è´Ÿè´£ accept(listenfd)ç­‰å¾…å®¢æˆ·ç«¯æ–°è¿æ¥</strong>ï¼Œ æœ‰æ–°è¿æ¥forkä¸€ä¸ªå­è¿›ç¨‹/åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼ŒæŠŠè¿™ä¸ª connfd äº¤ç»™å­è¿›ç¨‹/çº¿ç¨‹å¤„ç†ï¼›</li>
<li><strong>å­è¿›ç¨‹/çº¿ç¨‹è´Ÿè´£read(connfd)/write(connfd)ç­‰å¾…connfdè¯»å†™</strong>ï¼Œè¿™æ ·å°±ç®—<u>å­è¿›ç¨‹/çº¿ç¨‹read/writeé˜»å¡äº†ï¼Œä¹Ÿä¸å½±å“çˆ¶è¿›ç¨‹/çº¿ç¨‹ç»§ç»­ç›‘å¬å’Œå…¶ä»–å­è¿›ç¨‹/çº¿ç¨‹å¤„ç†è¿æ¥</u>ã€‚</li>
</ul>
<p>ä¸‹å›¾æ˜¯ä»¥å¤šè¿›ç¨‹ä¸ºä¾‹ã€‚</p>
<table>
<thead>
<tr>
<th>å¤šè¿›ç¨‹IO</th>
<th>ä¼ªä»£ç </th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/d837739b1ef65399bbd4fdfb53aff34f.png" alt="img"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230310111604769.png" alt="image-20230310111604769"></td>
</tr>
</tbody>
</table>
<p><strong>æœ‰å…³çº¿ç¨‹æ± </strong></p>
<p>ä¸è¿‡æ— è®ºæ˜¯å¤šè¿›ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹ï¼Œåˆ›å»ºã€é”€æ¯çš„å¼€é”€å…¶å®å¹¶ä¸å°ã€‚å› æ­¤æˆ‘ä»¬è¿˜ä¼šå¾€å¾€ç”¨<u>è¿›ç¨‹æ± </u>or<u>çº¿ç¨‹æ± </u>è¿›è¡Œç®¡ç†ã€‚</p>
<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯å…¨å±€çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæ“ä½œï¼Œä¸ºäº†é¿å…å¤šçº¿ç¨‹ç«äº‰ï¼Œçº¿ç¨‹åœ¨æ“ä½œè¿™ä¸ªé˜Ÿåˆ—å‰è¦åŠ é”ã€‚</p>
</blockquote>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/%E7%BA%BF%E7%A8%8B%E6%B1%A0.png" alt="img"></p>
<p><strong>æ€§èƒ½è¿˜èƒ½å†æé«˜å—ï¼Ÿ</strong></p>
<p>å‡è®¾ä¸€ä¸‡ä¸ªè¿æ¥ï¼Œå°±è¦å¼€ä¸€ä¸‡ä¸ªçº¿ç¨‹ï¼Œè¿™é‡Œé¢èµ„æºæ¶ˆè€—ä¾¿éš¾ä»¥æ¥å—äº†ã€‚çœ‹èµ·æ¥é‡ŒC10Kéƒ½å·®å¾—è¿œã€‚</p>
<p>å†å›å¤´çœ‹çœ‹å‰é¢çš„é˜»å¡ç‚¹ï¼š</p>
<ul>
<li>
<p><strong>å¯¹äºconnectï¼Œaccepté˜»å¡</strong>ï¼Œå®¢æˆ·ç«¯å‘ç”Ÿè¿æ¥æ—¶ï¼Œ<strong>ä¸»è¿›ç¨‹ä¾æ—§ä¼šé˜»å¡ï¼Œç­‰å¾…æ¡æ‰‹å®Œæˆï¼ŒæœŸé—´æ— æ³•å¤„ç†å…¶å®ƒè¿æ¥</strong>ï¼›</p>
</li>
<li>
<p><strong>å¯¹äºread/writeå‘ç”Ÿé˜»å¡ï¼Œç­‰å¾…æ•°æ®å°±ç»ªï¼Œä»ç£ç›˜/ç½‘å¡==&gt;å†…æ ¸æ¢æˆåŒº</strong>ï¼Œæˆ‘ä»¬é‡‡ç”¨å¤šè¿›ç¨‹/çº¿ç¨‹ï¼Œé¿å…äº†ä¸»çº¿ç¨‹read/writeé˜»å¡ï¼Œä»è€Œå¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥ï¼Œ<strong>ä½†å­çº¿ç¨‹read/writeä¾æ—§é˜»å¡</strong>ã€‚</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/79ec7119fc5ed790a4a3ea3472094821.png" alt="img"></p>
</li>
</ul>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ¬è´¨è¦å¤„ç†çš„å°±ä¸¤ç±»äº‹ä»¶ï¼š</p>
<ol>
<li>
<p>çˆ¶è¿›ç¨‹/çº¿ç¨‹è´Ÿè´£accept(listenfd)ç­‰å¾…<u>æ–°è¿æ¥äº‹ä»¶</u>ï¼Œå³ç­‰å¾…å®¢æˆ·ç«¯ä¸‰æ¬¡æ¡æ‰‹å®Œæˆ ï¼›</p>
</li>
<li>
<p>å­è¿›ç¨‹/çº¿ç¨‹è´Ÿè´£read(connfd)/write(connfd)ç­‰å¾…connfd<u>è¯»å†™äº‹ä»¶</u>ï¼Œå³ç­‰å¾…connfdå¯è¯»ã€å¯å†™ã€‚</p>
<blockquote>
<p>è‡³äºåé¢å¯¹äºæ¯ä¸ªè¯»ã€å†™äº‹ä»¶æ˜¯ä¸æ˜¯ï¼Œç”¨çº¿ç¨‹æ± /ä¸“é—¨å¼€çº¿ç¨‹å»å¤„ç†ã€‚è¿™é‡Œå…ˆä¸è®¨è®ºï¼Œè¿™æ˜¯å…·ä½“ioå¤„ç†é€»è¾‘ï¼Œä¸æ˜¯ç°åœ¨è¦è®¨è®ºçš„ioè¯»å†™äº‹ä»¶ã€‚</p>
</blockquote>
</li>
</ol>
<p>é‚£èƒ½ä¸èƒ½æœ‰è¿™ä¹ˆä¸€ç§<strong>äº‹ä»¶é€šçŸ¥æœºåˆ¶</strong>ï¼š<strong>åœ¨ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹å°±å¯ä»¥ç®¡ç†listenfdå’Œå¤šä¸ªconnfd&amp;å¤„ç†ä¸Šè¿°ä¸¤ç§äº‹ä»¶ï¼Œåªæœ‰äº‹ä»¶å°±ç»ªæ‰é€šçŸ¥ï¼Œä»è€Œâ‘ é¿å…connect/acceptï¼ˆä¸‰æ¬¡æ¡æ‰‹æˆåŠŸå†é€šçŸ¥ï¼‰ï¼Œread/writeé˜»å¡ï¼ˆå¯è¯»ã€å¯å†™å†é€šçŸ¥ï¼‰ï¼›â‘¡ é¿å…ä¸€ä¸ªè¿æ¥å°±è¦å¼€ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹å»ç›‘å¬IOè¯»å†™äº‹ä»¶</strong>ã€‚</p>
<p>I/Oå¤šè·¯å¤ç”¨å°±æ˜¯è¿™ä¹ˆä¸€ç§æœºåˆ¶ï¼Œ<strong>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç›‘è§†å¤šä¸ªæè¿°ç¬¦fd</strong>ï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆä¸€èˆ¬æ˜¯è¯»å°±ç»ªæˆ–è€…å†™å°±ç»ªï¼‰ï¼Œèƒ½å¤Ÿé€šçŸ¥ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œã€‚</p>
<h4 id="IOå¤šè·¯å¤ç”¨ï¼šselect-poll-epoll">IOå¤šè·¯å¤ç”¨ï¼šselect/poll/epoll</h4>
<p>ç›®å‰æ”¯æŒI/Oå¤šè·¯å¤ç”¨çš„ç³»ç»Ÿè°ƒç”¨æœ‰<code>selectï¼Œpselectï¼Œpollï¼Œepollã€‚</code>ä¸å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹æŠ€æœ¯ç›¸æ¯”ï¼Œ<strong>I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯çš„æœ€å¤§ä¼˜åŠ¿æ˜¯å¯ä»¥ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹å°±å¯ä»¥ç›‘å¬å¤šä¸ªå®¢æˆ·ç«¯fdï¼Œè€Œä¸å¿…æ¯ä¸ªfdç›‘å¬éƒ½è¦ä¸“é—¨å¼€ä¸ªè¿›ç¨‹/çº¿ç¨‹å»ç›‘å¬IOè¯»å†™äº‹ä»¶</strong> ã€‚</p>
<p>åœ¨ä»¥å‰çš„<a href="https://hwh.zone/p/15646/">ä¸ªäººåšå®¢</a>ï¼Œè¯¦ç»†åˆ†æè¿‡ï¼Œè¿™é‡Œä¸è¯¦ç»†æè¿°ã€‚ä»…ç®€å•æ”¾ä¸‹select/poll/epollä¼ªä»£ç æ¯”å¯¹ï¼š</p>
<ul>
<li><code>select</code>ï¼š â‘ æ¯æ¬¡ä¸€ä¸ªfdå¯è¯»éœ€éå†æ‰€æœ‰ï¼›â‘¢æè¿°ç¬¦æœ‰ä¸Šé™ ï¼›â‘¢ å¤§é‡æè¿°ç¬¦æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åœ°å€ç©ºé—´ï¼›â‘£ ï¼›</li>
<li><code>poll</code> ï¼šâ‘ æ¯æ¬¡ä¸€ä¸ªfdå¯è¯»éœ€éå†æ‰€æœ‰ï¼›â‘¡ æè¿°ç¬¦æ— ä¸Šé™  ï¼›â‘¢å¤§é‡æè¿°ç¬¦æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åœ°å€ç©ºé—´ï¼›</li>
<li><code>epoll</code>ï¼šâ‘ åªéœ€éå†<u>å°±ç»ª</u>çš„fdï¼› â‘¡æè¿°ç¬¦æ— ä¸Šé™ï¼› â‘¢æœ‰mmapæ˜ å°„é«˜æ•ˆç¼“å†²åŒºï¼Œæ²¡æœ‰å¤§é‡æè¿°ç¬¦ä»ç”¨æˆ·æ€å’Œå†…æ ¸æ€ç›´æ¥çš„å¤åˆ¶ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>select</th>
<th>poll</th>
<th>epoll</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230308175037297.png" alt="image-20230308175037297"></td>
<td><img src="https:/blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230308175104079.png" alt="image-20230308175104079"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230308175637979.png" alt="image-20230308175637979"></td>
</tr>
</tbody>
</table>
<h4 id="Reactoræ¨¡å¼ï¼šç»§ç»­ä¼˜åŒ–å¤šè·¯IO">Reactoræ¨¡å¼ï¼šç»§ç»­ä¼˜åŒ–å¤šè·¯IO</h4>
<p><strong>æˆ‘ä»¬å·²ç»çŸ¥é“ IO å¤šè·¯ç¨‹å¤ç”¨æ˜¯ç”¨ä¸€ä¸ªè¿›ç¨‹æ¥ç®¡ç†å¤šä¸ª socket çš„ï¼Œ é‚£ä¹ˆæ˜¯å¦è¿˜æœ‰ä¼˜åŒ–çš„ç©ºé—´å‘¢</strong>ï¼Ÿ</p>
<p>ä»¥æœ€ç®€å•çš„selectä¸ºä¾‹ï¼š</p>
<ol>
<li>è°ƒç”¨ select æ¥ç›‘å¬è¿æ¥ï¼Œè¯»å†™äº‹ä»¶ï¼›</li>
<li>æ”¶åˆ°äº‹ä»¶ååˆ¤æ–­æ˜¯å¦æ˜¯ç›‘å¬ listenfd ä¸Šçš„è¿æ¥äº‹ä»¶ï¼šæ˜¯çš„è¯è°ƒç”¨ accept() ï¼›</li>
<li>å¦åˆ™åˆ¤æ–­æ˜¯å¦æ˜¯å·²è¿æ¥ connfd ä¸Šçš„è¯»å†™äº‹ä»¶ï¼Œæ˜¯çš„è¯è°ƒç”¨ read()/write() ã€‚</li>
</ol>
<table>
<thead>
<tr>
<th>selectæµç¨‹å›¾</th>
<th>selectä¼ªä»£ç </th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/c4d09a898fc645b18150aafc591ad2c6.png" alt="img"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230308175037297.png" alt="image-20230308175037297"></td>
</tr>
</tbody>
</table>
<p>ä¸Šé¢çš„å†™æ³•æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯é€»è¾‘è¿‡äºè€¦åˆï¼Œå¦‚æœï¼š</p>
<ol>
<li>selectå•ç‹¬ä¸€ä¸ªå­é€»è¾‘ï¼Œè´Ÿè´£ç›‘å¬ã€‚</li>
<li>listenfdä¸Šçš„è¿æ¥äº‹ä»¶ï¼Œå•ç‹¬æ‹†åˆ†ä¸€ä¸ªå­é€»è¾‘ï¼›</li>
<li>connfd ä¸Šçš„è¯»å†™äº‹ä»¶ï¼Œå•ç‹¬æ‹†åˆ†ä¸€ä¸ªå­é€»è¾‘ã€‚</li>
</ol>
<p>è¿™æ ·ä¼šä¸ä¼šæ›´å¥½ï¼Ÿ</p>
<h5 id="å•è¿›ç¨‹-çº¿ç¨‹-å•Reactoræ¨¡å¼">å•è¿›ç¨‹/çº¿ç¨‹&amp;å•Reactoræ¨¡å¼</h5>
<p>ä¸ºäº†æé«˜æ‰©å±•æ€§&amp;é¿å…è€¦åˆæ€§ï¼Œæˆ‘ä»¬å°†IOå¤šè·¯å¤ç”¨æ¨¡å‹å†æ‹†åˆ†ä¸ºä¸‰ä¸ªæ¨¡å—ï¼š</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/805350f4232fb586d4d0257c5d215c9c.png" alt="img"></p>
<ol>
<li><strong>Reactor</strong>ï¼Œ å¯¹è±¡é¦–å…ˆè°ƒç”¨ select æ¥<u>ç›‘å¬</u> listenfd/connfdäº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åä¼šé€šè¿‡ dispatch åˆ†å‘ï¼›</li>
<li><strong>Acceptor</strong>ï¼Œå¦‚æœæ˜¯è¿æ¥å»ºç«‹äº‹ä»¶ï¼Œåˆ™ç”± Acceptor å¤„ç†ï¼ŒAcceptor é€šè¿‡è°ƒç”¨ <u>accept æ¥æ”¶è¿æ¥</u>ï¼Œå¹¶ä¸”ä¼š<u>åˆ›å»ºä¸€ä¸ª Handler</u> æ¥å¤„ç†åç»­çš„è¯»å†™ç­‰äº‹ä»¶ï¼›</li>
<li><strong>Handler</strong>ï¼Œå¦‚æœä¸æ˜¯è¿æ¥å»ºç«‹äº‹ä»¶ï¼Œåˆ™ Reactor ä¼šè°ƒç”¨è¿æ¥å¯¹åº”çš„ Handler è¿›è¡Œå“åº”ï¼Œhandler ä¼š<u>å®Œæˆ read/ä¸šåŠ¡å¤„ç†/write çš„å®Œæ•´ä¸šåŠ¡å¤„ç†æµç¨‹</u>ã€‚</li>
</ol>
<p>ä»¥ä¸Šè¿™äº›æ“ä½œå…¶å®å’Œä¹‹å‰çš„ IO å¤šè·¯å¤ç”¨ä¸€æ ·ï¼Œæ‰€æœ‰çš„æ“ä½œè¿˜æ˜¯åœ¨<strong>ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹</strong>è¿›è¡Œï¼Œåªä¸è¿‡è¿›è¡Œæ›´ç»†åˆ†æ‹†è§£ã€‚</p>
<p><strong>ä½†æ˜¯å¦‚æœä¸šåŠ¡å¤„ç†è€—æ—¶è¾ƒé•¿ï¼Œé‚£ä¹ˆè¿›ç¨‹/çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼›å¦ä¸€æ–¹é¢ï¼Œå•è¿›ç¨‹/çº¿ç¨‹ä¹Ÿæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿</strong>ã€‚</p>
<p>é‚£ä¹ˆæ”¹æˆå¤šè¿›ç¨‹/çº¿ç¨‹ï¼Œä¼šä¸ä¼šæ›´å¥½ï¼Ÿ</p>
<h5 id="å¤šè¿›ç¨‹-çº¿ç¨‹-å•Reactoræ¨¡å¼">å¤šè¿›ç¨‹/çº¿ç¨‹&amp;å•Reactoræ¨¡å¼</h5>
<p>äºæ˜¯äººä»¬åˆæå‡ºäº† å• Reactor å¤šçº¿ç¨‹æ¨¡å‹ï¼š</p>
<ul>
<li>ä¸»è¿›ç¨‹ä¾æ—§è´Ÿè´£å¤„ç†ï¼šReactorï¼ˆç›‘å¬ listenfd/connfdï¼‰ã€Accpetorï¼ˆaccpetè¿æ¥&amp;åˆ›å»ºHandleå¤„ç†ï¼‰ã€Handleï¼ˆå¤„ç†read/writeï¼Œä¸šåŠ¡é€»è¾‘ä¸å†å¤„ç†ï¼‰ï¼›</li>
<li>æ¯ä¸ªHandlerçš„ä¸šåŠ¡å¤„ç†ï¼Œæ”¹ä¸ºåˆ†é…ä¸€ä¸ªçº¿ç¨‹å¤„ç†ã€‚</li>
</ul>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/dde30dc52e79109ee75cc30967e4bd41.png" alt="img"></p>
<blockquote>
<p>äº‹å®ä¸Šï¼Œzaverå°±æ˜¯è¿™ä¹ˆåšçš„ï¼Œå‚è€ƒä¹‹å‰ç”»çš„æµç¨‹å›¾ï¼š</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/http-main.png" alt="http-main"></p>
</blockquote>
<p>ä½†ä¾ç„¶æœ‰å¦‚ä¸‹ä¸¤ä¸ªç“¶é¢ˆç‚¹ï¼š</p>
<ol>
<li>
<p><strong>å­çº¿ç¨‹å¤„ç†å¥½ä¸šåŠ¡æ•°æ®åéœ€è¦å°†å…¶ä¼ å› handlerè¿›è¡Œå‘é€å¤„ç†</strong>ï¼Œè¿™æ¶‰åŠåˆ°å…±äº«æ•°æ®çš„äº’æ–¥å’Œä¿æŠ¤æœºåˆ¶ï¼›</p>
<p>Handlerèƒ½ä¸èƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹å…¨éƒ¨å¤„ç†read/ä¸šåŠ¡é€»è¾‘/writeï¼Œé¿å…è·¨è¿›ç¨‹/çº¿ç¨‹é€šä¿¡ï¼Ÿ</p>
</li>
<li>
<p><strong>ä¸»è¿›ç¨‹å•ä¸ªReactorè´Ÿè´£ç›‘å¬æ‰€æœ‰fdï¼ˆlistenfd &amp; clientfdï¼‰ioäº‹ä»¶</strong>ï¼Œåœ¨å®¢æˆ·ç«¯ç¬æ—¶å¤§å¹¶å‘ï¼Œä¼šå‡ºç°æ€§èƒ½ç“¶é¢ˆã€‚</p>
<p><strong>å…¶å®ƒReatoråˆ†æ‹…ä¸€äº›äº‹ä»¶ç›‘å¬ï¼Œå¦‚ioäº‹ä»¶ï¼Œé‚£è¯¥å¤šå¥½</strong>ï¼Ÿè¿™ä¹Ÿæ˜¯ä¸»è¦ç“¶é¢ˆæ‰€åœ¨ã€‚</p>
</li>
</ol>
<h5 id="å¤šè¿›ç¨‹-çº¿ç¨‹-å¤šReactoræ¨¡å¼">å¤šè¿›ç¨‹/çº¿ç¨‹&amp;å¤šReactoræ¨¡å¼</h5>
<p>åŸºäºä»¥ä¸Šé€»è¾‘è€ƒè™‘ï¼Œå¤šè¿›ç¨‹/çº¿ç¨‹&amp;å¤šReactoræ¨¡å¼è¯ç”Ÿäº†ï¼š</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/a31ef38616720ac9c5d7e0719ee57714.png" alt="img"></p>
<p>å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<ol>
<li><strong>ä¸»è¿›ç¨‹è´Ÿè´£å¤„ç†ï¼šMian-Reactorï¼ˆåªç›‘å¬listenfdï¼‰ã€Accpetorï¼ˆaccpetè¿æ¥&amp;åˆ›å»ºHandleå¤„ç†ï¼‰</strong>ï¼Œæ¥æ”¶connfdåä¼šå°†å…¶ä¼ ç»™ subReactorï¼›</li>
<li><strong>å­è¿›ç¨‹è´Ÿè´£å¤„ç†ï¼šSub-Reactorï¼ˆåªç›‘å¬connfdçš„ioè¯»å†™äº‹ä»¶ï¼‰</strong>ï¼Œå°†å…¶è¿æ¥åŠ å…¥è¿æ¥é˜Ÿåˆ—ä¸­æ¥ç›‘æ§ï¼›</li>
<li><strong>Handlerï¼Œä¸€èµ·å¤„ç†read/ä¸šåŠ¡é€»è¾‘/writeï¼Œæ¯ä¸ªHandlerä¸€ä¸ªçº¿ç¨‹</strong>ã€‚</li>
</ol>
<p>ä»¥ä¸Šä»‹ç»çš„åªæ˜¯æ ‡å‡†çš„ Reactor æ¨¡å‹ï¼Œä½†å®é™…ä¸Šç”Ÿäº§ä¸Šåº”ç”¨çš„ Reactor ä¸ä¸€å®šå®Œå…¨éµç…§è¿™äº›æ ‡å‡†ã€‚</p>
<p>ä¸€èµ·çœ‹çœ‹muduoæ€ä¹ˆåšçš„ï¼</p>
<h3 id="1-2-2-Muduoä¸Reactoræ¨¡å¼">1.2.2 Muduoä¸Reactoræ¨¡å¼</h3>
<p>Muduoé‡‡ç”¨çš„ä¾¿æ˜¯<strong>å¤šçº¿ç¨‹&amp;å¤šReactoræ¨¡å¼</strong>ã€‚</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230310203312893.png" alt="image-20230310203312893"></p>
<ul>
<li>ä¸»è¿›ç¨‹ä¸­ï¼ŒMain-Reactorè´Ÿè´£<u>ç›‘å¬</u>listenfdï¼Œç­‰å¾…è¿æ¥äº‹ä»¶ï¼›Accpetorè´Ÿè´£<u>accpetè¿æ¥</u>è¿”å›connfdï¼ˆæ³¨æ„åœ¨muduoï¼Œdispatché€»è¾‘å®é™…ä¹Ÿåœ¨Accpetorä¸­ï¼šç”¨äºåˆ†é…ä¸€ä¸ªSub-Reactor&amp;ç»‘å®š/æ³¨å†Œè¿”å›connfdï¼‰ã€‚</li>
<li>å­è¿›ç¨‹ä¸­ï¼ˆ1~Nï¼‰ï¼Œæ¯ä¸ªå­è¿›ç¨‹è¿è¡Œä¸€ä¸ªSub-Reactorï¼Œè´Ÿè´£<u>ç›‘å¬</u>å·²æ³¨å†Œçš„connfdç­‰å¾…ioè¯»å†™äº‹ä»¶ã€‚</li>
</ul>
<p>åœ¨muduoä¸­ï¼Œæ¯ä¸ªMain-Reactor/Sub-ReactoræŠ½è±¡ä¸ºEventLoopå¯¹è±¡ï¼Œä¸”è¿è¡Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚è¿™ä¹Ÿæ˜¯<code>one loop per thread</code>çš„ç”±æ¥ã€‚</p>
<p>ä»…ä»…é€šè¿‡ä¸Šå›¾ï¼Œä¹Ÿèƒ½å‘ç°muduoä¸å°‘ç‰¹åˆ«ä¹‹å¤„ï¼š</p>
<ol>
<li><strong>æ¯ä¸ªSub-Reactoréƒ½ä¼šè´Ÿè´£ç›‘å¬ä¸€éƒ¨åˆ†connfdçš„ioäº‹ä»¶</strong>ï¼Œæé«˜äº†æœåŠ¡å™¨å¤„ç†è¿æ¥èƒ½åŠ›ï¼›</li>
<li>Sub-Reactorå’ŒMain-Reactoré€šä¿¡ï¼Œæ˜¯<strong>é€šè¿‡æ›´é«˜æ•ˆeventfd</strong>ï¼Œè€Œä¸æ˜¯åƒMain-Reactorä½¿ç”¨socket listen()å’Œå®¢æˆ·ç«¯é€šä¿¡ï¼›</li>
<li><strong>Sub-Reactorä¸ä»…è¦â‘ å¤„ç†æ‰€æœ‰connfdçš„ioäº‹ä»¶ï¼›â‘¡è¿˜è¦å¤„ç†å›è°ƒé˜Ÿåˆ—ä¸­çš„äº‹ä»¶</strong>ã€‚</li>
</ol>
<p>ä¸Šé¢çš„Reactor/Accpetor/â€¦æ¦‚å¿µï¼Œåˆæ˜¯åœ¨muduoä»£ç ä¸­æ€ä¹ˆæŠ½è±¡å®ç°ï¼Ÿä¸€èµ·çœ‹çœ‹ï¼</p>
<h2 id="1-3-Muduoæ ¸å¿ƒç±»">1.3 Muduoæ ¸å¿ƒç±»</h2>
<p>Muduoæ ¸å¿ƒç±»çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<blockquote>
<p><strong>ä¸ºä»€ä¹ˆè¦ç»§æ‰¿NonCopyableåŸºç±»</strong>ï¼Ÿ</p>
<ul>
<li>
<p>å¥½å¤„ï¼šå¼ºåˆ¶åªèƒ½ä»¥æŒ‡é’ˆçš„æ–¹å¼ä½¿ç”¨ï¼Œ ä¸èƒ½ä»¥æ‹·è´ç±»çš„æ–¹å¼æ¥ä½¿ç”¨ï¼Œ é¿å…åå¤æ‹·è´å†…å­˜ç©ºé—´æ¶ˆè€—ã€‚</p>
</li>
<li>
<p>å…·ä½“å®ç°ï¼šè¿™ä¸ªç±»å°†æ‹·è´å’Œèµ‹å€¼æ„é€ å‡½æ•°ç»™deleteæ‰ï¼Œæä¾›äº†ä¸€ä¸ª<strong>ä¸å¯æ‹·è´</strong>çš„åŸºç±»</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NonCopyable</span>(<span class="keyword">const</span> NonCopyable &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">NonCopyable &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> NonCopyable &amp;) = <span class="keyword">delete</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/classnoncopyable__inherit__graph%E7%9A%84%E5%89%AF%E6%9C%AC2.png" alt="classnoncopyable__inherit__graphçš„å‰¯æœ¬2"></p>
<h3 id="1-3-1-Reactorï¼šPollerã€EventLoopã€EventLoopThreadã€TcpConnectionã€Channel">1.3.1 Reactorï¼šPollerã€EventLoopã€EventLoopThreadã€TcpConnectionã€Channel</h3>
<h4 id="Pollerç±»-EPollPollerç±»">Pollerç±» &amp; EPollPollerç±»</h4>
<p>Pollerç±»åº•å±‚å°è£…<u>epoll</u> &amp; <u>poll</u>ï¼Œå®ƒè¿˜ä¼šè¢«EPollPollerç»§æ‰¿ï¼ŒEPollPolleræ˜¯<u>epoll</u>çš„å°è£…ç±»ã€‚æ•´ä½“å®ç°æ¯”è¾ƒç®€å•ã€‚</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>updateChannel()ã€removeChannel() ï¼Œç­‰å‡½æ•°æ˜¯å°è£…<code>EPOLL_CTL_ADD</code> ã€<code>EPOLL_CTL_DEL</code> ï¼›</li>
<li>Pollerï¼Œæ„é€ å‡½æ•°owerLoopæ ‡è¯†äº†å½“å‰Pollerå¯¹è±¡æ‰€å±Loopï¼›ææ„å‡½æ•°ï¼Œé»˜è®¤ï¼›</li>
<li>EollPolleræ„é€ å‡½æ•°ï¼Œæ‰§è¡ŒPolleræ„é€ å‡½æ•°ï¼Œåˆ›å»ºepollfdï¼›ææ„å‡½æ•°å…³é—­epollfdã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>Poller &amp; EPollPolleræˆå‘˜åŠç»§æ‰¿å…³ç³»</th>
<th>EPollPolleræ„é€ å‡½æ•°&amp;ææ„å‡½æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/classEPollPoller__inherit__graph.png" alt="classEPollPoller__inherit__graph"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230302174034339.png" alt="image-20230302174034339"></td>
</tr>
</tbody>
</table>
<h4 id="EventLoopç±»">EventLoopç±»</h4>
<p>EventLoopç±»è¿›ä¸€æ­¥å°è£…äº†Pollerç±»ï¼Œé€šè¿‡è°ƒç”¨Poller::poll()è¿›è¡ŒI/Oå¤ç”¨ï¼Œè¿”å›æ´»è·ƒäº‹ä»¶åˆ—è¡¨ï¼Œ<strong>ç„¶åéå†è¯¥åˆ—è¡¨ï¼Œä¾æ¬¡è°ƒç”¨æ¯ä¸€ä¸ªæ´»è·ƒChannelçš„</strong>äº‹ä»¶å¤„ç†å‡½æ•°handleEvent()ï¼Œè€ŒhandleEventå…¶å®å°±æ˜¯æ ¹æ®äº‹ä»¶å“åº”ç±»å‹ï¼ˆEPOLLINã€EPOLLOUTç­‰ï¼‰ï¼Œæœ€ç»ˆè°ƒç”¨TcpConnectionæ³¨å†Œè¿‡æ¥çš„å›è°ƒå‡½æ•°ã€‚</p>
<table>
<thead>
<tr>
<th>EventLoopç±»æˆå‘˜</th>
<th>EventLoopç±»æ„é€ å‡½æ•°&amp;ææ„å‡½æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230310202213519.png" alt="image-20230310202213519"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230310202407788.png" alt="image-20230310202407788"></td>
</tr>
</tbody>
</table>
<p>ä½œä¸ºmuduoçš„æ ¸å¿ƒç±»ï¼ŒEventLoopç±»å€¼å¾—åˆ†æçš„åœ°æ–¹å¾ˆå¤šã€‚ <u>æœ¬æ–‡å°†åœ¨2.1éƒ¨åˆ†ï¼Œä¸²è®²æ•´ä¸ªæµç¨‹åŠ æ·±ç†è§£</u>ã€‚</p>
<h5 id="ä»æ„é€ å‡½æ•°çœ‹ï¼šwakeupFdè®¾è®¡ä¸tieåˆè¯†">ä»æ„é€ å‡½æ•°çœ‹ï¼š<code>wakeupFd</code>è®¾è®¡ä¸<code>tie</code>åˆè¯†</h5>
<p><strong>è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹<code>wakeupFd</code>è®¾è®¡</strong>ã€‚</p>
<p>æƒ³æƒ³è¿™ä¹ˆä¸€ç§æƒ…å†µï¼š<strong>Sub-Reactorï¼ˆEventLoopï¼‰å¼€å¯äº‹ä»¶å¾ªç¯åï¼Œé˜»å¡åœ¨epollï¼›æ­¤æ—¶å¦‚æœæœ‰æ–°è¿æ¥clientfdå¾…æ³¨å†Œï¼ŒMain-Reactorï¼ˆAccpetorï¼‰å¦‚ä½•é€šçŸ¥Sub-Reactor</strong>ï¼Ÿ</p>
<p>è¿™ä¸ªæ—¶å€™ä¾¿éœ€è¦<code>wakeupFd</code>â€œå”¤é†’â€ã€‚èªæ˜çš„ä½ æƒ³åˆ°ï¼š<strong>Accpetorç»‘å®šçš„listenfdæ˜¯é€šè¿‡<code>listen()</code>æ¥ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚ï¼ŒSub EventLoopä¹Ÿå¯ä»¥é€šè¿‡<code>listen()</code>æ¥ç›‘å¬Main-Reactorè¯·æ±‚</strong>ï¼Ÿ</p>
<blockquote>
<p>âš ï¸ å›å¿†<code>listen()</code>ï¼š</p>
<ul>
<li><code>listen()</code> åªæ˜¯è®©å¥—æ¥å­—è¿›å…¥ç›‘å¬çŠ¶æ€ï¼Œå¹¶æ²¡æœ‰çœŸæ­£æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œlisten() åé¢çš„ä»£ç ä¼šç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ° accept()ï¼›</li>
<li><code>accept() </code>è¿”å›ä¸€ä¸ªæ–°fdæ¥å’Œå®¢æˆ·ç«¯é€šä¿¡ï¼Œä¼šé˜»å¡ç¨‹åºæ‰§è¡Œï¼ˆåé¢ä»£ç ä¸èƒ½è¢«æ‰§è¡Œï¼‰ï¼Œç›´åˆ°æœ‰æ–°çš„è¯·æ±‚åˆ°æ¥ã€‚</li>
</ul>
</blockquote>
<p>ä½†åœ¨muduoä¸­ï¼Œä½¿ç”¨çš„æ˜¯æ›´é«˜æ•ˆçš„<code>eventfd</code>ã€‚æ³¨æ„åˆ°ä¸Šè¡¨å³ä¾§EventLoop<u>æ„é€ å‡½æ•°</u>ï¼š</p>
<blockquote>
<p><strong>eventfdæ˜¯linuxçš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨</strong>ï¼Œä¸ºäº‹ä»¶é€šçŸ¥åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦ï¼Œeventfd()åˆ›å»ºä¸€ä¸ªâ€œeventfdå¯¹è±¡â€ï¼Œè¿™ä¸ªå¯¹è±¡èƒ½è¢«ç”¨æˆ·ç©ºé—´åº”ç”¨ç”¨ä½œä¸€ä¸ª<strong>äº‹ä»¶ç­‰å¾…/å“åº”æœºåˆ¶</strong>ï¼Œé å†…æ ¸å»å“åº”ç”¨æˆ·ç©ºé—´åº”ç”¨äº‹ã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>é¦–å…ˆï¼Œåˆ›å»ºwakeFd &amp; wakeupChannel</strong>:</p>
<p>ä¸åŒäºå¸¸è§„ä½¿ç”¨socketè·¨çº¿ç¨‹é€šä¿¡ï¼Œmuduoä½¿ç”¨eventfdï¼ˆäº‹ä»¶é©±åŠ¨æ›´å¿«ï¼Œ8å­—èŠ‚ç¼“å­˜åŒºä¹Ÿæ›´çœï¼‰ã€‚wakeupChannel_éšåå¯¹eventfdè¿›è¡Œå°è£…ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">wakeupFd_</span>(<span class="built_in">createEventfd</span>()) </span><br><span class="line"><span class="built_in">wakeupChannel_</span>(<span class="keyword">new</span> <span class="built_in">Channel</span>(<span class="keyword">this</span>, wakeupFd_))</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">createEventfd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> evtfd = ::<span class="built_in">eventfd</span>(<span class="number">0</span>, EFD_NONBLOCK | EFD_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (evtfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_FATAL</span>(<span class="string">&quot;eventfd error:%d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> evtfd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>éšåwakeupChannel_è®¾ç½®Readå›è°ƒäº‹ä»¶<code>EventLoop::handleRead</code></strong>ï¼š</p>
<blockquote>
<p>æ³¨æ„åŒºåˆ†åé¢ä¼šæåˆ°çš„ï¼š<code>Acceptor::handleRead</code>å‡½æ•°ã€‚</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wakeupChannel_-&gt;<span class="built_in">setReadCallback</span>(</span><br><span class="line">        std::<span class="built_in">bind</span>(&amp;EventLoop::handleRead, <span class="keyword">this</span>)); </span><br></pre></td></tr></table></figure>
<p>å¾ˆç®€å•ï¼Œ<code>EventLoop::handleRead(this)</code> åªæ˜¯æœ‰å†™äº‹ä»¶ï¼ˆMain-Reactorä¸ºäº†å”¤é†’å¾€<code>wakeupFd_</code> å†™ï¼‰æ—¶ï¼Œè¯»å‡ºæ•°æ®ï¼ŒåŸºæœ¬å•¥ä¹Ÿæ²¡å¹²ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventLoop::handleRead</span><span class="params">()</span> <span class="comment">// åˆ é™¤readåˆ¤é”™é€»è¾‘</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> one = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">ssize_t</span> n = <span class="built_in">read</span>(wakeupFd_, &amp;one, <span class="built_in"><span class="keyword">sizeof</span></span>(one));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Sub-Reactorï¼ˆEventLoppï¼‰æ³¨å†ŒwakeFdäº‹ä»¶å¼€å§‹ç›‘å¬</strong>ï¼š</p>
<p><code>Channel::enableReading()</code> æ ¸å¿ƒé€»è¾‘æ˜¯ï¼Œæ³¨å†Œfdäº‹ä»¶åˆ°å½“å‰è°ƒç”¨Channelæ‰€ç»‘å®šçš„EventLoopçš„epollä¸Šã€‚</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230302153343007.png" alt="image-20230302153343007"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wakeupChannel_-&gt;<span class="built_in">enableReading</span>();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>è¿™æ ·Main-Reactoréœ€è¦å”¤é†’Sub-Reactoræ—¶ï¼š</p>
<ol>
<li>
<p>å°†æ–°è¿æ¥å»ºç«‹çš„å›è°ƒäº‹ä»¶ï¼ˆ<em><strong>TcpConnection::connectEstablished</strong></em>,ï¼‰ï¼Œå‹å…¥Sub-Reactorçš„<u>å›è°ƒé˜Ÿåˆ—</u> ï¼›</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*in TcpServer.cc*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpServer::newConnection</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> InetAddress &amp;peerAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// .... çœç•¥</span></span><br><span class="line">  ioLoop-&gt;EventLoop::<span class="built_in">runInLoop</span></span><br><span class="line">  (std::<span class="built_in">bind</span>(&amp;TcpConnection::connectEstablished, conn));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åªéœ€ç®€å•<code>wakeup()</code> , Sub-Reactorä¾¿ä¸å†é˜»å¡åœ¨epollï¼›</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æ¥å”¤é†’loopæ‰€åœ¨çº¿ç¨‹ å‘wakeupFd_å†™ä¸€ä¸ªæ•°æ® wakeupChannelå°±å‘ç”Ÿè¯»äº‹ä»¶ å½“å‰loopçº¿ç¨‹å°±ä¼šè¢«å”¤é†’</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventLoop::wakeup</span><span class="params">()</span><span class="comment">// åˆ é™¤writeåˆ¤é”™é€»è¾‘</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> one = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">ssize_t</span> n = <span class="built_in">write</span>(wakeupFd_, &amp;one, <span class="built_in"><span class="keyword">sizeof</span></span>(one));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>éšåSub-Reactorè¢«å”¤é†’ï¼Œéå†å¤„ç†é˜Ÿåˆ—ä¸­çš„å›è°ƒäº‹ä»¶ã€‚</p>
</li>
</ol>
<p><strong><code>TcpConnection::connectEstablished</code> åšäº†ä»€ä¹ˆ</strong>ï¼Ÿ</p>
<p>ä¸éš¾åˆ†æä¸­ï¼Œå½“æ–°è¿æ¥åˆ°æ¥æ—¶ï¼Œæˆ‘ä»¬è‡³å°‘éœ€è¦å®ƒå¯ä»¥å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p>
<ul>
<li>æˆ‘ä»¬éœ€è¦æ–°è¿æ¥çš„clientfdæ³¨å†Œåˆ°Sub-Reactorï¼Œè¿›è¡Œåç»­ç›‘å¬ï¼›</li>
<li>æˆ‘ä»¬éœ€è¦æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„è¿æ¥å›è°ƒï¼›</li>
<li>â€¦</li>
</ul>
<p>å…¶å®ç°ä¾¿å‘¼åè€Œå‡ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿æ¥å»ºç«‹</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpConnection::connectEstablished</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">setState</span>(kConnected);</span><br><span class="line">    <span class="comment">// 1.è§£å†³TcpConnectionå¯¹è±¡å·²ç»ä¸å­˜åœ¨äº†ï¼Œè¿˜èƒ½æ„ŸçŸ¥åˆ°Pollerçš„é€šçŸ¥å¹¶è°ƒç”¨Channelçš„å›è°ƒæ–¹æ³•çš„é—®é¢˜</span></span><br><span class="line">    <span class="comment">// shared_from_this()==æŒ‡å‘å¯¹è±¡thisæŒ‡é’ˆçš„æœ‰æ•ˆshared_ptr</span></span><br><span class="line">    channel_-&gt;<span class="built_in">tie</span>(<span class="built_in">shared_from_this</span>());</span><br><span class="line">    <span class="comment">// 2.å‘polleræ³¨å†Œchannelçš„EPOLLINè¯»äº‹ä»¶</span></span><br><span class="line">    channel_-&gt;<span class="built_in">enableReading</span>(); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.æ–°è¿æ¥å»ºç«‹ï¼šæ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„å›è°ƒ</span></span><br><span class="line">    <span class="comment">// TcpConnection::connectionCallback==EchoServer::onConnection</span></span><br><span class="line">    <span class="built_in">connectionCallback_</span>(<span class="built_in">shared_from_this</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªå¥‡æ€ªçš„ä¸œè¥¿ï¼š<strong><code>tie</code> è¿™æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p>ç®€å•æ¥è¯´ï¼Œ<code>tie</code>é¿å…äº†è¿™ä¹ˆä¸€ç§æƒ…å†µï¼š</p>
<ul>
<li>Channelæ‰€å±çš„TcpConnectionå¯¹è±¡ï¼ˆç®€ç§°<code>T</code>ï¼‰å·²ç»ä¸å­˜åœ¨ï¼Œä½†Channelè¿˜åœ¨å¤„ç†clientfdå›è°ƒäº‹ä»¶&amp;è°ƒç”¨Channelçš„å›è°ƒæ–¹æ³•ï¼›</li>
<li>è€Œä¸”Channelå›è°ƒæ–¹æ³•é‡Œåˆå¾€å¾€è°ƒç”¨äº†<code>T</code>çš„æ–¹æ³•æˆå‘˜ï¼Œå¦‚<code>send()</code>ç­‰å¤„ç†æ•°æ®æ”¶å‘ï¼›</li>
<li>æœ€åï¼Œè°ƒç”¨ä¸å­˜åœ¨çš„å¯¹è±¡<code>T</code>å¯¼è‡´ç¨‹åºå´©æºƒã€‚</li>
</ul>
<p>åœ¨åé¢çš„<u>EventLoop::loop()</u>ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šè¯¦ç»†è§£é‡Šåˆ†æ<code>tie</code>è°ƒç”¨æµç¨‹ã€‚</p>
<h5 id="ææ„å‡½æ•°">ææ„å‡½æ•°</h5>
<p>EventLoopææ„å‡½æ•°è´Ÿè´£ï¼š</p>
<ul>
<li>â‘ epollä¸Šç§»é™¤wakeupChannel_ç›¸å…³äº‹ä»¶ï¼›</li>
<li>â‘¡ç§»é™¤ä»epollä¸ŠæŠŠwakeupChannel_æ‰€ç®¡ç†çš„fdï¼›</li>
<li>â‘¢è°ƒç”¨ç³»ç»Ÿå‡½æ•°å…³é—­fdã€‚</li>
</ul>
<h5 id="loop-å‡½æ•°">loop() å‡½æ•°</h5>
<p><code>loop() </code> å‡½æ•°ç”¨æ¥å¼€å¯äº‹ä»¶å¾ªç¯ï¼Œè¯´äººè¯ä¾¿æ˜¯ï¼š</p>
<ol>
<li>å¯åŠ¨åº•å±‚epoll_waitç›‘å¬æ„Ÿå…´è¶£äº‹ä»¶ ï¼›</li>
<li>æ„Ÿå…´è¶£äº‹ä»¶å¤„ç†ï¼Œå¦‚ï¼šâ‘ forå¾ªç¯å¤„ç†å¯è¯»ã€å¯å†™ã€é”™è¯¯ç­‰äº‹ä»¶ï¼›â‘¡doPendingFunctorså‡½æ•°å¤„ç†å›è°ƒé˜Ÿåˆ—ä¸­çš„äº‹ä»¶ã€‚</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å¯äº‹ä»¶å¾ªç¯</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventLoop::loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    looping_ = <span class="literal">true</span>;</span><br><span class="line">    quit_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;EventLoop %p start looping\n&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!quit_)</span><br><span class="line">    &#123;</span><br><span class="line">        activeChannels_.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="comment">// 1. åº•å±‚å®é™…è¿˜æ˜¯è°ƒç”¨epoll_waitç›‘å¬</span></span><br><span class="line">        pollRetureTime_ = poller_-&gt;<span class="built_in">poll</span>(kPollTimeMs, &amp;activeChannels_);</span><br><span class="line">        <span class="comment">// 2. å¤„ç†äº‹ä»¶1ï¼šéå†å¤„ç†å“åº”çš„EPOLLINã€EPOLLOUTç­‰äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">for</span> (Channel *channel : activeChannels_)</span><br><span class="line">        &#123;    </span><br><span class="line">            channel-&gt;<span class="built_in">handleEvent</span>(pollRetureTime_);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. å¤„ç†äº‹ä»¶2ï¼šéå†æ‰§è¡Œå›è°ƒé˜Ÿåˆ—ä¸­çš„å›è°ƒäº‹ä»¶ï¼ˆå‡½æ•°ï¼‰</span></span><br><span class="line">        <span class="comment">// å¦‚å‰è¿°æåˆ°çš„ï¼Œæ–°è¿æ¥åˆ°æ¥ï¼ŒMain-Reactorå°†å›è°ƒäº‹ä»¶</span></span><br><span class="line">        <span class="comment">// TcpConnection::connectEstablishedåŠ å…¥Sub-Reactorçš„å›è°ƒé˜Ÿåˆ—</span></span><br><span class="line">        <span class="built_in">doPendingFunctors</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;EventLoop %p stop looping.\n&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    looping_ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªåœ°æ–¹å€¼å¾—æ³¨æ„ï¼š</p>
<ol>
<li><code>Channel::handleEvent</code> å®ç°é€»è¾‘ï¼Œç‰¹åˆ«æ˜¯å…¶ä¸­<code>tie</code>ç›¸å…³é€»è¾‘ï¼›</li>
<li><code>EventLoop::doPendingFunctors()</code>å®ç°é€»è¾‘ï¼Œç‰¹åˆ«æ˜¯å…¶ä¸­çš„<u>çº¿ç¨‹åŒæ­¥åŠ é”é€»è¾‘</u>ã€‚</li>
</ol>
<h6 id="Channel-handleEventå®ç°"><strong><code>Channel::handleEvent</code>å®ç°</strong></h6>
<p><code>Channel::handleEventWithGuard</code> ä½œç”¨ï¼šå½“epollè¿”å›å¯è¯»ã€å¯å†™ã€é”™è¯¯ç­‰äº‹ä»¶ï¼Œå»è°ƒç”¨TcpConnetionç±»ç»™Channelè®¾ç½®çš„å›è°ƒå‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p>
<p>è¿™é‡Œåˆå‡ºç°äº†é‚£ä¸ªå¥‡æ€ªçš„<code>tie</code> ï¼Ÿ</p>
<table>
<thead>
<tr>
<th>Channel::handleEvent</th>
<th>Channel::handleEventWithGuard</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230302213126042.png" alt="image-20230302213126042"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com//image-20230302213317905.png" alt="image-20230302213317905"></td>
</tr>
</tbody>
</table>
<h6 id="tieæ·±å…¥ç†è§£"><code>tie</code>æ·±å…¥ç†è§£</h6>
<p>å‰é¢ç®€å•æåˆ°ï¼š</p>
<blockquote>
<p><code>tie</code>é¿å…äº†è¿™ä¹ˆä¸€ç§æƒ…å†µï¼š</p>
<ul>
<li>Channelæ‰€å±çš„TcpConnectionå¯¹è±¡ï¼ˆç®€ç§°<code>T</code>ï¼‰å·²ç»ä¸å­˜åœ¨ï¼Œä½†Channelè¿˜åœ¨å¤„ç†clientfdå›è°ƒäº‹ä»¶&amp;è°ƒç”¨Channelçš„å›è°ƒæ–¹æ³•ï¼›</li>
<li>è€Œä¸”Channelå›è°ƒæ–¹æ³•é‡Œåˆå¾€å¾€è°ƒç”¨äº†<code>T</code>çš„æ–¹æ³•æˆå‘˜ï¼Œå¦‚<code>send()</code>ç­‰å¤„ç†æ•°æ®æ”¶å‘ï¼›</li>
<li>æœ€åï¼Œè°ƒç”¨ä¸å­˜åœ¨çš„å¯¹è±¡<code>T</code>å¯¼è‡´ç¨‹åºå´©æºƒã€‚</li>
</ul>
</blockquote>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦<code>tie</code>ï¼šä¿è¯<strong>å…ˆè®©Channelå›è°ƒå‡½æ•°å…ˆæŠŠæ•°æ®å‘é€å®Œï¼Œå†é‡Šæ”¾TcpConnectionå¯¹è±¡çš„èµ„æº</strong>ã€‚</p>
<p>æ•´ä¸ªè¿‡ç¨‹å¤ç›˜å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p>å¦‚å‰æåˆ°ï¼ŒMain-Reactoréœ€è¦å”¤é†’Sub-Reactoræ—¶ï¼Œé¦–å…ˆä¼šå°†æ–°è¿æ¥å›è°ƒäº‹ä»¶ï¼ˆ<em><strong>TcpConnection::connectEstablished</strong></em>,ï¼‰ï¼Œå‹å…¥Sub-Reactorçš„<u>å›è°ƒé˜Ÿåˆ—</u> ï¼›</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*in TcpServer.cc*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpServer::newConnection</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> InetAddress &amp;peerAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// .... çœç•¥</span></span><br><span class="line">  ioLoop-&gt;EventLoop::<span class="built_in">runInLoop</span></span><br><span class="line">  (std::<span class="built_in">bind</span>(&amp;TcpConnection::connectEstablished, conn));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*in TcpConnection.cc*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpConnection::connectEstablished</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">setState</span>(kConnected);</span><br><span class="line">    <span class="comment">// 1.è§£å†³TcpConnectionå¯¹è±¡å·²ç»ä¸å­˜åœ¨äº†ï¼Œè¿˜èƒ½æ„ŸçŸ¥åˆ°Pollerçš„é€šçŸ¥å¹¶è°ƒç”¨Channelçš„å›è°ƒæ–¹æ³•çš„é—®é¢˜</span></span><br><span class="line">    channel_-&gt;<span class="built_in">tie</span>(<span class="built_in">shared_from_this</span>());</span><br><span class="line">    <span class="comment">// 2.å‘polleræ³¨å†Œchannelçš„EPOLLINè¯»äº‹ä»¶</span></span><br><span class="line">    channel_-&gt;<span class="built_in">enableReading</span>(); </span><br><span class="line">    <span class="comment">// 3.æ–°è¿æ¥å»ºç«‹ï¼šæ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„å›è°ƒ</span></span><br><span class="line">    <span class="comment">// TcpConnection::connectionCallback==EchoServer::onConnection</span></span><br><span class="line">    <span class="built_in">connectionCallback_</span>(<span class="built_in">shared_from_this</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶æ˜¯åœ¨<code>TcpConnection</code>å¯¹è±¡<code>T</code>ä¸­ï¼Œ<code>shared_from_this()</code> è¿”å›çš„æ˜¯shared_ptræŒ‡é’ˆæŒ‡å‘<code>T</code>ã€‚</p>
<p><code>Channel::tie</code>ä½¿ç”¨<strong>weak_ptr</strong> å³<code>tie_</code>ç»‘å®šäº†<code>T</code> ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">std::weak_ptr&lt;<span class="keyword">void</span>&gt; tie_; </span><br><span class="line"><span class="comment">/*****  Channel.cc   ******/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Channel::tie</span><span class="params">(<span class="keyword">const</span> shared_ptr&lt;<span class="keyword">void</span>&gt;&amp; obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    tie_ = obj;</span><br><span class="line">    tied_ = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¿™æ ·ï¼Œå¦‚æœepollç›‘å¬äº‹ä»¶è§¦å‘ï¼Œæ‰§è¡Œ<code>Channel::HandlerEvent</code> ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(tied_)&#123;</span><br><span class="line">        shared_ptr&lt;<span class="keyword">void</span>&gt; guard = tie_.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="keyword">if</span> (guard)</span><br><span class="line">            <span class="built_in">HandleEventWithGuard</span>(receiveTime);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>é¦–å…ˆåˆ¤æ–­ä¸€ä¸‹å½“å‰Channelæ˜¯å¦ç”Ÿå‘½ç»‘å®šäº†ä¸€ä¸ªTcpConnectionå¯¹è±¡ï¼ˆè²Œä¼¼æ˜¯ä¸€å®šæˆç«‹çš„ï¼Ÿï¼‰ ï¼›</p>
</li>
<li>
<p>ç„¶åé‡å¤´æˆï¼Œä½¿ç”¨<code>tie_.lock()</code> å°†<code>tie_</code>è¿™ä¸ªweak_ptræå‡â†’shared_ptr ï¼Œè¯¥shared_ptræ‰§è¡ŒTcpConnectionå¯¹è±¡ï¼›</p>
<blockquote>
<p>å‚è€ƒ<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38410730/article/details/105903979">here</a>ï¼šweak_pträ¸æ”¹å˜shared_ptrå®ä¾‹çš„å¼•ç”¨è®¡æ•°ï¼Œå¯èƒ½å­˜åœ¨weak_ptræŒ‡å‘çš„å¯¹è±¡è¢«é‡Šæ”¾æ‰è¿™ç§æƒ…å†µï¼Œ<strong>å¦‚ä½•åˆ¤æ–­weak_ptræŒ‡å‘å¯¹è±¡æ˜¯å¦å­˜åœ¨å‘¢</strong>ï¼ŸC++ä¸­æä¾›äº†lock<code>()</code>æ¥å®ç°è¯¥åŠŸèƒ½ã€‚</p>
<p>å¦‚æœå¯¹è±¡å­˜åœ¨ï¼Œlock()å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘å…±äº«å¯¹è±¡çš„shared_ptr(å¼•ç”¨è®¡æ•°ä¼šå¢1)ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªç©ºshared_ptrã€‚</p>
</blockquote>
</li>
<li>
<p>å¦‚æœ<code>guard</code> ä¸ä¸ºnullï¼Œåˆ™è¯´æ˜å…±äº«çš„TcpConnectionå¯¹è±¡è¿˜å­˜åœ¨ï¼Œå¯ä»¥æ”¾å¿ƒåœ°ç»§ç»­å¾€ä¸‹æ‰§è¡Œ<code>Channel::handleEventWithGuard</code> ï¼›å¦åˆ™ä¸åšå¤„ç†ã€‚</p>
</li>
</ul>
</li>
</ol>
<p>è‡³æ­¤ï¼Œ<code>tie</code>çš„ä½œç”¨ä¾¿å·²äº†ç„¶äºèƒ¸ï¼šä¿è¯åœ¨Channelå¯¹è±¡æ‰§è¡Œå›è°ƒæ—¶ï¼ŒTcpConnectionå¯¹è±¡ä¸€å®šå­˜åœ¨ã€‚</p>
<h6 id="doPendingFunctors-ï¼šç»“åˆrunInLoop-ç†è§£å›è°ƒé˜Ÿåˆ—ä¸­çš„å¤šçº¿ç¨‹åŒæ­¥">doPendingFunctors() ï¼šç»“åˆrunInLoop()ç†è§£å›è°ƒé˜Ÿåˆ—ä¸­çš„å¤šçº¿ç¨‹åŒæ­¥</h6>
<p>å¦‚å‰æåˆ°ï¼Œåœ¨äº‹ä»¶å¾ªç¯loop()ä¸­ï¼Œepollè¢«è§¦å‘æ—¶ï¼Œéœ€æ‰§è¡Œä¸¤ç±»äº‹ä»¶ï¼š</p>
<ol>
<li>å¤„ç†äº‹ä»¶1ï¼šéå†å¤„ç†å“åº”çš„EPOLLINã€EPOLLOUTç­‰äº‹ä»¶ï¼Œè¿™ç±»äº‹ä»¶å¤„ç†<u>åŸºæœ¬æ˜¯ç”¨æˆ·è‡ªå®šä¹‰ä¸šåŠ¡å›è°ƒå‡½æ•°</u>å¤„ç†ï¼›</li>
<li>å¤„ç†äº‹ä»¶2ï¼šéå†æ‰§è¡Œå›è°ƒé˜Ÿåˆ—ä¸­çš„å›è°ƒäº‹ä»¶ï¼ˆå‡½æ•°ï¼‰ï¼Œå¦‚æ¡†æ¶ä¸­é¢„å®šä¹‰çš„TcpConnection::shutdownInLoopã€TcpConnection::connectEstablished() ç­‰ã€‚</li>
</ol>
<p>ç¬¬2ç±»äº‹ä»¶å¤„ç†ï¼Œä¾¿åœ¨doPendingFunctors()ä¸­å®ç°ã€‚å…¶ä¸­çš„å¤šçº¿ç¨‹è®¾è®¡éš¾ç‚¹ï¼Œè¦ç»“åˆrunInLoop()å‡½æ•°ç†è§£ï¼š</p>
<table>
<thead>
<tr>
<th>EventLoop::runInLoop()</th>
<th>EventLoop::doPendingFunctors()</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230303163927004.png" alt="image-20230303163927004"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230303163516830.png" alt="image-20230303163516830"></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p><strong>runInLoop(cb)å‡½æ•°åŠŸèƒ½ï¼šè´Ÿè´£å”¤é†’è°ƒç”¨å…¶æ‰€å±EventLoopå¯¹è±¡æ‰€åœ¨çš„çº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œå›è°ƒäº‹ä»¶cb</strong>ã€‚</p>
<ul>
<li>
<p><strong>å¦‚æœTAâ‰ TB</strong>ï¼Œè§¦å‘æ–°äº‹ä»¶æ—¶ï¼ŒæŸä¸ªEventLoopå¯¹è±¡EAï¼ˆæ‰€å±çº¿ç¨‹TAï¼‰ï¼Œå”¤é†’ï¼ˆä¸å†é˜»å¡åœ¨epollï¼‰&amp;è°ƒç”¨å¦å¤–æŸä¸ªEventLoopå¯¹è±¡EBï¼ˆæ‰€å±çº¿ç¨‹TBï¼‰çš„å‡½æ•°<code>runInLoop(cb)</code>ï¼Œå°†å›è°ƒcbåŠ å…¥åˆ°å›è°ƒé˜Ÿåˆ—<code>pendingFunctors_</code>ï¼›</p>
<p>æ¯”å¦‚ï¼Œæ–°è¿æ¥åˆ°æ¥æ—¶ï¼Œmain loopï¼ˆæ‰€å±çº¿ç¨‹TAï¼‰è°ƒç”¨sub loopï¼ˆæ‰€å±çº¿ç¨‹TBï¼‰<code>runInLoop(TcpConnection::connectEstablished)</code>ã€‚</p>
</li>
<li>
<p><strong>å¦‚æœTA=TB</strong>ï¼Œåˆ™ç«‹å³æ‰§è¡Œå›è°ƒäº‹ä»¶<code>cb()</code>ï¼Œèµ°åˆ°è¿™é‡Œè¯´æ˜çº¿ç¨‹æ²¡æœ‰å¤„ç†å…¶å®ƒäº‹ï¼ˆæ¯”å¦‚æ­£åœ¨å¤„ç†å›è°ƒé˜Ÿåˆ—ï¼‰ï¼Œå› æ­¤ç›´æ¥æ‰§è¡Œå³å¯ã€‚</p>
</li>
</ul>
</li>
<li>
<p><strong>doPendingFunctors()å‡½æ•°åŠŸèƒ½</strong>ï¼šåœ¨æŸä¸ªEventLoopå¯¹è±¡ï¼Œä¾‹å¦‚ä¸ºä¸Šè¿°EBï¼Œå¤„ç†å›è°ƒé˜Ÿåˆ—<code>pendingFunctors_</code>ä¸­çš„å‡½æ•° ã€‚</p>
</li>
</ul>
<p><strong>å½“TAâ‰ TBï¼Œå­˜åœ¨ä¸¤ä¸ªå¤šçº¿ç¨‹åŒæ­¥é—®é¢˜</strong>ï¼š</p>
<ol>
<li>
<p><strong>çº¿ç¨‹TAï¼Œå¦‚ä½•ä¿è¯å°†å›è°ƒäº‹ä»¶æ³¨å†ŒEventLoopå¯¹è±¡ EBä¸Šæ—¶ï¼Œå»å”¤é†’TBæ‰§è¡Œï¼ŸEBå±äºçº¿ç¨‹TB</strong>ï¼›</p>
</li>
<li>
<p><strong>EventLoopå¯¹è±¡EBæ‰€å±çº¿ç¨‹TBå·²ç»è¢«å”¤é†’ï¼Œä¸”æ­£åœ¨å¤„ç†<code>pendingFunctors_</code> ï¼›æ­¤æ—¶TAåˆè¦å°†æ–°å›è°ƒ<code>cb</code>åŠ å…¥<code>pendingFunctors_</code> ï¼Œè¯¥å¦‚ä½•ç”¨é”ä¼˜é›…å¤„ç†<code>pendingFunctors_</code>çš„å¤šçº¿ç¨‹ç«äº‰</strong>ï¼Ÿ</p>
<ul>
<li>ä¸è¿‡è¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼š<u>è¿™é‡Œæ˜¯å…¸å‹1æ¶ˆè´¹è€…Nç”Ÿäº§è€…æ¨¡å‹ï¼Œå³æœ‰å¤šä¸ªç”Ÿäº§çº¿ç¨‹å¯èƒ½å¾€<code>pendingFunctors_</code>åŠ å…¥cbå›è°ƒï¼Œå½“å‰EventLoopå¯¹è±¡æ‰€åœ¨çº¿ç¨‹æ¶ˆè´¹æ‰§è¡Œcbå›è°ƒã€‚è™½ç„¶<code>pendingFunctors_</code>ä¼šè¢«å¤šä¸ªçº¿ç¨‹æ”¹å˜çŠ¶æ€ï¼Œä½†æ˜¯ç”Ÿäº§è€…çº¿ç¨‹ä¹‹é—´å„è‡ªåŠ å…¥è‡ªå·±å›è°ƒä¸éœ€è¦çŠ¶æ€åŒæ­¥ï¼Œå„è‡ªåŠ å…¥å›è°ƒå³å¯ï¼›æ¶ˆè´¹è€…éå†<code>pendingFunctors_</code>å›è°ƒé˜Ÿåˆ—æ—¶ï¼Œè™½ç„¶é˜Ÿåˆ—çŠ¶æ€ä¸ä¸€å®šå‡†ç¡®ï¼Œæ¯”å¦‚åˆ¤æ–­å·²ç»éå†åˆ°é˜Ÿå°¾æ—¶ä½†æ°å¥½åˆæœ‰æ–°cbåŠ å…¥ï¼Œç­‰å¾…ä¸‹æ¬¡å†å¤„ç†å³å¯</u>ï¼Ÿ</li>
</ul>
<p>æˆ‘çŒœæµ‹åŸå› åº”è¯¥æ˜¯<u>pendingFunctors_æ˜¯Vectorç±»å‹ï¼Œè€ŒVectoræ˜¯çº¿ç¨‹éå®‰å…¨çš„ï¼Œæ‰€ä»¥å…¶å®è¿˜æ˜¯éœ€è¦çŠ¶æ€åŒæ­¥</u>ã€‚</p>
<ul>
<li>ä¾‹å¦‚ï¼Œ<strong>å¤šä¸ª</strong>ç”Ÿäº§è€…çº¿ç¨‹ä¹‹é—´å‘pendingFunctors_.emplace_back(cb)åŠ å…¥å›è°ƒ<u>å…¶å®æ˜¯éœ€è¦çŠ¶æ€åŒæ­¥</u>çš„ã€‚å› ä¸ºpendingFunctors_æ˜¯vectoræ•°ç»„ï¼Œvectoræ•°ç»„æ’å…¥éçº¿ç¨‹å®‰å…¨ï¼Œä¸”å­˜åœ¨<u>è‡ªåŠ¨æ‰©å®¹</u>æœºåˆ¶ã€‚æ¯”å¦‚çº¿ç¨‹aæ’å…¥è§¦å‘æ‰©å®¹æ•°ç»„çš„å†…å­˜é‡æ–°åˆ†é…ï¼Œçº¿ç¨‹båˆæ°å¥½æ’å…¥ï¼Œå¯èƒ½ä¼šå¼•èµ·æ„æ–™ä¹‹å¤–çš„å†…å­˜é”™è¯¯ã€‚</li>
<li>åˆå¦‚ï¼Œ<strong>å•ä¸ª</strong>æ¶ˆè´¹è€…çº¿ç¨‹æ¶ˆè´¹cbï¼Œeraseåè™½ç„¶vectorä¸ä¼š<u>è‡ªåŠ¨ç¼©å®¹</u>ï¼Œä½†æ˜¯è€ƒè™‘çº¿ç¨‹å®‰å…¨è¿˜æ˜¯åŠ é”ï¼Ÿ<strong>é«˜æ‰‹çœ‹ä¸é€å•Š</strong>ã€‚</li>
</ul>
</li>
</ol>
<blockquote>
<p>å¯¹äºé—®é¢˜1ï¼š<strong>çº¿ç¨‹TAï¼Œå¦‚ä½•ä¿è¯å°†å›è°ƒäº‹ä»¶æ³¨å†ŒEventLoopå¯¹è±¡ EBä¸Šæ—¶ï¼Œå»å”¤é†’TBæ‰§è¡Œ</strong>ï¼Ÿ</p>
</blockquote>
<p>muduoç»™å‡ºçš„ç­”æ¡ˆæ˜¯ï¼š</p>
<ol>
<li>EventLoopå¯¹è±¡åªè¿è¡Œåœ¨ä¸€ä¸ªThreadä¸Šï¼Œå¹¶åœ¨å¯¹è±¡åˆå§‹åŒ–æ—¶ä½¿ç”¨<code>threadId_</code>å­—æ®µè®°å½•è¯¥Threadçš„pidï¼›</li>
<li>åœ¨æ³¨å†Œå›è°ƒæ—¶ï¼Œé€šè¿‡<code>isInLoopThread()</code> å‡½æ•°æ¯”è¾ƒè°ƒç”¨EBçº¿ç¨‹çš„pid å’Œ <code>threadId_</code>å­—æ®µï¼Œå¦‚æœä¸€æ ·åˆ™ç›´æ¥æ‰§è¡Œï¼›</li>
<li>å¦‚æœä¸ä¸€æ ·ï¼Œè°ƒç”¨EBçš„wakeup()ï¼Œå”¤é†’å…¶å±Thread TBå³å¯ã€‚</li>
</ol>
<blockquote>
<p>å¯¹äºé—®é¢˜2ï¼š<strong>å¦‚ä½•ä¼˜é›…ç”¨é”å¤„ç†<code>pendingFunctors_</code>çš„å¤šçº¿ç¨‹ç«äº‰</strong>ï¼Ÿ</p>
</blockquote>
<p>è®¾ç½®äº’æ–¥é”<code>mutex_</code>æ¥å¤„ç†ï¼Œæš‚æ—¶å¿˜è®°muduoï¼Œä¸‹é¢çœ‹ä¼¼æ›´ç®€å•ä¸€ç‚¹å®ç°æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<table>
<thead>
<tr>
<th>EventLoop::queueInLoop() : åŸºæœ¬æ— æ”¹åŠ¨</th>
<th>EventLoop::doPendingFunctors()ï¼šç¬¬ä¸€æ¬¡å®ç°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230303203552875.png" alt="image-20230303203552875"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230303211319508.png" alt="image-20230303211319508"></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p><strong>é”èŒƒå›´å¢å¤§ï¼Œæ€§èƒ½é™ä½</strong>ï¼šåªæœ‰ç­‰å›è°ƒé˜Ÿåˆ—å‡½æ•°å…¨éƒ¨æ‰§è¡Œå®Œæ‰é‡Šæ”¾é”ï¼Œåœ¨æ­¤æœŸé—´<u>queueInLoopå°†ä¸å¯ç”¨</u>ï¼›</p>
</li>
<li>
<p><strong>æ­»é”é£é™©</strong>ï¼š<code>doPendingFunctors</code>æ‹¿åˆ°é”â€”&gt;<code>queueInLoop</code>ç­‰å¾…<code>doPendingFunctors</code>é‡Šæ”¾é”â€”&gt; <code>doPendingFunctors</code>æ‰§è¡Œçš„å›è°ƒæ°å¥½ä¹Ÿè¦æ‰§è¡Œ<code>queueInLoop</code> â€”&gt; <code>doPendingFunctors</code>ç­‰å¾…<code>queueInLoop</code>æ‰§è¡Œ â€”&gt;æ­»é”ã€‚</p>
</li>
</ul>
<p>èªæ˜çš„ä½ æƒ³åˆ°ï¼šå¦‚<strong>å‰è¿°ï¼Œæˆ‘ä»¬åŠ é”ä¸»è¦æ˜¯è€ƒè™‘Vectorç±»å‹å›è°ƒé˜Ÿåˆ—å¤šçº¿ç¨‹æ“ä½œï¼ˆæ’å…¥ã€åˆ é™¤ç­‰ï¼‰å®‰å…¨ï¼›ä½†æ¶ˆè´¹çº¿ç¨‹ï¼ˆEventLoopå¯¹è±¡ï¼‰æ‰§è¡Œ<code>cb()</code>æ—¶ï¼Œé‡Œé¢çš„å›è°ƒå‡½æ•°å®Œå…¨æ˜¯å¯ä»¥ç‹¬ç«‹æ‰§è¡Œçš„ã€‚å¦‚æœå°†é˜Ÿåˆ—ä¸­å›è°ƒå‡½æ•°æ”¾åˆ°ä¸´æ—¶é˜Ÿåˆ—ï¼Œéå†ä¸´æ—¶é˜Ÿåˆ—æ‰§è¡Œå›è°ƒå°±å¯ä»¥é‡Šæ”¾é”äº†ï¼ˆé˜Ÿåˆ—ç›¸å…³æ“ä½œå®Œæˆï¼‰ã€‚ä¸ä½†ç¼©å°é”èŒƒå›´äº†ï¼ŒåŒæ—¶è¿˜é¿å…äº†æ­»é”</strong>ï¼</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å†™å‡ºç¬¬2ç‰ˆä»£ç ï¼š</p>
<table>
<thead>
<tr>
<th>EventLoop::queueInLoop() : åŸºæœ¬æ— æ”¹åŠ¨</th>
<th>EventLoop::doPendingFunctors()ï¼šä¿®æ”¹é”èŒƒå›´</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230303203552875.png" alt="image-20230303203552875"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230303220711006.png" alt="image-20230303220711006"></td>
</tr>
</tbody>
</table>
<p>ä¸è¿‡æˆ‘ä»¬ä¾æ—§å¯ä»¥åšä¸€ä¸ªå°æ”¹è¿›ï¼š</p>
<ul>
<li>ä½¿ç”¨callingPendingFunctors_è®°å½•ï¼ˆå³æ ï¼‰EventLoopå¯¹è±¡æ‰€åœ¨çº¿ç¨‹T<u>æ˜¯å¦å·²ç»éå†æ‰§è¡Œå®Œ</u>å›è°ƒé˜Ÿåˆ—ä¸­çš„å‡½æ•°ï¼›</li>
<li>å¦‚æœEventLoopå¯¹è±¡æ‰€åœ¨çº¿ç¨‹åœ¨æ‰§è¡Œå›è°ƒï¼Œæ–°å›è°ƒcbåŠ å…¥<u>åº”è¯¥è¦éšç€é˜Ÿåˆ—ä¸­çš„å›è°ƒä¸€èµ·æ‰§è¡Œå®Œ</u>ï¼ˆå±äºæ—¶é—´æ®µçš„äº‹ä»¶ï¼‰ï¼Œè¿™æ ·å½“<code>callingPendingFunctors_=true</code>ï¼Œå”¤é†’EventLoopå¯¹è±¡æ‰€åœ¨çº¿ç¨‹ï¼Œ è®©æ‰§è¡Œå®Œ<code>doPendingFunctors</code>è¿›å…¥åˆ°ä¸‹ä¸€æ¬¡<code>poller_-&gt;poll()</code>ä¹Ÿä¸é˜»å¡ï¼Œä¼šå†ä¾æ¬¡æ‰§è¡Œ<code>doPendingFunctors</code>å¤„ç†æ–°cbã€‚</li>
</ul>
<p>æœ€åmuduoä»£ç å®ç°ä¸ºï¼š</p>
<blockquote>
<p>è¿™é‡Œè¿˜æœ‰ä¸ªå°ç–‘é—®ï¼š</p>
<ul>
<li>ä¸ºä»€ä¹ˆè¿™ä¸ªcallingPendingFunctors_å˜é‡æ²¡æœ‰ç”¨åŸå­ï¼Ÿå¤–é¢æœ‰çº¿ç¨‹ä¼šæ¥è¯»è¿™ä¸ªå˜é‡ï¼Œå†…éƒ¨æœ¬èº«çš„ioçº¿ç¨‹ä¼šä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œæ„Ÿè§‰éœ€è¦ä¿è¯è¿™ä¸ªå˜é‡çš„åŸå­æ€§ï¼Ÿ</li>
</ul>
</blockquote>
<table>
<thead>
<tr>
<th>EventLoop::queueInLoop()</th>
<th>EventLoop::doPendingFunctors()ï¼šå¢åŠ æ‰§è¡ŒçŠ¶æ€å­—æ®µ</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230303224111361.png" alt="image-20230303224111361"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230303224204945.png" alt="image-20230303224204945"></td>
</tr>
</tbody>
</table>
<h4 id="EventLoopThreadç±»">EventLoopThreadç±»</h4>
<p>éƒ½è¯´EventLoopæ˜¯<code>one loop per thread</code>ï¼Œå…¶ç§˜å¯†ä¾¿è—åœ¨EventLoopThreadç±»ä¸­ã€‚</p>
<p><strong>å…ˆæ¥çœ‹çœ‹EventLoopThreadç±»ä¸»è¦èŒèƒ½</strong>ï¼š</p>
<ol>
<li>è´Ÿè´£ç®¡ç†<strong>ä¸€ä¸ª</strong>çº¿ç¨‹ï¼›</li>
<li><strong>ä¸€ä¸ª</strong>çº¿ç¨‹å¯¹åº”åˆ›å»º<strong>ä¸€ä¸ª</strong>EventLoopå¯¹è±¡ï¼Œä¸”è°ƒç”¨<code>EventLoop::loop()</code>ã€‚</li>
</ol>
<table>
<thead>
<tr>
<th>EventLoopThreadç±»æˆå‘˜</th>
<th>EventLoopThreadç±»æ„é€ &amp;ææ„å‡½æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230306152734033.png" alt="image-20230306152734033"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230306150450754.png" alt="image-20230306150450754"></td>
</tr>
</tbody>
</table>
<p>EventLoopThreadå‡½æ•°å¾ˆå°‘ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ï¼šæ„é€ &amp;ææ„å‡½æ•°ã€<code>startLoop()</code>ã€<code>threadFunc()</code> å‡½æ•°ã€‚</p>
<h5 id="æ„é€ å‡½æ•°-ææ„å‡½æ•°">æ„é€ å‡½æ•° &amp; ææ„å‡½æ•°</h5>
<ul>
<li>
<p>æ„é€ å‡½æ•°ï¼šå¯ä»¥çœ‹åˆ°ï¼Œ<code>thread_</code>ç»‘å®šäº†<code>EventLoopThread::threadFunc</code>  å‡½æ•°ï¼›</p>
</li>
<li>
<p><strong>ææ„å‡½æ•°</strong>ï¼šå¦‚æœ<code>loop_</code>ä¸ä¸ºnullï¼Œè¯´æ˜çº¿ç¨‹ç»‘å®šçš„EventLoopThreadå¯¹è±¡<code>loop_</code>è¿˜æœªææ„ï¼Œçº¿ç¨‹<code>thread_</code>ä¹Ÿæœªé€€å‡ºï¼š</p>
<ol>
<li>
<p>é¦–å…ˆé€€å‡ºäº‹ä»¶å¾ªç¯ï¼Œloop_-&gt;quit()</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventLoop::quit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®quit_=trueä½¿å¾—loop()å‡½æ•°ï¼šwhile(!quit_)&#123; epoll_wait()..&#125; ï¼Œé€€å‡ºäº‹ä»¶whileå¾ªç¯</span></span><br><span class="line">    quit_ = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// ä½†æ˜¯è¿˜å¯èƒ½å‡ºç°ï¼šåœ¨å…¶å®ƒEventLoopå¯¹è±¡ä¸­ï¼Œè°ƒç”¨äº†å½“å‰EventLoopå¯¹è±¡quit()</span></span><br><span class="line">    <span class="comment">// æ¯”å¦‚ï¼šåœ¨subloop(worker)ä¸­è°ƒç”¨mainloop(IO)çš„quitæ—¶ï¼Œéœ€è¦å”¤é†’mainloop(IO)æ‰§è¡Œå®Œloop()å‡½æ•°ã€‚</span></span><br><span class="line">    <span class="comment">// p.s. ä¸å¤ªç†è§£è¿™ç§æƒ…å†µï¼Œè€Œä¸”æœäº†å…¨é‡ä»£ç ï¼Œä¹Ÿåªæœ‰åœ¨ææ„æ‰ä¼šè°ƒç”¨quit()ï¼Ÿ</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isInLoopThread</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">wakeup</span>(); <span class="comment">// å½“å‰EventLoopå¯¹è±¡è¢«å”¤é†’ï¼Œç”±äºquit_ = trueå½“å‰å¯¹è±¡loopé€€å‡ºã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>çº¿ç¨‹é€€å‡ºï¼šthread_.join()</p>
<p>ä¿è¯çº¿ç¨‹æ‰§è¡Œå®Œï¼Œç„¶åé€€å‡ºã€‚</p>
</li>
</ol>
</li>
</ul>
<h5 id="startLoop-threadFunc">startLoop() &amp; threadFunc()</h5>
<p>startLoop()ç”¨æ¥åˆ›å»ºsub loopå¹¶å¯åŠ¨äº‹ä»¶å¾ªç¯loop()ã€‚</p>
<p>startLoop()æ¯”è¾ƒéš¾ç†è§£çš„æ˜¯å…¶<u>é”é€»è¾‘</u>ï¼Œè¿™é‡Œé¦–å…ˆéœ€è¦æ˜ç™½ï¼š<strong>ä¸ºä»€ä¹ˆloop_è¦ä¸Šé”</strong>ï¼Ÿ</p>
<ol>
<li>åœ¨mainçº¿ç¨‹ä¸­ï¼ˆä¸»é€»è¾‘ï¼‰å¯åŠ¨çº¿ç¨‹æ± TcpServer::start()å‡½æ•°æ—¶ï¼Œ<strong>çº¿ç¨‹æ± EventThreadPoolä¼šåˆ›å»ºNä¸ªEventLoopThreadå¯¹è±¡</strong>ï¼›æ‰€ä»¥ï¼ŒEventLoopThread::startLoop()æ˜¯åœ¨<u>mainçº¿ç¨‹ä¸­</u>è¢«è°ƒç”¨çš„ï¼Œ<strong>ä½†mainçº¿ç¨‹ä¸è´Ÿè´£å…·ä½“çš„ sub loopï¼ˆloop_ï¼‰åˆ›å»ºï¼Œä¼šwaitå…¶å®ƒçº¿ç¨‹å°†sub loopåˆ›å»ºå®Œæˆ</strong>ã€‚</li>
<li>EventLoopThread::startLoop()è¿˜ä¼šå¯åŠ¨<u>ä¸€ä¸ªioçº¿ç¨‹</u>ï¼ˆç»‘å®šäº†<code>threadFunc</code>å‡½æ•°ï¼‰ï¼Œ<strong>ioçº¿ç¨‹ä¼šæ‰§è¡Œ<code>threadFunc</code>å»åˆ›å»ºsub loopï¼ˆloop_ï¼‰ï¼Œé€šçŸ¥mainçº¿ç¨‹</strong>ã€‚</li>
</ol>
<p>å¯çŸ¥ï¼Œ<code>loop_</code>å¯¹ä¸Šè¿°ä¸¤ä¸ªçº¿ç¨‹éƒ½æ˜¯å¯è§çš„ï¼Œéœ€è¦ä¸Šé”ã€‚</p>
<table>
<thead>
<tr>
<th>startLoop()</th>
<th>threadFunc()</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230306165147863.png" alt="image-20230306165147863"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230306164520082.png" alt="image-20230306164520082"></td>
</tr>
</tbody>
</table>
<p>ç»™<code>loop_</code> ä¸Šé”ä»£ç ï¼Œæ˜¯ç»å…¸çš„ï¼šæ¡ä»¶å˜é‡+while{wait}+notifyé€»è¾‘ï¼š</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230306173226883.png" alt="image-20230306173226883"></p>
<ul>
<li>mainçº¿ç¨‹ï¼Œwhileå¾ªç¯+æ¡ä»¶å˜é‡ç­‰å¾…è§£é”ï¼›</li>
<li>io çº¿ç¨‹ï¼Œåˆ›å»ºå®ŒæˆEventLoopå¯¹è±¡åï¼Œä½¿ç”¨notifyå”¤é†’mainçº¿ç¨‹ï¼›</li>
<li>mainçº¿ç¨‹è¿”å›åˆ›å»ºå¥½çš„EventLoopå¯¹è±¡ã€‚</li>
</ul>
<h4 id="TcpConnectionç±»">TcpConnectionç±»</h4>
<p>å¦‚å‰æ‰€è¿°ï¼ŒTcpConnectionç±»èŒèƒ½å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>â€¦</p>
<ol start="3">
<li>Sub-Reactor å‘å…¶åº•å±‚å°è£…çš„epollæ³¨å†Œclientfd ï¼›</li>
<li>åŒæ—¶ï¼Œå¯¹äºæ¯ä¸ªæ–°è¿æ¥ï¼Œå…¶å®æ˜¯é€šè¿‡åˆ†é…ä¸€ä¸ªTcpConnectionç±»å¯¹è±¡å¤„ç†ï¼š
<ol>
<li>
<p><strong>newä¸€ä¸ªChannleå¯¹è±¡å°è£…clientfd</strong>ï¼Œå¹¶<strong>å‘Channleæ³¨å†Œå›è°ƒäº‹ä»¶</strong>ï¼ˆå¯è¯»ã€å¯å†™ã€å¯å…³é—­ã€é”™è¯¯å¤„ç†ï¼‰ï¼›</p>
</li>
<li>
<p>å°è£…åº•å±‚InputBufferå’ŒOutputBufferï¼Œç”¨æ¥è¿›è¡Œ<strong>æ•°æ®æ”¶å‘</strong>ã€‚</p>
</li>
</ol>
</li>
</ol>
</blockquote>
<p>ä¸éš¾å‘ç°ï¼Œ<strong>TcpConnectionç”¨äºsub loopä¸­å¤„ç†æ–°è¿æ¥ï¼Œå¯¹connfdå°è£…ä»¥åŠæ•°æ®æ”¶å‘</strong>ã€‚</p>
<ul>
<li>æ³¨ï¼ŒTcpConnectionç±»ææ„å‡½æ•°ä¸ºç©ºï¼Œå› æ­¤è¿™é‡Œçœç•¥ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>TcpConnectionç±»</th>
<th>TcpConnectionç±»æ„é€ å‡½æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230310205447731.png" alt="image-20230310205447731"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230302172836862.png" alt="image-20230302172836862"></td>
</tr>
</tbody>
</table>
<h5 id="TcpConnectionå¯¹è±¡ä¸Šæ¸¸è°ƒç”¨é“¾">TcpConnectionå¯¹è±¡ä¸Šæ¸¸è°ƒç”¨é“¾</h5>
<p>åœ¨å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼šå¯¹äºæ¯ä¸ªæ–°è¿æ¥ï¼ŒAccpetoråˆ†é…æ–°è¿æ¥ç»™sub loopæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°TcpConnectionå¯¹è±¡ã€‚</p>
<p>é‚£ä¹ˆåœ¨muduoä»£ç ä¸­ï¼Œ<strong>TcpConnectionå¯¹è±¡ç”Ÿæˆçš„<u>å…·ä½“</u>æ—¶æœºï¼ˆè°ƒç”¨é“¾</strong>ï¼‰ï¼Ÿ</p>
<ul>
<li>
<p><strong>ç”Ÿæˆæ—¶æœº</strong>ï¼šmain loop æœ‰æ–°è¿æ¥ â€”&gt;<code>Acceptor::handleRead</code> ï¼ˆAcceptoråˆå§‹åŒ–æ—¶æ³¨å†Œè¯¥å›è°ƒï¼‰â€”&gt; <code>TcpServer::newConnection</code>ï¼š</p>
</li>
<li>
<p><strong>æ ¸å¿ƒä»£ç ç¤ºä¾‹</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. accepChannel_ä¸Šlistenfdå¯è¯»ï¼ˆepollè¿”å›ï¼‰--&gt;æ‰§è¡ŒreadCallback_--&gt;å³Acceptor::handleRead()</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. Acceptor::handleRead()å¤„ç†æ–°è¿æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Acceptor::handleRead</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    InetAddress peerAddr;</span><br><span class="line">    <span class="comment">// è°ƒç”¨accpet4è¿”å›client_fdï¼ˆconnfd)&amp;ç›¸åº”åœ°å€(peerAddr)</span></span><br><span class="line">    <span class="keyword">int</span> connfd = acceptSocket_.<span class="built_in">accept</span>(&amp;peerAddr);</span><br><span class="line">    <span class="keyword">if</span> (connfd &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (NewConnectionCallback_)</span><br><span class="line">       			<span class="comment">// ç»‘å®šä¸ºï¼šTcpServer::newConnection</span></span><br><span class="line">            <span class="built_in">NewConnectionCallback_</span>(connfd, peerAddr); </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ::<span class="built_in">close</span>(connfd);</span><br><span class="line">    &#125;</span><br><span class="line">  ... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. TcpServer::newConnectionï¼šè½®è¯¢æ‰¾åˆ°subLoop å”¤é†’å¹¶åˆ†å‘å½“å‰çš„æ–°å®¢æˆ·ç«¯çš„Channel</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpServer::newConnection</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> InetAddress &amp;peerAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 3.1 è½®è¯¢ç®—æ³• é€‰æ‹©ä¸€ä¸ªsubLoop æ¥ç®¡ç†connfdå¯¹åº”çš„channel</span></span><br><span class="line">    EventLoop *ioLoop = threadPool_-&gt;<span class="built_in">getNextLoop</span>();</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 3.2 åˆ›å»ºTcpConnectionå¯¹è±¡ï¼</span></span><br><span class="line">    <span class="function">TcpConnectionPtr <span class="title">conn</span><span class="params">(<span class="keyword">new</span> TcpConnection(ioLoop,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            connName,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            sockfd,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            localAddr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            peerAddr))</span></span>;</span><br><span class="line">    connections_[connName] = conn;</span><br><span class="line">    <span class="comment">// 3.3 TcpServer è®¾ç½®å›è°ƒç»™=&gt; TcpConnectionçš„</span></span><br><span class="line">    conn-&gt;<span class="built_in">setConnectionCallback</span>(connectionCallback_);</span><br><span class="line">    conn-&gt;<span class="built_in">setMessageCallback</span>(messageCallback_);</span><br><span class="line">    conn-&gt;<span class="built_in">setWriteCompleteCallback</span>(writeCompleteCallback_);</span><br><span class="line">    conn-&gt;<span class="built_in">setCloseCallback</span>(std::<span class="built_in">bind</span>(&amp;TcpServer::removeConnection, <span class="keyword">this</span>, std::placeholders::_1));</span><br><span class="line">		<span class="comment">// 3.4 io loopï¼ˆsub loopï¼‰æ‰§è¡Œå›è°ƒconnectEstablished</span></span><br><span class="line">    ioLoop-&gt;<span class="built_in">runInLoop</span>(</span><br><span class="line">        std::<span class="built_in">bind</span>(&amp;TcpConnection::connectEstablished, conn));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="æ„é€ å‡½æ•°ï¼šmuduoä¸­çš„å›è°ƒæ³¨å†Œé“¾">æ„é€ å‡½æ•°ï¼šmuduoä¸­çš„å›è°ƒæ³¨å†Œé“¾</h5>
<p>æ³¨æ„åˆ°ï¼Œ<code>TcpConnection</code>åœ¨æ„é€ å‡½æ•°ä½“å†…è¿˜ç»™å…¶ç»‘å®šçš„<code>channel_</code>æ³¨å†Œäº†å››ä¸ª<u>è¯»</u>ã€<u>å†™</u>ã€<u>å…³é—­</u>ã€<u>é”™è¯¯</u>å›è°ƒã€‚é‚£handleReadã€handleWriteã€handleCloseã€handleErroråˆæ˜¯ä»€ä¹ˆæ—¶å€™è¢«æ³¨å†Œï¼Ÿ</p>
<p>ä¸€å›¾çœ‹æ˜ç™½muduoä¸­<u>Channelç±»å…³é”®å›è°ƒæ³¨å†Œé“¾</u>ï¼š</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230310233710151.png" alt="image-20230310233710151"></p>
<p><code>TcpServer</code> è¿˜æ²¡æ­£å¼ä»‹ç»è¿‡ï¼Œå…¶<strong>ä¸»è¦å°è£…äº†Accpetor &amp; EventThreadPool ï¼Œæ˜¯æä¾›ç»™ç”¨æˆ·çš„æ¥å£ç±»</strong>ã€‚å¦‚:</p>
<ul>
<li>å¯åŠ¨æœåŠ¡å™¨<code>start()</code> æ–¹æ³•ï¼Œå¯åŠ¨çº¿ç¨‹æ± &amp;åˆ›å»ºçº¿ç¨‹&amp;main loopå¼€å¯äº‹ä»¶å¾ªç¯ï¼›</li>
<li>ä¸Šè¿°ç»™ç”¨æˆ·æ³¨å†Œè‡ªå®šä¹‰å›è°ƒçš„<code>TcpServer::setConnectionCallback</code> ã€<code>TcpServer::setMessageCallback</code> ç­‰æ–¹æ³•ã€‚</li>
</ul>
<h5 id="è°ˆè°ˆæ•°æ®æ”¶å‘">è°ˆè°ˆæ•°æ®æ”¶å‘</h5>
<p>å‰é¢æåˆ°TcpConnectionç¬¬äºŒä¸ªèŒèƒ½ï¼šå°è£…åº•å±‚<code>InputBuffer</code>å’Œ<code>OutputBuffer</code>ï¼Œç”¨æ¥è¿›è¡Œ<strong>æ•°æ®æ”¶å‘</strong>ã€‚</p>
<p>æ‰€è°“<code>InputBuffer</code>å’Œ<code>OutputBuffer</code>éƒ½æ˜¯<code>Buff</code>ç±»å¯¹è±¡ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line">Buffer inputBuffer_;    <span class="comment">// æ¥æ”¶æ•°æ®çš„ç¼“å†²åŒº</span></span><br><span class="line">Buffer outputBuffer_;   <span class="comment">// å‘é€æ•°æ®çš„ç¼“å†²åŒºï¼Œç”¨æˆ·å‘outputBuffer_å‘</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹ä¸€èŠ‚æˆ‘ä»¬è¿›è¡Œå…·ä½“ä»‹ç»ã€‚</p>
<h4 id="Buffç±»">Buffç±»</h4>
<p>Bufferç±»å°è£…äº†ä¸€ä¸ªvectoræ•°ç»„ï¼Œä»¥åŠå‘è¿™ä¸ªç¼“å†²åŒºæ•°ç»„è¯»ã€å†™æ•°æ®ç­‰ä¸€ç³»åˆ—æ§åˆ¶æ–¹æ³•ã€‚</p>
<h5 id="Buffç±»åº•å±‚æ•°æ®ç»“æ„">Buffç±»åº•å±‚æ•°æ®ç»“æ„</h5>
<p>Buffç±»åº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸ªvectoræ•°ç»„<code>buffer_</code>ï¼Œç»“åˆä¸¤ä¸ªè¯»<code>writerIndex_</code>ã€å†™<code>readerIndex_</code>ç´¢å¼•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="keyword">char</span>&gt; buffer_;</span><br><span class="line"><span class="keyword">size_t</span> readerIndex_; <span class="comment">// æ•°æ®å¼€å§‹è¯»èµ·å§‹ä½ç½®</span></span><br><span class="line"><span class="keyword">size_t</span> writerIndex_; <span class="comment">// æ•°æ®å¼€å§‹å†™èµ·å§‹ä½ç½®</span></span><br></pre></td></tr></table></figure>
<h5 id="Buffç±»å…³é”®å‡½æ•°">Buffç±»å…³é”®å‡½æ•°</h5>
<p>å…³é”®å‡½æ•°ï¼š</p>
<ul>
<li><code>append(const char* data, size_t len)</code>ï¼Œå°†dataæ•°æ®æ·»åŠ åˆ°ç¼“å†²åŒºä¸­ï¼›</li>
<li><code>retrieveAllString()</code>ï¼Œè·å–ç¼“å†²åŒºæ‰€æœ‰æ•°æ®ï¼Œå¹¶ä»¥stringè¿”å›ï¼›</li>
<li><code>ensureWritableByts(size_t len)</code>ï¼Œå½“ä½ æ‰“ç®—å‘ç¼“å†²åŒºå†™å…¥é•¿åº¦ä¸ºlençš„æ•°æ®ä¹‹å‰ï¼Œå…ˆè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ£€æŸ¥ä½ çš„ç¼“å†²åŒºå¯å†™ç©ºé—´èƒ½ä¸èƒ½è£…ä¸‹é•¿åº¦ä¸ºlençš„æ•°æ®ï¼Œå¦‚æœä¸èƒ½ï¼Œ<strong>å°±åŠ¨æ€æ‰©å®¹</strong>ã€‚</li>
</ul>
<p>ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å°è£…äº†è°ƒç”¨äº†ä¸Šé¢å‡ ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>ssize_t Buffer::readFd(int fd, int* saveErrno)</code>ï¼šå®¢æˆ·ç«¯å‘æ¥æ•°æ®ï¼ŒreadFdä»è¯¥TCPæ¥æ”¶ç¼“å†²åŒºä¸­å°†æ•°æ®è¯»å‡ºæ¥==&gt;Bufferä¸­ï¼›æ“ä½œè¿‡ç¨‹å‚è€ƒä¸Šå›¾ã€‚</li>
<li><code>ssize_t Buffer::writeFd(int fd, int* saveErrno)</code>ï¼šæœåŠ¡ç«¯è¦å‘è¿™æ¡TCPè¿æ¥å‘é€æ•°æ®ï¼Œé€šè¿‡è¯¥æ–¹æ³•å°†Bufferä¸­çš„æ•°æ®æ‹·è´==&gt;åˆ°TCPå‘é€ç¼“å†²åŒºoutputBuffer_ä¸­ï¼›æ“ä½œè¿‡ç¨‹å‚è€ƒä¸Šå›¾ã€‚</li>
</ul>
<p>Buffç±»è¿™é‡Œæµ…æµ…æä¸‹ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç²¾é«“è¦ç»“åˆ<code>TcpConnection::send</code> &amp; <code>TcpConnection::handRead</code> ä¸€èµ·ç†è§£ã€‚åœ¨2.3ã€2.4å¤ç›˜æœ‰è¯¦ç»†åˆ†æã€‚</p>
<h4 id="Channelç±»">Channelç±»</h4>
<p>Channelç±»ä¸»è¦æ˜¯å¯¹æè¿°ç¬¦<code>fd</code>å’Œæ„Ÿå…´è¶£çš„äº‹ä»¶<code>events</code>å°è£…ï¼Œä¸€ä¸ªChannelåªå±äºä¸€ä¸ªEventLoopã€‚</p>
<blockquote>
<p><strong>ä¸ºå•¥Channel_ç±»ææ„å‡½æ•°ä¸ºç©ºï¼Ÿä¼¼ä¹å°†æ‰€å°è£…çš„fdç§»é™¤æ³¨å†Œçš„äº‹ä»¶ &amp; ç§»é™¤channelMapæ¯”è¾ƒå¥½</strong>ï¼Ÿ</p>
<p>è¿™éƒ¨åˆ†ä»£ç æ”¾åˆ°EventLoop å’Œ Accpetorææ„å‡½æ•°ï¼Œå¯èƒ½æ˜¯å› ä¸ºï¼šâ‘ ä¸€ä¸ªChannelå±äºä¸€ä¸ªEventLoopï¼›â‘¡Channelçš„ææ„åŠ¨ä½œç”±å…¶æ‰€å±çš„Reactorè´Ÿè´£æ¯”è¾ƒå¥½ï¼Ÿä¿è¯å…ˆææ„Channelï¼Ÿ</p>
</blockquote>
<table>
<thead>
<tr>
<th>Channelç±»æˆå‘˜</th>
<th>Channelç±»æ„é€ å‡½æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/classChannel__inherit__graph.png" alt="classChannel__inherit__graph"></td>
<td><img src="https:/blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307151436660.png" alt="image-20230307151436660"></td>
</tr>
</tbody>
</table>
<p>ç†è§£Channelç±»ï¼Œå…³é”®åœ¨äºç†è§£ï¼š</p>
<ol>
<li>Channelç±»å›è°ƒå‡½æ•°æ˜¯å¦‚ä½•è¢«æ³¨å†Œçš„ï¼Ÿä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿç¬¬1ä¸ªé—®é¢˜å†TcpConnectionç±»ä¸­å·²ä»‹ç»ã€‚</li>
<li><code>tie_</code> &amp; <code>tied</code> å­—æ®µä½œç”¨ï¼Ÿç¬¬2ä¸ªé—®é¢˜åœ¨EventLoopç±»ä¸­ä¹Ÿå·²ä»‹ç»ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h3 id="1-3-2-Main-Reactorï¼šAcceptorã€EventThreadPool">1.3.2 Main Reactorï¼šAcceptorã€EventThreadPool</h3>
<h4 id="Acceptorç±»">Acceptorç±»</h4>
<p>åœ¨å‰é¢ï¼Œæˆ‘ä»¬å·²å¤§è‡´æ¸…æ¥šAcceptorèŒèƒ½ï¼š</p>
<ol>
<li>å°è£…listenfdï¼šåˆå§‹åŒ–æ—¶ä¼šåˆ›å»º<code>acceptChannel_</code>å°è£…listenfdï¼›</li>
<li>å¤„ç†&amp;åˆ†é…æ–°è¿æ¥ï¼šé€šè¿‡<code>acceptChannel_</code>çš„<u>è¯»</u>å›è°ƒï¼ˆå…·ä½“æ˜¯<code>Acceptor::handleRead</code>å‡½æ•°ï¼‰ã€‚</li>
</ol>
<p>æ˜¾ç„¶ï¼ŒAcceptoræœ€é‡è¦çš„å°±æ˜¯<code>Acceptor::handleRead</code> æ–¹æ³•ã€‚</p>
<h5 id="æ„é€ å‡½æ•°å’Œææ„å‡½æ•°">æ„é€ å‡½æ•°å’Œææ„å‡½æ•°</h5>
<table>
<thead>
<tr>
<th>Acceptorç±»æˆå‘˜</th>
<th>Acceptorç±»æ„é€ &amp;ææ„å‡½æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307115631615.png" alt="image-20230307115631615"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307120146153.png" alt="image-20230307120146153"></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p><strong>æ„é€ å‡½æ•°</strong></p>
<p>ä¸»è¦å°±åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>åˆ›å»ºlistenfdâ€“&gt;bind() --&gt; acceptChannelå°è£…listenfdï¼›</li>
<li><strong>è®¾ç½®äº†acceptChannelçš„<u>è¯»</u>å›è°ƒ <code>Acceptor::handleRead</code></strong>  ã€‚</li>
</ol>
</li>
<li>
<p><strong>ææ„å‡½æ•°</strong></p>
<p>ç±»ä¼¼Sub-Reactorï¼ˆsub loopï¼‰ä¼šå°†å…¶ç»‘å®šçš„<code>wakeupChannel_</code>ï¼š</p>
<ol>
<li>æ„Ÿå…´è¶£çš„äº‹ä»¶ç§»é™¤ï¼›</li>
<li>ä»chanenlMapä¸Šç§»é™¤ã€‚</li>
</ol>
<p>Accpetorå…¶ç»‘å®šçš„<code>acceptChanne_</code>ä¹Ÿåšäº†ä¸Šè¿°å¤„ç†ã€‚</p>
</li>
</ul>
<h5 id="Acceptor-handleRead-å‡½æ•°"><code>Acceptor::handleRead</code>  å‡½æ•°</h5>
<p><code>handleRead</code>è¿›è¡Œå¤„ç†&amp;åˆ†é…æ–°è¿æ¥ï¼Œå…·ä½“æ¥è¯´ï¼š</p>
<table>
<thead>
<tr>
<th>Acceptor::handleRead</th>
<th>TcpServer::newConnection</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307154319197.png" alt="image-20230307154319197"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307154740008.png" alt="image-20230307154740008"></td>
</tr>
</tbody>
</table>
<ol>
<li>
<p>æ¥å—æ–°è¿æ¥ï¼›</p>
</li>
<li>
<p>è½®è¯¢ç®—æ³•é€‰æ‹©ä¸€ä¸ªsub loopï¼›</p>
</li>
<li>
<p>new TcpConnectionå¯¹è±¡ç»‘å®šè¯¥sub loopï¼›</p>
</li>
<li>
<p>è®¾ç½®TcpConnectionçš„è¿æ¥ã€è¯»ã€å†™ã€å…³é—­å›è°ƒï¼›</p>
</li>
<li>
<p>sub loopæ‰§è¡Œ<u><em><strong>connectEstablished</strong></em></u>å›è°ƒï¼šâ‘ è®¾ç½®<code>tie</code> ï¼ˆæ·±å…¥ç†è§£å¯ä»¥å‚è€ƒï¼‰â‘¡<code>acceptChanne_</code>ç»‘å®šçš„listenfdå¼€å§‹listen() â‘¢æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰è¿æ¥å›è°ƒã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpConnection::connectEstablished</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">setState</span>(kConnected);</span><br><span class="line">    <span class="comment">// 1.é˜²æ­¢å½“channelè¢«æ‰‹åŠ¨removeæ‰ channelè¿˜åœ¨æ‰§è¡Œå›è°ƒæ“ä½œ</span></span><br><span class="line">    <span class="comment">// shared_from_this()==æŒ‡å‘å¯¹è±¡thisæŒ‡é’ˆçš„æœ‰æ•ˆshared_ptr</span></span><br><span class="line">    channel_-&gt;<span class="built_in">tie</span>(<span class="built_in">shared_from_this</span>());</span><br><span class="line">    <span class="comment">// 2.å‘polleræ³¨å†Œchannelçš„EPOLLINè¯»äº‹ä»¶</span></span><br><span class="line">    channel_-&gt;<span class="built_in">enableReading</span>(); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.æ–°è¿æ¥å»ºç«‹ï¼šæ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„å›è°ƒ</span></span><br><span class="line">    <span class="comment">// TcpConnection::connectionCallback==EchoServer::onConnection</span></span><br><span class="line">    <span class="built_in">connectionCallback_</span>(<span class="built_in">shared_from_this</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>è‡³æ­¤ï¼ŒAccpetoræ ¸å¿ƒåŠŸèƒ½ä¾¿å·²ç»åˆ†æå®Œæˆã€‚</p>
<h4 id="EventThreadPoolç±»">EventThreadPoolç±»</h4>
<p>åœ¨å‰é¢EventThreadç±»ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬æ›¾ç®€å•æè¿‡EventThreadPoolçš„èŒèƒ½ï¼š</p>
<blockquote>
<p>çº¿ç¨‹æ± EventThreadPoolä¼šåˆ›å»ºNä¸ªEventLoopThreadå¯¹è±¡ ã€‚</p>
</blockquote>
<p>æ›´å…·ä½“ç‚¹ï¼ŒEventThreadPoolç±»ï¼š</p>
<ol>
<li>è´Ÿè´£åœ¨<code>æ„é€ å‡½æ•°</code>ï¼Œåˆå§‹åŒ–main loopã€çº¿ç¨‹æ•°ç­‰å­—æ®µï¼›</li>
<li>è´Ÿè´£åœ¨<code>start()</code>å‡½æ•°ï¼Œåˆ›å»ºNä¸ªEventLoopThreadå¯¹è±¡==&gt;Nä¸ªEventLoopThreadå¯¹è±¡å¯¹åº”<u>å¯åŠ¨</u>Nä¸ª<code>thread_</code>==&gt;Nä¸ª<code>thread_</code>åˆ›å»ºå¯¹åº”åˆ›å»ºNä¸ªEventLoopå¯¹è±¡å¹¶å¼€å¯äº‹ä»¶å¾ªç¯loop()ï¼›</li>
<li>è´Ÿè´£åœ¨<code>getNextLoop()</code>å®ç°sub loopçš„åˆ†å‘ï¼ˆå…·ä½“è°ƒç”¨æ˜¯åœ¨Accpetorï¼‰ï¼›</li>
<li>â€¦</li>
</ol>
<p>éœ€è¦é‡ç‚¹å…³æ³¨çš„ä¾¿æ˜¯ <code>start()</code>åˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡é€»è¾‘ ã€‚</p>
<h5 id="æ„é€ å‡½æ•°-ææ„å‡½æ•°-2">æ„é€ å‡½æ•°&amp;ææ„å‡½æ•°</h5>
<table>
<thead>
<tr>
<th>EventLoopThreadPoolç±»æˆå‘˜</th>
<th>EventLoopThreadPoolç±»æ„é€ &amp;ææ„å‡½æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230306152031494.png" alt="image-20230306152031494"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307161953501.png" alt="image-20230307161953501"></td>
</tr>
</tbody>
</table>
<h5 id="start-å‡½æ•°"><code>start()</code> å‡½æ•°</h5>
<p>ä¸»è¦æµç¨‹ï¼š</p>
<ol>
<li>å¾ªç¯åˆ›å»ºNä¸ªEventLoopThreadå¯¹è±¡ï¼Œä¿å­˜åœ¨<code>threads_</code>ï¼Œå¯¹äºè¿™Nä¸ªå¯¹è±¡ï¼›</li>
<li>æ¯ä¸ªEventLoopThreadå¯¹è±¡æ‰§è¡Œ<code>startLoop()</code>ï¼Œå¹¶å¯åŠ¨åº•å±‚çš„<code>thread_</code>çº¿ç¨‹ï¼›</li>
<li><code>thread_</code>çº¿ç¨‹ï¼Œ <strong>åˆ›å»ºEventLoopå¯¹è±¡å¹¶å¯åŠ¨loop()äº‹ä»¶å¾ªç¯</strong> ã€‚</li>
</ol>
<p>å¯è§ï¼Œæ¯ä¸ªEventLoopThreadå¯¹è±¡ï¼ˆåº•å±‚æ˜¯<code>thread_</code>çº¿ç¨‹ï¼‰éƒ½ä¼šåˆ›å»ºä¸€ä¸ªEventLoopå¯¹è±¡ã€‚ä¹Ÿå³æ˜¯<code> one loop per thread</code>çš„ç§˜å¯†æ‰€åœ¨ã€‚</p>
<blockquote>
<p><code>startLoop()</code>&amp;<code>threadFunc()</code>ï¼Œåœ¨EventLoopThreadå·²è¯¦ç»†åˆ†æï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
</blockquote>
<table>
<thead>
<tr>
<th>EventThreadPool::start()&amp;startLoop()</th>
<th>EventLoopThread::threadFunc()</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307171136801.png" alt="image-20230307171136801"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230306165147863.png" alt="image-20230306165147863"></td>
</tr>
<tr>
<td></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230306164520082.png" alt="image-20230306164520082"></td>
</tr>
</tbody>
</table>
<p>Muduoçš„â€œå„ä¸ªâ€æ ¸å¿ƒç±»è‡³æ­¤ä¾¿ä»‹ç»å®Œæˆï¼Œæˆ‘ä»¬å†æ¥â€œæ•´ä½“â€ä¸²è”æ•´ä¸ªmuduoä»£ç ã€‚</p>
<h1>äºŒã€ ä»ä¸‰ä¸ªåŠäº‹ä»¶å¤„ç†å†çœ‹Muduo</h1>
<p>muduoä½œè€…chengshuoè¯´è¿‡ï¼ŒTCPç½‘ç»œç¼–ç¨‹æœ€æœ¬è´¨çš„æ˜¯å¤„ç†ä¸‰ä¸ªåŠäº‹ä»¶ï¼š</p>
<ol>
<li><strong>è¿æ¥å»ºç«‹</strong>ï¼šåŒ…æ‹¬æœåŠ¡å™¨ç«¯è¢«åŠ¨æ¥å—è¿æ¥ï¼ˆacceptï¼‰å’Œå®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¿æ¥ï¼ˆconnectï¼‰ï¼ŒTCPè¿æ¥ä¸€æ—¦å»ºç«‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å°±æ˜¯å¹³ç­‰çš„ï¼Œå¯ä»¥å„è‡ªæ”¶å‘æ•°æ®ï¼›</li>
<li><strong>æ¶ˆæ¯åˆ°è¾¾</strong>ï¼šå³æ–‡ä»¶æè¿°ç¬¦å¯è¯»ï¼Œè¿™æ˜¯æœ€ä¸ºé‡è¦çš„ä¸€ä¸ªäº‹ä»¶ï¼Œå¯¹å®ƒçš„å¤„ç†æ–¹å¼å†³å®šäº†ç½‘ç»œç¼–ç¨‹çš„é£æ ¼ï¼ˆé˜»å¡è¿˜æ˜¯éé˜»å¡ï¼Œå¦‚ä½•å¤„ç†åˆ†åŒ…ï¼Œåº”ç”¨å±‚çš„ç¼“å†²å¦‚ä½•è®¾è®¡ç­‰ç­‰ï¼‰ï¼›</li>
<li><strong>æ¶ˆæ¯å‘é€å®Œæ¯•ï¼ˆåŠä¸ª</strong>ï¼‰ï¼šå¯¹äºä½æµé‡çš„æœåŠ¡ï¼Œå¯ä¸å¿…å…³å¿ƒè¿™ä¸ªäº‹ä»¶ï¼›å¦å¤–ï¼Œè¿™é‡Œçš„â€œå‘é€å®Œæ¯•â€æ˜¯æŒ‡æ•°æ®å†™å…¥æ“ä½œç³»ç»Ÿç¼“å†²åŒºï¼ˆå†…æ ¸ç¼“å†²åŒºï¼‰ï¼Œå°†ç”±TCPåè®®æ ˆè´Ÿè´£æ•°æ®çš„å‘é€ä¸é‡ä¼ ï¼Œ<u>ä¸ä»£è¡¨å¯¹æ–¹å·²ç»æ¥æ”¶åˆ°æ•°æ®</u>ï¼›</li>
<li><strong>è¿æ¥æ–­å¼€</strong>ï¼šåŒ…æ‹¬ä¸»åŠ¨æ–­å¼€ï¼ˆcloseã€shutdownï¼‰å’Œè¢«åŠ¨æ–­å¼€ï¼ˆread()è¿”å›0ï¼‰ã€‚</li>
</ol>
<p>ç»“åˆmuduoä»£ç ï¼Œæˆ‘ä»¬æ¥æ·±åˆ»çš„å…¨é¢ç†è§£ã€‚</p>
<h2 id="2-1-è¿æ¥å»ºç«‹">2.1 è¿æ¥å»ºç«‹</h2>
<h3 id="2-1-1-é—®é¢˜å¼•å…¥">2.1.1 é—®é¢˜å¼•å…¥</h3>
<p><strong>å¯¹äºMuduoè¿™ä¹ˆä¸€ä¸ªåŸºäºMulti-Reatoræ¨¡å‹çš„ç½‘ç»œåº“ï¼Œè¿æ¥çš„å»ºç«‹ï¼ˆæˆ–è€…è¯´åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨ï¼‰æ˜¯å¦‚ä½•å®Œæˆçš„</strong>ï¼Ÿ</p>
<p>åœ¨å‰é¢tcpserver.ccç¤ºä¾‹ï¼Œå…¶å®å·²ç»åšäº†éå¸¸å¥½çš„ç¤ºä¾‹ã€‚ä½†è¿™ä»…ä»…æ˜¯ä¸šåŠ¡å±‚é¢çš„è°ƒç”¨ï¼Œåº•å±‚åˆæ˜¯å¦‚ä½•å®Œæˆçš„ï¼Ÿ</p>
<p>å…¶å®å‰é¢çš„æ ¸å¿ƒç±»åˆ†æï¼ŒåŸºæœ¬å·²ç»æ­æ™“äº†ç­”æ¡ˆã€‚ç°åœ¨æˆ‘ä»¬å°†å„ä¸ªâ€œå­å›¾å—â€å®Œæ•´â€œæ‹¼æ¥â€èµ·æ¥ã€‚</p>
<h3 id="2-2-2-ä»â€œå¤è¯»æœºæœåŠ¡å™¨â€å†çœ‹è¿æ¥å»ºç«‹">2.2.2 ä»â€œå¤è¯»æœºæœåŠ¡å™¨â€å†çœ‹è¿æ¥å»ºç«‹</h3>
<h4 id="EchoServer-TcpServerä½œç”¨">EchoServer&amp;TcpServerä½œç”¨</h4>
<p>EchoServer&amp;TcpServeråœ¨tcpserver.ccè¢«ä½¿ç”¨ï¼Œè¿™é‡Œå…ˆç®€å•ä»‹ç»ï¼š</p>
<ul>
<li>
<p><strong>EchoServer</strong>ï¼Œæ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»ï¼Œä¸»è¦æ˜¯<strong>å°è£…äº†TcpServerå¯¹è±¡<code>server_</code> &amp; è‡ªå®šä¹‰è¿æ¥ã€å¯è¯»äº‹ä»¶å›è°ƒ</strong>ï¼›</p>
</li>
<li>
<p><strong>TcpServer</strong>ï¼Œå¦‚å‰ä»‹ç»ï¼Œå®ƒä¸»è¦<strong>å°è£…äº†Accpetor &amp; EventThreadPool ï¼Œæ˜¯æä¾›ç»™ç”¨æˆ·çš„æ¥å£ç±»</strong>ã€‚å¦‚:</p>
<ul>
<li>å¯åŠ¨æœåŠ¡å™¨<code>start()</code> æ–¹æ³•ï¼Œå¯åŠ¨çº¿ç¨‹æ± &amp;åˆ›å»ºçº¿ç¨‹&amp;main loopå¼€å¯äº‹ä»¶å¾ªç¯ï¼›</li>
<li>ä¸Šè¿°ç»™ç”¨æˆ·æ³¨å†Œè‡ªå®šä¹‰å›è°ƒçš„<code>TcpServer::setConnectionCallback</code> ã€<code>TcpServer::setMessageCallback</code> ç­‰æ–¹æ³•ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>TcpServerç±»æˆå‘˜</th>
<th>TcpServeræ„é€ å‡½æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307191431104.png" alt="image-20230307191431104"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307191524707.png" alt="image-20230307191524707"></td>
</tr>
</tbody>
</table>
</li>
</ul>
<h4 id="è¿æ¥å»ºç«‹æµç¨‹">è¿æ¥å»ºç«‹æµç¨‹</h4>
<p>å›å¿†ä¸€ä¸‹tcpserver.ccä¸»è¦é€»è¾‘ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoServer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="comment">// ...çœç•¥</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1.ç”¨æˆ·è‡ªå®šä¹‰çš„loopä½œä¸ºmain loop</span></span><br><span class="line">    EventLoop loop;</span><br><span class="line">    <span class="comment">// 2. å¯¹socketç¼–ç¨‹ä¸­çš„sockaddr_inè¿›è¡Œå°è£…</span></span><br><span class="line">    <span class="function">InetAddress <span class="title">addr</span><span class="params">(<span class="number">8002</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 3.EchoServeråˆå§‹åŒ–</span></span><br><span class="line">    <span class="function">EchoServer <span class="title">server</span><span class="params">(&amp;loop, addr, <span class="string">&quot;EchoServer&quot;</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 4.å¯åŠ¨æœåŠ¡å™¨server</span></span><br><span class="line">    server.<span class="built_in">start</span>();</span><br><span class="line">    <span class="comment">// 5.å¼€å¯main loopäº‹ä»¶å¾ªç¯ï¼šepoll_waitç­‰å¾…listenfdçš„accpetè¿æ¥äº‹ä»¶</span></span><br><span class="line">    loop.<span class="built_in">loop</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p><strong>ç”¨æˆ·è‡ªå®šä¹‰main loop</strong>ï¼Œç”¨äºå’Œåé¢Accpetorå¯¹è±¡ç»‘å®šï¼›</p>
</li>
<li>
<p><strong>å°è£…è¦ç›‘å¬çš„ip&amp;port</strong>ï¼Œä½¿ç”¨InetAddresså°è£…ï¼›</p>
</li>
<li>
<p><strong>EchoServeråˆå§‹åŒ–</strong>ï¼Œä¸»è¦å®Œæˆï¼š</p>
<ul>
<li>
<p>loop_å­—æ®µç»‘å®šå‰é¢åˆ›å»ºçš„main loopï¼›</p>
</li>
<li>
<p><strong>TcpServerå¯¹è±¡server_åˆå§‹åŒ–</strong>ï¼Œå‚è€ƒä¸Šå›¾TcpServeræ„é€ å‡½æ•°ï¼š</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307193308123.png" alt="image-20230307193308123"></p>
<ul>
<li>loop_å­—æ®µEchoServerä¼ è¿‡æ¥çš„main loopï¼›</li>
<li><strong>Acceptorå¯¹è±¡accpetor_åˆå§‹åŒ–</strong>ï¼›</li>
<li><strong>EventThreadPoolå¯¹è±¡threadpoll_åˆå§‹åŒ–</strong>ï¼›</li>
<li><strong>è®¾ç½®accpetor_æ–°è¿æ¥æ—¶çš„å›è°ƒå‡½æ•°ï¼ˆå³<code>TcpServer::newConnnection</code>ï¼Œæ˜¯<code>Accepetor::handleRead</code>å‡½æ•°æ ¸å¿ƒé€»è¾‘</strong>ï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>å¯åŠ¨æœåŠ¡å™¨server</strong>ï¼ŒçœŸæ­£è°ƒç”¨çš„æ˜¯<code>TcpServer::start()</code> å‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpServer::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (started_++ == <span class="number">0</span>)    <span class="comment">// é˜²æ­¢ä¸€ä¸ªTcpServerå¯¹è±¡è¢«startå¤šæ¬¡</span></span><br><span class="line">    &#123;</span><br><span class="line">        threadPool_-&gt;<span class="built_in">start</span>(threadInitCallback_);    <span class="comment">// å¯åŠ¨åº•å±‚çš„loopçº¿ç¨‹æ± </span></span><br><span class="line">        <span class="comment">// main_loop æ‰§è¡ŒAcceptor::listen</span></span><br><span class="line">        loop_-&gt;<span class="built_in">runInLoop</span>(std::<span class="built_in">bind</span>(&amp;Acceptor::listen, acceptor_.<span class="built_in">get</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>çº¿ç¨‹æ± å¯åŠ¨</strong>ï¼Œå³å‰æ‰€è¿°çš„EventThreadPool::start()å‡½æ•° ï¼š</p>
<ol>
<li>å¾ªç¯åˆ›å»ºNä¸ªEventLoopThreadå¯¹è±¡ï¼Œä¿å­˜åœ¨<code>threads_</code>ï¼Œå¯¹äºè¿™Nä¸ªå¯¹è±¡ï¼š</li>
<li>æ¯ä¸ªEventLoopThreadå¯¹è±¡æ‰§è¡ŒstartLoop()ï¼Œå¹¶å¯åŠ¨åº•å±‚çš„<code>thread_</code>çº¿ç¨‹ï¼›</li>
<li><code>thread_</code>çº¿ç¨‹ï¼Œ <strong>åˆ›å»ºsub loopå¹¶å¯åŠ¨loop()äº‹ä»¶å¾ªç¯ï¼Œç›‘å¬clientfdçš„ioäº‹ä»¶</strong> ã€‚</li>
</ol>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230307194100456.png" alt="image-20230307194100456"></p>
</li>
<li>
<p><strong>main loopçš„listenfdå¼€å§‹<code>listen() </code>&amp; æ³¨å†Œåˆ°epoll</strong>ï¼Œlistenfdå¼€å¯listen() ï¼Œå¹¶åœ¨<em>enableReading()</em> å‡½æ•°ä¸­å°†listenfdçš„ioäº‹ä»¶æ³¨å†Œåˆ°epollã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loop_-&gt;<span class="built_in">runInLoop</span>(std::<span class="built_in">bind</span>(&amp;Acceptor::listen, acceptor_.<span class="built_in">get</span>()));</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Acceptor::listen</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    listenning_ = <span class="literal">true</span>;</span><br><span class="line">    acceptSocket_.<span class="built_in">listen</span>();         <span class="comment">// listen</span></span><br><span class="line">    acceptChannel_.<span class="built_in">enableReading</span>(); <span class="comment">// acceptChannel_ç»‘å®šfdå¹¶æ³¨å†Œè‡³mian loopçš„åº•å±‚epoll</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p><strong>main loopå¯åŠ¨äº‹ä»¶å¾ªç¯</strong>ï¼Œepoll_wait<strong>ç›‘å¬listenfdçš„accpetè¿æ¥äº‹ä»¶</strong> ã€‚</p>
</li>
</ol>
<h2 id="2-2-è¿æ¥æ–­å¼€">2.2 è¿æ¥æ–­å¼€</h2>
<h3 id="2-2-1-é—®é¢˜å¼•å…¥">2.2.1 é—®é¢˜å¼•å…¥</h3>
<p>åœ¨å¤„ç†è¿æ¥æ–­å¼€ï¼Œæˆ‘ä»¬å¿…ç„¶è¦é¢å¯¹è¿™ä¹ˆä¸¤ä¸ªçµé­‚å‘é—®ï¼š</p>
<ul>
<li><strong>å¦‚æœæ˜¯è¢«åŠ¨å…³é—­è¿æ¥ï¼šæœåŠ¡ç«¯å¦‚ä½•æ„ŸçŸ¥ï¼Œåº”è¯¥å¤„ç†å“ªäº›é€»è¾‘</strong>ï¼Ÿ</li>
<li><strong>å¦‚æœæ˜¯ä¸»åŠ¨å…³é—­è¿æ¥ï¼šå¦‚ä½•ä¿è¯å¯¹æ–¹å·²ç»æ”¶åˆ°å…¨éƒ¨æ•°æ®</strong>ï¼Ÿ<strong>ç›´æ¥close(fd)è‚¯å®šæ˜¯ä¸è¡Œçš„</strong>ã€‚å› ä¸ºåº”ç”¨å±‚å¾€å¾€æœ‰ç¼“å†²ï¼ˆè¿™åœ¨éé˜»å¡ç½‘ç»œç¼–ç¨‹ä¸­æ˜¯å¿…éœ€çš„ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯å…ˆå‘é€å®Œç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œç„¶åå†æ–­å¼€è¿æ¥ã€‚</li>
</ul>
<h3 id="2-2-2-è¢«åŠ¨å…³é—­è¿æ¥">2.2.2 è¢«åŠ¨å…³é—­è¿æ¥</h3>
<h4 id="å¦‚ä½•æ„ŸçŸ¥ï¼Ÿ"><strong>å¦‚ä½•æ„ŸçŸ¥</strong>ï¼Ÿ</h4>
<p>åœ¨muduoä¸­ï¼š</p>
<ul>
<li>æœåŠ¡ç«¯<code>TcpConnection::handleRead()</code>ä¸­ï¼Œå†…éƒ¨è°ƒç”¨äº†Linuxçš„å‡½æ•°<code>readv()</code>ï¼›</li>
<li>å½“<code>readv()</code>è¿”å›0çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯å°±çŸ¥é“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥äº†ã€‚</li>
</ul>
<h4 id="å¦‚ä½•å¤„ç†ï¼Ÿ">å¦‚ä½•å¤„ç†ï¼Ÿ</h4>
<p>å½“<code>readv()</code>è¿”å›0 ï¼Œä¼šç´§æ¥ç€è°ƒç”¨<code>TcpConnection::handleClose()</code>ï¼Œä¸€å›¾æ˜ç™½åç»­è°ƒç”¨é“¾ï¼š</p>
<p><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/v2-f50b4f7e23b79110f453146163cb000c_r.jpg" alt="img"></p>
<ol>
<li><strong>å°†TcpConnectionçš„channel_ä»Pollerå–æ¶ˆç›‘å¬</strong>ï¼Œå› ä¸ºä¸€ä¸ªTcpConnectionå¯¹åº”ä¸€ä¸ªChannelï¼Œè¿æ¥å…³é—­äº†é¦–è¦æ˜¯å°†channel_ä»Sub-EventLoopçš„epollå–æ¶ˆç›‘å¬ï¼›</li>
<li><strong>æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„connectCallback_å›è°ƒ</strong>ï¼›</li>
<li><strong>åœ¨TcpServer::connections_ç§»é™¤å½“å‰TcpConnectionå¯¹è±¡</strong>ï¼Œç”±äº<code>connections_</code>ï¼ˆä¸€ä¸ªunordered_mapï¼Œè´Ÿè´£ä¿å­˜<code>&lt;KEY:connName,VALUE:TcpConnection&gt;</code> çš„æ˜ å°„ï¼‰åœ¨TcpServerä¸­å®šä¹‰ï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè·³è½¬åˆ°main loopå»æ‰§è¡Œï¼›</li>
<li><strong>æœ€åå°†TcpConnection::channel_ä»åº•å±‚Poller::chanenlMapç§»é™¤</strong>ï¼ŒchanenlMapä¿å­˜<code>&lt;KEY:sockfd,VALUE:Channel&gt;</code> æ˜ å°„ã€‚</li>
</ol>
<h3 id="2-2-3-ä¸»åŠ¨å…³é—­è¿æ¥">2.2.3 ä¸»åŠ¨å…³é—­è¿æ¥</h3>
<h4 id="å¦‚ä½•å®ç°ä¼˜é›…å…³é—­ï¼Ÿ">å¦‚ä½•å®ç°ä¼˜é›…å…³é—­ï¼Ÿ</h4>
<p>åœ¨â€œå¤è¯»æœºâ€æœåŠ¡å™¨ç¤ºä¾‹ä¸­ï¼Œâ€œå¤è¯»â€å®Œå¯ä»¥ä¸»åŠ¨è°ƒç”¨<code>shutdown()</code> å…³é—­è¿æ¥ã€‚è¿™æ˜¯ä¸€ç§â€œä¼˜é›…å…³é—­â€ï¼Œä¿è¯ä¸»åŠ¨å…³é—­æ—¶æ­£åœ¨å‘ç”Ÿçš„æ•°æ®å¯ä»¥å…¨éƒ¨å‘ç”Ÿå®Œï¼š</p>
<ol>
<li>
<p><strong>å¦‚æœè¦ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œå…ˆå…³æœ¬åœ°â€œå†™â€ç«¯</strong></p>
<p>è¿™æ ·muduoä¼šå‘é€ TCP FIN åˆ†èŠ‚ï¼Œå¯¹æ–¹ä¼šè¯»åˆ° 0 å­—èŠ‚ã€‚<strong>æ³¨æ„æ­¤æ—¶muduoä¸æ˜¯è°ƒç”¨<code>close(fd)</code>ï¼Œæ‰€ä»¥ä¸æ˜¯å®Œå…¨å…³é—­</strong>ã€‚</p>
</li>
<li>
<p><strong>ç­‰å¯¹æ–¹å…³é—­ä¹‹åï¼Œå†å…³æœ¬åœ°â€œè¯»â€ç«¯</strong></p>
<ul>
<li>ä¸€èˆ¬æ¥è¯´ï¼Œå¯¹æ–¹é€šå¸¸ä¼šå…³é—­è¿æ¥ï¼Œè¿™æ · muduo ä¼šreadåˆ° 0 å­—èŠ‚ï¼Œç„¶å muduo è°ƒç”¨<code>TcpConnection::handleClose()</code>å–æ¶ˆç›‘å¬&amp;ç§»é™¤<code>channel_</code>&amp;<code>connections_</code>ç§»é™¤å½“å‰TcpConnectionå¯¹è±¡ï¼Œä¸å†æ¥æ”¶å®¢æˆ·ç«¯æ•°æ®ï¼Œå³å…³é—­äº†â€œè¯»ç«¯â€ï¼›</li>
<li><strong>ä¸è¿‡è¿™ç§åšæ³•æœ‰é£é™©</strong>ï¼šä¸‡ä¸€å¯¹æ–¹æ•…æ„ä¸ä¸å…³ï¼Œé‚£ä¹ˆ muduo çš„è¿æ¥å°±ä¸€ç›´åŠå¼€ç€ï¼Œæ¶ˆè€—ç³»ç»Ÿèµ„æºã€‚</li>
</ul>
</li>
</ol>
<p>å®Œæ•´çš„ä»£ç å®ç°ï¼š</p>
<table>
<thead>
<tr>
<th>ç”¨æˆ·è‡ªå®šä¹‰å›è°ƒ</th>
<th>shutdown()å®ç°</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230310222330841.png" alt="image-20230310222330841"></td>
<td><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20230310222254290.png" alt="image-20230310222254290"></td>
</tr>
</tbody>
</table>
<p>ä½†æ˜¯ï¼Œæˆªæ­¢ç›®å‰ä¾æ—§ç–‘äº‘é‡é‡ï¼š</p>
<h5 id="ä»€ä¹ˆæ—¶å€™muduoæ‰ä¼šçœŸæ­£çš„close-fd-å…³é—­è¿æ¥ï¼Ÿ"><strong>ä»€ä¹ˆæ—¶å€™muduoæ‰ä¼šçœŸæ­£çš„close(fd)å…³é—­è¿æ¥</strong>ï¼Ÿ</h5>
<p>ç­”æ¡ˆæ˜¯ï¼š<strong>åœ¨ TcpConnection å¯¹è±¡ææ„çš„æ—¶å€™</strong>ã€‚TcpConnection ä¸å†æŒæœ‰ä¸€ä¸ª Socket å¯¹è±¡ï¼ˆ<code>sockfd_</code>ï¼‰ï¼ŒSocket æ˜¯ä¸€ä¸ª RAII handlerï¼Œå®ƒçš„ææ„å‡½æ•°ä¼š <code>close(sockfd_)</code>ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TcpConnection</span> :</span> noncopyable, <span class="keyword">public</span> std::enable_shared_from_this&lt;TcpConnection&gt;</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    std::unique_ptr&lt;Socket&gt; socket_;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Socket::~<span class="built_in">Socket</span>()</span><br><span class="line">&#123;</span><br><span class="line">    ::<span class="built_in">close</span>(sockfd_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="é‚£ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘TcpConnection-å¯¹è±¡ææ„ï¼Ÿ"><strong>é‚£ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘TcpConnection å¯¹è±¡ææ„</strong>ï¼Ÿ</h5>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæ¯ä¸ªTcpConnection å¯¹è±¡å¼•ç”¨è®¡æ•°è‡³å°‘ä¸º2ï¼Œæœ‰æ–°è¿æ¥æ—¶æ‰§è¡Œ<code>TcpServer::newConnection</code>ï¼š</p>
<ol>
<li>åˆ›å»ºTcpConnection å¯¹è±¡æŒ‡é’ˆ<code>conn</code>æ—¶ï¼Œ è¯¥<code>conn</code> æŒæœ‰å¯¹è±¡ï¼›</li>
<li><code>TcpServer::connections_</code> æŒæœ‰æ‰€æœ‰TcpConnection å¯¹è±¡ã€‚</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpServer::newConnection</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> InetAddress &amp;peerAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// connæŒæœ‰</span></span><br><span class="line">    <span class="function">TcpConnectionPtr <span class="title">conn</span><span class="params">(<span class="keyword">new</span> TcpConnection(ioLoop,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            connName,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            sockfd,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            localAddr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            peerAddr))</span></span>;</span><br><span class="line">    <span class="comment">// connections_æŒæœ‰</span></span><br><span class="line">    connections_[connName] = conn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…³é”®åœ¨äºè®©<code>connections_</code> é‡Šæ”¾æŒæœ‰çš„TcpConnection å¯¹è±¡ï¼Œä»è€Œè§¦å‘TcpConnection å¯¹è±¡ææ„==&gt; Socket å¯¹è±¡å¯¹è±¡ææ„ã€‚</p>
<h5 id="connections-åœ¨ä»€ä¹ˆæ—¶å€™ä¼šé‡Šæ”¾æŒæœ‰çš„TcpConnection-å¯¹è±¡ï¼Ÿ"><strong><code>connections_</code> åœ¨ä»€ä¹ˆæ—¶å€™ä¼šé‡Šæ”¾æŒæœ‰çš„TcpConnection å¯¹è±¡</strong>ï¼Ÿ</h5>
<p>ç­”æ¡ˆæ˜¯åœ¨è§¦å‘<code>TcpServer::removeConnection</code> æ—¶ã€‚<img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com//image-20230310233220594.png" alt="image-20230310233220594"></p>
<p>è€ŒremoveConnectionå‡½æ•°ï¼š</p>
<ol>
<li><code>shutdown()</code>  ï¼Œå…³é—­å†™ç«¯ï¼Œåº•å±‚å“åº”EPOLLHUPï¼Œä¼šè§¦å‘<code>TcpConnection::handleClose()</code>ï¼Œè¿›è€Œè§¦å‘removeConnectionå‡½æ•°ã€‚</li>
<li>readåˆ°0ï¼Œä¹Ÿä¼šè§¦å‘<code>TcpConnection::handleClose()</code>å‡½æ•°ã€‚</li>
</ol>
<p>å¦‚æœ TcpConnection çš„å¼•ç”¨è®¡æ•°é™åˆ°é›¶ï¼Œå®ƒå°±ä¼šææ„äº†ã€‚</p>
<p>å½“<u>æœåŠ¡å™¨ä¸»åŠ¨å…³é—­</u>æ—¶ï¼Œè°ƒç”¨<code>TcpServer::~TcpServer()</code>ææ„å‡½æ•°ï¼Œä¹Ÿä¼š<strong>ææ„æ‰€æœ‰TcpConnectionå¯¹è±¡</strong>ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">TcpServer::~<span class="built_in">TcpServer</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//connectionsç±»å‹ä¸ºstd::unordered_map&lt;std::string, TcpConnectionPtr&gt;;</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;item : connections_)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">TcpConnectionPtr <span class="title">conn</span><span class="params">(item.second)</span></span>;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾æ‰TcpServerä¸­ï¼ˆitem.secondï¼‰ä¿å­˜çš„è¯¥TcpConnectinoå¯¹è±¡çš„æ™ºèƒ½æŒ‡é’ˆ</span></span><br><span class="line">        <span class="comment">// æ­¤æ—¶ï¼Œåªå‰©ä¸‹connè¿˜æŒæœ‰è¿™ä¸ªTcpConnectionå¯¹è±¡ï¼Œå› æ­¤å½“å‰TcpConnectionå¯¹è±¡è¿˜ä¸ä¼šè¢«ææ„</span></span><br><span class="line">        item.second.<span class="built_in">reset</span>(); </span><br><span class="line">        conn-&gt;<span class="built_in">getLoop</span>()-&gt;<span class="built_in">runInLoop</span>(<span class="built_in">bind</span>(&amp;TcpConnection::connectDestroyed, conn));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>TcpConnection::connectDestroyed</code> å³å°†æ‰€ç®¡ç†çš„channel_åœ¨chanenlMapç§»é™¤ã€‚</p>
<h5 id="ç–‘é—®">ç–‘é—®</h5>
<blockquote>
<p><strong>ä¸ºä»€ä¹ˆè¿™é‡Œä¸æ‰§è¡Œ<code>disableAll()</code> ? ä¸å…ˆå–æ¶ˆäº‹ä»¶ç›‘å¬</strong>ï¼Ÿ</p>
<p>è§‚å¯Ÿåˆ°ï¼Œç›¸æ¯”<code>~Accpetor()</code>ææ„<code>wakeupChannel_ </code>è¿˜æ˜¯å‰é¢<code>è¢«åŠ¨å…³é—­è¿æ¥</code>ææ„<code>channel_</code> è¿˜ä¼šå…ˆæ‰§è¡Œ<code>disableAll()</code>ï¼Œå°†channel_ä»sub EventLoopçš„epollå–æ¶ˆç›‘å¬ã€‚</p>
</blockquote>
<h4 id="å¦‚ä½•ä¿è¯ä¸»åŠ¨å…³é—­æ—¶æ­£åœ¨å‘ç”Ÿçš„æ•°æ®å¯ä»¥å…¨éƒ¨å‘ç”Ÿå®Œï¼Ÿ">å¦‚ä½•ä¿è¯ä¸»åŠ¨å…³é—­æ—¶æ­£åœ¨å‘ç”Ÿçš„æ•°æ®å¯ä»¥å…¨éƒ¨å‘ç”Ÿå®Œï¼Ÿ</h4>
<p>æˆ‘ä»¬éœ€è¦<code>tie</code>ï¼šä¿è¯<strong>å…ˆè®©Channelå›è°ƒå‡½æ•°å…ˆæŠŠæ•°æ®å‘é€å®Œï¼Œå†é‡Šæ”¾TcpConnectionå¯¹è±¡çš„èµ„æº</strong>ã€‚</p>
<p>å‚è€ƒå‰ï¼š1.3.1å…¶ä¸­å°èŠ‚â€”<code>tie</code>æ·±å…¥ç†è§£ã€‚</p>
<h2 id="2-3-æ¶ˆæ¯åˆ°è¾¾">2.3 æ¶ˆæ¯åˆ°è¾¾</h2>
<h3 id="2-3-1-é—®é¢˜å¼•å…¥">2.3.1 é—®é¢˜å¼•å…¥</h3>
<h4 id="ä¸ºä»€ä¹ˆè¦åº”ç”¨å±‚æ¥æ”¶ç¼“å†²åŒºï¼Ÿ">ä¸ºä»€ä¹ˆè¦åº”ç”¨å±‚æ¥æ”¶ç¼“å†²åŒºï¼Ÿ</h4>
<p>æ¶ˆæ¯åˆ°è¾¾æ˜¯æœ€é‡è¦çš„äº‹ä»¶ï¼Œå¯¹å®ƒçš„å¤„ç†å†³å®šäº†ç½‘ç»œç¼–ç¨‹çš„é£æ ¼ï¼šâ‘ æ˜¯é˜»å¡è¿˜æ˜¯éé˜»å¡ï¼›â‘¡åˆ†åŒ…çš„å¤„ç†ï¼›â‘¢åº”ç”¨å±‚çš„ç¼“å†²å¦‚ä½•è®¾è®¡ç­‰ç­‰ã€‚</p>
<p><strong>åœ¨éé˜»å¡ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨åº”ç”¨å±‚æ¥æ”¶ç¼“å†²åŒº</strong>ï¼Ÿ</p>
<p>å‡å¦‚ä¸€æ¬¡è¯»åˆ°çš„æ•°æ®ä¸å¤Ÿ<u>ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…</u>ï¼Œä¹Ÿå°±æ˜¯<strong>éœ€è¦åˆ†åŒ…å»åŒºåˆ†ä¸€ä¸ªä¸ªæ¶ˆæ¯</strong>ï¼šå·²ç»è¯»åˆ°çš„æ•°æ®åº”è¯¥å…ˆæš‚å­˜åœ¨æŸä¸ªåœ°æ–¹ï¼Œç­‰å‰©ä½™çš„æ•°æ®æ”¶åˆ°ä¹‹åå†ä¸€å¹¶å¤„ç†ï¼›</p>
<blockquote>
<p>å¸¸è§çš„åˆ†åŒ…æ–¹æ³•æœ‰ï¼š</p>
<ol>
<li>å›ºå®šé•¿åº¦ï¼›</li>
<li>ç‰¹æ®Šçš„ç»“å°¾ç¬¦ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²çš„\0ï¼Œæˆ–è€…å›è½¦æ¢è¡Œç­‰ï¼›</li>
<li>å›ºå®šçš„æ¶ˆæ¯å¤´ä¸­æŒ‡å®šåç»­çš„æ¶ˆæ¯çš„é•¿åº¦ï¼Œç„¶åè·Ÿä¸Šä¸€ä¸ªæ¶ˆæ¯ä½“å†…å®¹ï¼›</li>
<li>ä½¿ç”¨åè®®æœ¬èº«çš„æ ¼å¼ï¼Œæ¯”å¦‚jsonæ ¼å¼å¤´å°¾é…å¯¹ï¼ˆXMLä¹Ÿä¸€æ ·ï¼‰ã€‚</li>
</ol>
</blockquote>
<p>ä½†æ˜¯ï¼š<strong>ä»ç³»ç»Ÿå†…æ ¸ä¸­è°ƒç”¨çš„æ—¶å€™ï¼Œåœ¨åº”ç”¨å±‚éœ€è¦æœ‰è¶³å¤Ÿå¤§çš„ç¼“å†²åŒºï¼Œæœ€å¥½èƒ½ä¸€æ¬¡å°†ç³»ç»Ÿrecvåˆ°çš„ç¼“å†²åŒºç»™è¯»ç©ºï¼Œä½†è¿™å¯èƒ½æ˜¯ä¸è¡Œçš„ï¼›æ¯æ¬¡é’ˆå¯¹æ¯ä¸ªè¿æ¥ä¸€æ¬¡éƒ½åˆ†é…è¾ƒå¤§çš„ç¼“å†²åŒºï¼Œåˆä¼šæµªè´¹ä¸¥é‡</strong>ã€‚</p>
<p>è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ</p>
<h3 id="2-3-2-muduoæ˜¯å¦‚ä½•åšçš„ï¼ŸTcpConnection-handleRead">2.3.2 muduoæ˜¯å¦‚ä½•åšçš„ï¼ŸTcpConnection::handleRead</h3>
<p>TcpConnection::handleReadçš„æ ¸å¿ƒå‡½æ•°ä¾¿æ˜¯Buffer::readFdã€‚</p>
<blockquote>
<p><code>Buffer</code>å·²ç»æ˜¯è€ç†Ÿäººäº†ï¼š</p>
<ul>
<li><strong>åº•å±‚æ•°æ®ç»“æ„</strong>ï¼šä½¿ç”¨çš„æ˜¯<code>vector::buffer_</code>ï¼Œå¯ä»¥åŠ¨æ€å¢é•¿ ï¼›</li>
<li><strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼š<code>Buffer_.readFd(channel_-&gt;fd(), &amp;saveErrno)</code> ã€‚</li>
</ul>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpConnection::handleRead</span><span class="params">(Timestamp receiveTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> savedErrno = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">ssize_t</span> n = inputBuffer_.<span class="built_in">readFd</span>(channel_-&gt;<span class="built_in">fd</span>(), &amp;savedErrno);</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span>) <span class="comment">// æœ‰æ•°æ®åˆ°è¾¾</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å·²å»ºç«‹è¿æ¥çš„ç”¨æˆ·æœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿäº† è°ƒç”¨ç”¨æˆ·ä¼ å…¥çš„å›è°ƒæ“ä½œonMessage shared_from_thiså°±æ˜¯è·å–äº†TcpConnectionçš„æ™ºèƒ½æŒ‡é’ˆ</span></span><br><span class="line">        <span class="built_in">messageCallback_</span>(<span class="built_in">shared_from_this</span>(), &amp;inputBuffer_, receiveTime);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="comment">// å®¢æˆ·ç«¯æ–­å¼€</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">handleClose</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// å‡ºé”™äº†</span></span><br><span class="line">    &#123;</span><br><span class="line">        errno = savedErrno;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;TcpConnection::handleRead&quot;</span>);</span><br><span class="line">        <span class="built_in">handleError</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>readFdå…³é”®è®¾è®¡</strong>ï¼š</p>
<ol>
<li>è®¾è®¡ä¸¤ä¸ªç¼“å†²åŒºvec[2]ï¼Œvec[1]<strong>æŒ‡å‘Bufferåº•å±‚çš„<code>buffer_</code></strong>ï¼Œvec[2]é¢„åˆ†<strong>64Kä¸´æ—¶ç©ºé—´<code>extrabuf</code></strong>ï¼›</li>
<li>readvçš„æ—¶å€™ï¼Œå¦‚æœç¬¬ä¸€ä¸ªç¼“å†²åŒº&lt;=64kå°±ä½¿ç”¨ä¸¤ä¸ªç¼“å†²åŒºï¼Œå¦åˆ™å°±åªä½¿ç”¨ç¬¬ä¸€ä¸ªç¼“å†²åŒºï¼ˆä¸€èˆ¬ä¸ä¼šè¶…è¿‡64Kï¼Œtcp bufferå¦‚æœç¡®å®è¦è®¾ç½®å¤§çš„ç¼“å­˜åŒºï¼Œéœ€è¦è°ƒæ•´ç³»ç»Ÿå‚æ•°ï¼‰ï¼Œ<strong>è¿™æ ·ä¸€æ¬¡è¯»å–å°±è¶³ä»¥å°†socketä¸­çš„ç¼“å­˜åŒºè¯»ç©º</strong>ï¼›</li>
<li>å¼€å§‹readvï¼Œå°†socketä¸Šæ•°æ®è¯»åˆ°ä¸¤ä¸ªç¼“å†²åŒºï¼›</li>
<li>å¦‚æœç¬¬ä¸€ä¸ªç¼“å†²åŒºå·²æ»¡ï¼Œ<code>buffer_</code> æ‰©å®¹ï¼Œå°†ç¬¬äºŒä¸ªç¼“å†²åŒºæ•°æ®appendåˆ°ç¬¬ä¸€ä¸ªç¼“å†²åŒºï¼›</li>
</ol>
<p>è¿™æ ·ï¼šæ—¢â‘ ä¿è¯ä¸€æ¬¡å°±å¯ä»¥è¯»å®Œsocket ï¼›â‘¡ä¹Ÿé¿å…é¢„ç”³è¯·è¿‡å¤§çš„<code>buffer_</code>ã€‚</p>
<p>å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»fdä¸Šè¯»å–æ•°æ®ï¼ŒPollerå·¥ä½œåœ¨LTæ¨¡å¼</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">Buffer::readFd</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> *saveErrno)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ ˆé¢å¤–ç©ºé—´ï¼Œç”¨äºä»å¥—æ¥å­—å¾€å‡ºè¯»æ—¶ï¼Œå½“buffer_æš‚æ—¶ä¸å¤Ÿç”¨æ—¶æš‚å­˜æ•°æ®ï¼Œå¾…buffer_é‡æ–°åˆ†é…è¶³å¤Ÿç©ºé—´åï¼Œåœ¨æŠŠæ•°æ®äº¤æ¢ç»™buffer_ã€‚</span></span><br><span class="line">    <span class="keyword">char</span> extrabuf[<span class="number">65536</span>] = &#123;<span class="number">0</span>&#125;; <span class="comment">// æ ˆä¸Šå†…å­˜ç©ºé—´ 65536/1024 = 64KB</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    struct iovec &#123;</span></span><br><span class="line"><span class="comment">        ptr_t iov_base; // iov_baseæŒ‡å‘çš„ç¼“å†²åŒºå­˜æ”¾çš„æ˜¯readvæ‰€æ¥æ”¶çš„æ•°æ®æˆ–æ˜¯writevå°†è¦å‘é€çš„æ•°æ®</span></span><br><span class="line"><span class="comment">        size_t iov_len; // iov_lenåœ¨å„ç§æƒ…å†µä¸‹åˆ†åˆ«ç¡®å®šäº†æ¥æ”¶çš„æœ€å¤§é•¿åº¦ä»¥åŠå®é™…å†™å…¥çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨iovecåˆ†é…ä¸¤ä¸ªè¿ç»­çš„ç¼“å†²åŒº</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">vec</span>[2];</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> writable = <span class="built_in">writableBytes</span>(); <span class="comment">// è¿™æ˜¯Bufferåº•å±‚ç¼“å†²åŒºå‰©ä½™çš„å¯å†™ç©ºé—´å¤§å° ä¸ä¸€å®šèƒ½å®Œå…¨å­˜å‚¨ä»fdè¯»å‡ºçš„æ•°æ®</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€å—ç¼“å†²åŒºï¼ŒæŒ‡å‘å¯å†™ç©ºé—´</span></span><br><span class="line">    vec[<span class="number">0</span>].iov_base = <span class="built_in">begin</span>() + writerIndex_;</span><br><span class="line">    vec[<span class="number">0</span>].iov_len = writable;</span><br><span class="line">    <span class="comment">// ç¬¬äºŒå—ç¼“å†²åŒºï¼ŒæŒ‡å‘æ ˆç©ºé—´</span></span><br><span class="line">    vec[<span class="number">1</span>].iov_base = extrabuf;</span><br><span class="line">    vec[<span class="number">1</span>].iov_len = <span class="built_in"><span class="keyword">sizeof</span></span>(extrabuf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œä¹‹æ‰€ä»¥è¯´æœ€å¤š128k-1å­—èŠ‚ï¼Œæ˜¯å› ä¸ºè‹¥writableä¸º64k-1ï¼Œé‚£ä¹ˆéœ€è¦ä¸¤ä¸ªç¼“å†²åŒº ç¬¬ä¸€ä¸ª64k-1 ç¬¬äºŒä¸ª64k æ‰€ä»¥åšå¤š128k-1</span></span><br><span class="line">    <span class="comment">// å¦‚æœç¬¬ä¸€ä¸ªç¼“å†²åŒº&gt;=64k é‚£å°±åªé‡‡ç”¨ä¸€ä¸ªç¼“å†²åŒº è€Œä¸ä½¿ç”¨æ ˆç©ºé—´extrabuf[65536]çš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> iovcnt = (writable &lt; <span class="built_in"><span class="keyword">sizeof</span></span>(extrabuf)) ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">ssize_t</span> n = ::<span class="built_in">readv</span>(fd, vec, iovcnt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *saveErrno = errno;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt;= writable) <span class="comment">// Bufferçš„å¯å†™ç¼“å†²åŒºå·²ç»å¤Ÿå­˜å‚¨è¯»å‡ºæ¥çš„æ•°æ®äº†</span></span><br><span class="line">    &#123;</span><br><span class="line">        writerIndex_ += n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// extrabufé‡Œé¢ä¹Ÿå†™å…¥äº†n-writableé•¿åº¦çš„æ•°æ®</span></span><br><span class="line">    &#123;</span><br><span class="line">        writerIndex_ = buffer_.<span class="built_in">size</span>();</span><br><span class="line">        <span class="built_in">append</span>(extrabuf, n - writable); <span class="comment">// å¯¹buffer_æ‰©å®¹ å¹¶å°†extrabufå­˜å‚¨çš„å¦ä¸€éƒ¨åˆ†æ•°æ®è¿½åŠ è‡³buffer_</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-4-æ¶ˆæ¯å‘é€">2.4 æ¶ˆæ¯å‘é€</h2>
<h3 id="2-4-1-é—®é¢˜å¼•å…¥">2.4.1 é—®é¢˜å¼•å…¥</h3>
<h4 id="ä¸ºä»€ä¹ˆè¦åº”ç”¨å±‚å‘é€ç¼“å†²åŒºï¼Ÿ">ä¸ºä»€ä¹ˆè¦åº”ç”¨å±‚å‘é€ç¼“å†²åŒºï¼Ÿ</h4>
<ul>
<li><strong>TCPå‘é€ç¼“å†²åŒºç©ºé—´ä¸è¶³</strong>ï¼šTCPå‘é€ç¼“å†²åŒºä¼šå‡ºç°ä¸è¶³ï¼›</li>
<li><strong>åº”ç”¨å±‚æ¥æ”¶æ…¢</strong>ï¼šå‘é€æ•°æ®æ—¶ï¼Œåº”ç”¨å±‚å†™çš„å¿«è€Œå†…æ ¸å‘é€æ•°æ®æ…¢ï¼Œéœ€è¦æŠŠå¾…å‘é€æ•°æ®å†™å…¥ç¼“å†²åŒºã€‚</li>
</ul>
<h4 id="TCPå‘é€ç¼“å†²åŒºä¸è¶³å¦‚ä½•å¤„ç†">TCPå‘é€ç¼“å†²åŒºä¸è¶³å¦‚ä½•å¤„ç†?</h4>
<p>å‡è®¾åº”ç”¨ç¨‹åºéœ€è¦å‘é€40kB æ•°æ®ï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿçš„ TCP å‘é€ç¼“å†²åŒºåªæœ‰ 25kB å‰©ä½™ç©ºé—´ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„ 15kBæ•°æ®æ€ä¹ˆåŠï¼Ÿ</p>
<ul>
<li>
<p><strong>å¦‚æœç­‰å¾… OS ç¼“å†²åŒºå¯ç”¨ï¼Œä¼šé˜»å¡å½“å‰çº¿ç¨‹</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‘é€ç¼“å†²åŒºã€‚</p>
</li>
<li>
<p><strong>ä½†æ˜¯ï¼Œå¦‚æœåº”ç”¨ç¨‹åºéšååˆè¦å‘é€ 50kB æ•°æ®ï¼Œä¸èƒ½ç«‹åˆ»å°è¯• write() ï¼Œè¿™æ ·æœ‰å¯èƒ½æ‰“ä¹±æ•°æ®çš„é¡ºåº</strong>ã€‚å¦‚æœå‘é€ç¼“å†²åŒºä¸ä¸ºç©ºï¼Œåº”è¯¥å…ˆwriteåˆ°å‘é€ç¼“å†²åŒºã€‚</p>
<p>è¿™ä¹Ÿæ˜¯muduoçš„åšæ³•ã€‚</p>
</li>
</ul>
<h3 id="2-4-2-muduoæ˜¯å¦‚ä½•åšçš„ï¼šTcpConnetion-send">2.4.2 muduoæ˜¯å¦‚ä½•åšçš„ï¼šTcpConnetion::send</h3>
<p>åœ¨muduoä¸­ï¼Œå½“ç”¨æˆ·è°ƒç”¨äº†<code>TcpConnetion::send(buf)</code>å‡½æ•°æ—¶ï¼š</p>
<ul>
<li><strong>å¦‚æœå‘é€ç¼“å†²åŒºæ²¡æœ‰å¾…å‘é€æ•°æ®</strong>ï¼š
<ul>
<li><strong>å¦‚æœTCPå‘é€ç¼“å†²åŒºèƒ½ä¸€æ¬¡æ€§å®¹çº³buf</strong>ï¼Œè°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„<code>writeCompleteCallback_</code> æ¥ç§»é™¤è¯¥TcpConnectionåœ¨äº‹ä»¶ç›‘å¬å™¨ä¸Šçš„å¯å†™äº‹ä»¶ï¼ˆå› ä¸ºå¤§å¤šæ•°æ—¶å€™æ˜¯æ²¡æœ‰æ•°æ®éœ€è¦å‘é€çš„ï¼Œé¢‘ç¹è§¦å‘å¯å†™äº‹ä»¶ä½†åˆæ²¡æœ‰æ•°æ®å¯å†™ï¼‰ï¼›</li>
<li><strong>å¦‚æœTCPå‘é€ç¼“å†²åŒºä¸èƒ½ä¸€æ¬¡æ€§å®¹çº³buf</strong>ï¼Œåˆ¤æ–­ä¸€ä¸‹errnoæ˜¯ä¸æ˜¯SIGPIPE RESETç­‰è‡´å‘½é”™è¯¯ã€‚</li>
</ul>
</li>
<li><strong>å¦‚æœå‘é€ç¼“å†²åŒºæ²¡æœ‰å¾…å‘é€æ•°æ® &amp;&amp; éè‡´å‘½é”™è¯¯</strong>ï¼š
<ul>
<li>åˆ¤æ–­æ˜¯å¦æ˜¯é«˜æ°´ä½ï¼Œæ‰§è¡Œå›è°ƒ<code>highWaterMarkCallback_</code> ï¼›</li>
<li>ä¸ç›´æ¥writeï¼Œå…ˆå°†æ•°æ®appendåˆ°å‘é€ç¼“å†²åŒºï¼ˆå¦‚æœç¼“å†²åŒºä¸è¶³ä¼šæ‰§è¡Œ<code>makeSpace</code>æ‰©å®¹ï¼‰ï¼›</li>
<li>æ³¨å†Œå½“å‰<code>channel_</code>çš„å†™äº‹ä»¶ï¼Œé€šçŸ¥epollç›‘å¬å¤„ç†ã€‚</li>
</ul>
</li>
</ul>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‘é€æ•°æ® åº”ç”¨å†™çš„å¿« è€Œå†…æ ¸å‘é€æ•°æ®æ…¢ éœ€è¦æŠŠå¾…å‘é€æ•°æ®å†™å…¥ç¼“å†²åŒºï¼Œè€Œä¸”è®¾ç½®äº†æ°´ä½å›è°ƒ</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TcpConnection::sendInLoop</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> nwrote = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> remaining = len;</span><br><span class="line">    <span class="keyword">bool</span> faultError = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (state_ == kDisconnected) <span class="comment">// ä¹‹å‰è°ƒç”¨è¿‡è¯¥connectionçš„shutdown ä¸èƒ½å†è¿›è¡Œå‘é€äº†</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;disconnected, give up writing&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºchannel_ç¬¬ä¸€æ¬¡å¼€å§‹å†™æ•°æ®æˆ–è€…ç¼“å†²åŒºæ²¡æœ‰å¾…å‘é€æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (!channel_-&gt;<span class="built_in">isWriting</span>() &amp;&amp; outputBuffer_.<span class="built_in">readableBytes</span>() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        nwrote = ::<span class="built_in">write</span>(channel_-&gt;<span class="built_in">fd</span>(), data, len);</span><br><span class="line">        <span class="keyword">if</span> (nwrote &gt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            remaining = len - nwrote;</span><br><span class="line">            <span class="keyword">if</span> (remaining == <span class="number">0</span> &amp;&amp; writeCompleteCallback_)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// æ—¢ç„¶åœ¨è¿™é‡Œæ•°æ®å…¨éƒ¨å‘é€å®Œæˆï¼Œå°±ä¸ç”¨å†ç»™channelè®¾ç½®epolloutäº‹ä»¶äº†</span></span><br><span class="line">                loop_-&gt;<span class="built_in">queueInLoop</span>(</span><br><span class="line">                    std::<span class="built_in">bind</span>(writeCompleteCallback_, <span class="built_in">shared_from_this</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">// nwrote &lt; 0</span></span><br><span class="line">        &#123;</span><br><span class="line">            nwrote = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (errno != EWOULDBLOCK) <span class="comment">// EWOULDBLOCKè¡¨ç¤ºéé˜»å¡æƒ…å†µä¸‹æ²¡æœ‰æ•°æ®åçš„æ­£å¸¸è¿”å› ç­‰åŒäºEAGAIN</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;TcpConnection::sendInLoop&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (errno == EPIPE || errno == ECONNRESET) <span class="comment">// SIGPIPE RESET</span></span><br><span class="line">                &#123;</span><br><span class="line">                    faultError = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯´æ˜å½“å‰è¿™ä¸€æ¬¡writeå¹¶æ²¡æœ‰æŠŠæ•°æ®å…¨éƒ¨å‘é€å‡ºå» å‰©ä½™çš„æ•°æ®éœ€è¦ä¿å­˜åˆ°ç¼“å†²åŒºå½“ä¸­</span></span><br><span class="line"><span class="comment">     * ç„¶åç»™channelæ³¨å†ŒEPOLLOUTäº‹ä»¶ï¼ŒPollerå‘ç°tcpçš„å‘é€ç¼“å†²åŒºæœ‰ç©ºé—´åä¼šé€šçŸ¥</span></span><br><span class="line"><span class="comment">     * ç›¸åº”çš„sock-&gt;channelï¼Œè°ƒç”¨channelå¯¹åº”æ³¨å†Œçš„writeCallback_å›è°ƒæ–¹æ³•ï¼Œ</span></span><br><span class="line"><span class="comment">     * channelçš„writeCallback_å®é™…ä¸Šå°±æ˜¯TcpConnectionè®¾ç½®çš„handleWriteå›è°ƒï¼Œ</span></span><br><span class="line"><span class="comment">     * æŠŠå‘é€ç¼“å†²åŒºoutputBuffer_çš„å†…å®¹å…¨éƒ¨å‘é€å®Œæˆ</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">if</span> (!faultError &amp;&amp; remaining &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ç›®å‰å‘é€ç¼“å†²åŒºå‰©ä½™çš„å¾…å‘é€çš„æ•°æ®çš„é•¿åº¦</span></span><br><span class="line">        <span class="keyword">size_t</span> oldLen = outputBuffer_.<span class="built_in">readableBytes</span>();</span><br><span class="line">        <span class="keyword">if</span> (oldLen + remaining &gt;= highWaterMark_ &amp;&amp; oldLen &lt; highWaterMark_ &amp;&amp; highWaterMarkCallback_)</span><br><span class="line">        &#123;</span><br><span class="line">            loop_-&gt;<span class="built_in">queueInLoop</span>(</span><br><span class="line">                std::<span class="built_in">bind</span>(highWaterMarkCallback_, <span class="built_in">shared_from_this</span>(), oldLen + remaining));</span><br><span class="line">        &#125;</span><br><span class="line">        outputBuffer_.<span class="built_in">append</span>((<span class="keyword">char</span> *)data + nwrote, remaining);</span><br><span class="line">        <span class="keyword">if</span> (!channel_-&gt;<span class="built_in">isWriting</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            channel_-&gt;<span class="built_in">enableWriting</span>(); <span class="comment">// è¿™é‡Œä¸€å®šè¦æ³¨å†Œchannelçš„å†™äº‹ä»¶ å¦åˆ™pollerä¸ä¼šç»™channelé€šçŸ¥epollout</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-å…¶å®ƒï¼šLTä¸ET">2.5  å…¶å®ƒï¼šLTä¸ET</h2>
<p>ç»†å¿ƒçš„è¯»è€…å·²ç»æ³¨æ„åˆ°ï¼ŒMuduoä½¿ç”¨çš„æ˜¯LTï¼ˆLever Triggerï¼Œè¾¹ç¼˜è§¦å‘ï¼Œé»˜è®¤æ¨¡å¼ï¼‰è€Œéæ˜¯ETï¼ˆEdge Triggerï¼Œè¾¹ç¼˜è§¦å‘ï¼‰ã€‚</p>
<ul>
<li>ä¸ºä»€ä¹ˆmuduoä½¿ç”¨ETï¼Ÿä¸æ˜¯è¯´ETæ›´å¿«å—ï¼Ÿ</li>
<li>LTä»€ä¹ˆæ—¶å€™å…³æ³¨ EPOLLOUT äº‹ä»¶ï¼Ÿä¼šé€ æˆ busy-loopå—ï¼Ÿmuduoæ˜¯æ€ä¹ˆåšçš„ï¼Ÿ</li>
<li>å¦‚æœä½¿ç”¨ETï¼Œå¦‚ä½•é˜²æ­¢æ¼è¯»é€ æˆçš„é¥¥é¥¿ï¼Ÿ</li>
</ul>
<h3 id="2-5-1-LTä¸ETä»‹ç»">2.5.1 LTä¸ETä»‹ç»</h3>
<p>è¦è®²æ˜ç™½è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥å¤ä¹ LTä¸ETåŸºæœ¬æ¦‚å¿µå’Œè§¦å‘æ¡ä»¶ã€‚</p>
<h4 id="LTä¸ETè§¦å‘æ¡ä»¶">LTä¸ETè§¦å‘æ¡ä»¶</h4>
<p>LTä¸ETä¸¤ç§æ¨¡å¼æœ¬è´¨åŒºåˆ«ï¼š</p>
<ul>
<li>å¯¹äºæ°´å¹³è§¦å‘æ¨¡å¼LTï¼Œä¸€ä¸ªäº‹ä»¶åªè¦æœ‰å°±ä¼šä¸€ç›´è§¦å‘ï¼›</li>
<li>å¯¹äºè¾¹ç¼˜è§¦å‘æ¨¡å¼ETï¼Œåªæœ‰ä¸€ä¸ªäº‹ä»¶ä»æ— åˆ°æœ‰æ‰ä¼šè§¦å‘ã€‚</li>
</ul>
<p>å…·ä½“åˆ°è¯»ã€å†™äº‹ä»¶ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>è¯»äº‹ä»¶è§¦å‘æ¡ä»¶</th>
<th>å†™äº‹ä»¶è§¦å‘æ¡ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>LT</td>
<td>socketæœ‰æ•°æ®ï¼ˆå°±ä¸€ç›´è§¦å‘ï¼‰</td>
<td>socketå¯å†™ï¼ˆå°±ä¸€ç›´è§¦å‘ï¼‰</td>
</tr>
<tr>
<td>ET</td>
<td>socketæœ‰<strong>æ–°</strong>æ•°æ®åˆ°æ¥</td>
<td>socketä¸å¯å†™ =&gt; socketå¯å†™</td>
</tr>
</tbody>
</table>
<p>è¿™å†³å®šLTã€ETåœ¨ç¼–ç¨‹ä¸Šå¯¹äºè¯»ã€å†™äº‹ä»¶çš„ä¸åŒå¤„ç†ã€‚</p>
<h4 id="LTä¸ETç¼–ç¨‹">LTä¸ETç¼–ç¨‹</h4>
<p>å¯¹äºä¸€ä¸ªéé˜»å¡ socketï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>è¯»äº‹ä»¶å¤„ç†</th>
<th>å†™äº‹ä»¶å¤„ç†</th>
</tr>
</thead>
<tbody>
<tr>
<td>LT</td>
<td>æ ¹æ®ä¸šåŠ¡è‡ªè¡Œå†³å®šrecvå¤šå°‘æ•°æ®ï¼Œå°½é‡å¤šè¯»ç‚¹é˜²æ­¢<strong>busy-loop</strong></td>
<td><strong>å¿…é¡»</strong>ï¼šä¸éœ€è¦å†™äº‹ä»¶EPOLLOUTä¸€å®šè¦åŠæ—¶ç§»é™¤ï¼Œé¿å…<strong>busy-loop</strong></td>
</tr>
<tr>
<td>ET</td>
<td><strong>å¿…é¡»</strong>ï¼šå¾ªç¯recvåˆ°é”™è¯¯ç <code>EWOULDBLOCK</code>/<code>EAGAIN</code>ï¼Œ<strong>é˜²æ­¢æ¼è¯»</strong></td>
<td>æ ¹æ®ä¸šåŠ¡è‡ªè¡Œå†³å®šä¸‹æ¬¡æ˜¯å¦è§¦å‘</td>
</tr>
</tbody>
</table>
<p>æ‰€åœ¨ï¼Œå¯¹äºLTæ¨¡å¼ï¼Œæœ€è¦ç´§çš„å°±æ˜¯é˜²æ­¢busy-loopï¼š</p>
<ol>
<li><strong>å¯¹äºå¯è¯»äº‹ä»¶busy-loop</strong>ï¼šmuduoæœ‰æ¥æ”¶ç¼“å†²åŒº+recv(2)ç­–ç•¥ï¼Œèƒ½ä¿è¯æ•°æ®èƒ½è¢«å°½é‡ä¸€æ¬¡è¯»å®Œï¼›</li>
<li><strong>å¯¹äºå¯å†™äº‹ä»¶busy-loop</strong>ï¼šåœ¨muduoçš„<code>TcpConnetion::send(buf)</code>å‡½æ•°æ—¶ï¼Œ<strong>å¦‚æœèƒ½ä¸€æ¬¡å‘é€å®Œ</strong>ï¼Œä¼šé©¬ä¸Šè°ƒç”¨<code>writeCompleteCallback_</code> å›è°ƒå‡½æ•°ï¼Œ<strong>ç§»é™¤å¯å†™äº‹ä»¶ç›‘å¬</strong>ï¼›å¦‚æœä¸èƒ½å‘å®Œï¼Œå¯ä»¥å…ˆæ”¾åˆ°å‘é€ç¼“å†²åŒºã€‚</li>
</ol>
<h3 id="2-5-2-muduoä¸ºä»€ä¹ˆä½¿ç”¨ETï¼Ÿ">2.5.2 muduoä¸ºä»€ä¹ˆä½¿ç”¨ETï¼Ÿ</h3>
<p>muduoä½¿ç”¨æ˜¯LTè€ŒéETï¼Œä¸»è¦åŸå› ï¼š</p>
<ol>
<li>LTè¯»çš„æ—¶å€™åªéœ€è¦ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œè€ŒETå¿…é¡»å¾ªç¯readåˆ°EAGAINé”™è¯¯é€»è¾‘å¤„ç†æ›´å¤æ‚ï¼›</li>
<li>muduoæœ‰åº”ç”¨å±‚ç¼“å†²åŒºï¼Œå¯¹äºå¯è¯»/å¯å†™äº‹ä»¶çš„busy-loopï¼Œå¯ä»¥è¿›è¡Œå¾ˆå¥½çš„é¿å…ã€‚</li>
</ol>
<p>è€Œä¸”ï¼š<strong>ETä¸ä¸€å®šæ¯”LTå¿«</strong> ã€‚</p>
<p>ETæ¨¡å¼ä¸‹ç”¨æˆ·è¦è‡ªè¡Œè¿›è¡Œ read/write å¾ªç¯å¤„ç†ï¼Œè¿™å…¶ä¸­<u>å¢åŠ çš„read/writeç³»ç»Ÿè°ƒç”¨</u>å’Œ<u>å‡å°‘çš„epoll ç³»ç»Ÿè°ƒç”¨</u>ç›¸æ¯”ï¼Œç»¼åˆæ”¶ç›Šå…¶å®ä¸å¤§ã€‚ä¸ºäº†é™ä½å¤„ç†é€»è¾‘å¤æ‚åº¦ï¼Œå¸¸ç”¨çš„äº‹ä»¶å¤„ç†åº“å¤§éƒ¨åˆ†éƒ½é€‰æ‹©äº†LT æ¨¡å¼ï¼ˆå¦‚ libeventã€boost::asioã€muduoç­‰ï¼‰ã€‚</p>
<h1>ä¸‰ã€æ€»ç»“ä¸å±•æœ›</h1>
<h3 id="3-1-æœ¬æ–‡æ€»ç»“">3.1 æœ¬æ–‡æ€»ç»“</h3>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº†ä»¥ä¸‹å†…å®¹ï¼š</p>
<ol>
<li>
<p>é«˜å¹¶å‘IOç½‘ç»œæ¨¡å‹ä»‹ç»ï¼Œä»æœ€ç®€å•çš„å•çº¿ç¨‹ç½‘ç»œIOæ¨¡å‹==&gt;Reactoræ¨¡å¼==&gt;Muduoç½‘ç»œæ¡†æ¶ä»‹ç»ï¼›</p>
</li>
<li>
<p>Muduoå„ä¸ªæ ¸å¿ƒç±»çš„ä»‹ç»ï¼Œå°¤å…¶æ˜¯å¯¹<code>loop()</code> ã€<code>tie</code>ç­‰é‡éš¾ç‚¹è¿›è¡Œäº†ä»‹ç»ï¼›</p>
</li>
<li>
<p>ç»“åˆmuduoæºç ï¼Œæ¥åˆ†æâ€œä¸‰ä¸ªåŠäº‹ä»¶â€çš„æ¯ä¸ªäº‹ä»¶çš„å…³é”®å¤„ç†ï¼Œå¦‚ï¼šmuduoè¿æ¥å»ºç«‹å…¨æµç¨‹ã€è¢«åŠ¨å…³é—­å¦‚ä½•æ„ŸçŸ¥/å¤„ç†ã€ä¸»åŠ¨ä¼˜é›…å…³é—­ã€æ¶ˆæ¯åˆ°è¾¾ä½¿ç”¨ç¼“å†²åŒº+recv(2)å¤„ç†åˆ†åŒ…ã€æ¶ˆæ¯å‘é€ä½¿ç”¨ç¼“å†²åŒºå¤„ç†åº”ç”¨å±‚æ¥æ”¶æ…¢æˆ–TCPå‘é€ç¼“å†²åŒºä¸è¶³ç­‰ï¼›</p>
</li>
<li>
<p>muduoä¸ºä½•ä½¿ç”¨LTç­‰ã€‚</p>
</li>
</ol>
<p>æ€»çš„æ¥è¯´å°½é‡è€ƒè™‘äº†æ•´ä½“è”ç³»å’Œç»†èŠ‚ä¸°æ»¡ã€‚</p>
<h3 id="3-2-æœªæ¥å±•æœ›">3.2 æœªæ¥å±•æœ›</h3>
<p>æœ¬æ–‡é™†é™†ç»­ç»­åœ¨åŠä¸ªæœˆè½ç¬”å®Œæˆï¼Œä¸­é—´ä¿®ä¿®æ”¹æ”¹å¤šæ¬¡ã€‚åœ¨æˆæ–‡çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå­¦ä¹ ã€å·©å›ºåˆ°ä¸å°‘ç½‘ç»œç¼–ç¨‹çŸ¥è¯†ã€‚å¯¹äºç½‘ç»œç¼–ç¨‹å…¥é—¨æ¥è¯´ï¼Œmuduoçš„ç¡®æ˜¯ä¸ªä¸é”™çš„å‚è€ƒã€‚</p>
<p>ä½†é™äºè‡ªèº«æ°´å¹³ï¼Œè‡ªå·±å¯¹muduoä¸­ä¸€äº›è®¾è®¡ç»†èŠ‚è¿˜æ˜¯å­˜åœ¨äº›ç–‘é—®ã€‚æ¯”å¦‚ï¼Œmuduoä»£ç å¤§é‡ä½¿ç”¨äº†æ™ºèƒ½æŒ‡é’ˆå’ŒRAIIç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†å¯¹äºTcpConnection/Eventloop/Socket/â€¦å„ä¸ªå¯¹è±¡åœ¨è¿æ¥å…³é—­/æ•´ä¸ªæœåŠ¡å™¨å…³é—­/â€¦ç­‰å„ç§æƒ…å†µæ ¸å¿ƒè®¾è®¡å¤„ç†ç†å¿µï¼Œç›®å‰ä¾æ—§å­˜åœ¨äº›ç–‘æƒ‘ã€‚è¿™ä¸ªï¼Œç•™åˆ°åé¢å†æ¥è¡¥å…¨å§ï¼</p>
<p>æœ€åï¼Œå¦‚æœæœ¬æ–‡èƒ½ç»™å­¦ä¹ ç½‘ç»œç¼–ç¨‹orç ”ç©¶muduoåº“çš„åŒå­¦å¸¦æ¥å¸®åŠ©ï¼Œé‚£å°±å†å¥½ä¸è¿‡äº†ã€‚æ¬¢è¿åœ¨ä¸‹ç•™è¨€äº¤æµã€‚</p>
<h1>å››ã€æ›´æ–°è®°å½•</h1>
<div class="timeline">
<div class="timenode"><div class="meta"><p><p>2023-03-10ï¼šç¬¬ä¸€æ¬¡æ›´æ–°</p>
</p></div><div class="body"><ol><li>ç¬¬ä¸€æ¬¡æ›´æ–°ä¸Šä¼ ã€‚</li></ol></div></div>
</div>
<h1>äº”ã€å‚è€ƒæ–‡çŒ®</h1>
<div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">é™ˆç¡•.ã€ŠLinuxå¤šçº¿ç¨‹æœåŠ¡ç«¯ç¼–ç¨‹ã€‹<a href="#fnref:1" rev="footnote"> â†©</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">ä¸‡å­—é•¿æ–‡æ¢³ç†Muduoåº“æ ¸å¿ƒä»£ç åŠä¼˜ç§€ç¼–ç¨‹ç»†èŠ‚æ€æƒ³å‰–æï¼šhttps://zhuanlan.zhihu.com/p/495016351<a href="#fnref:2" rev="footnote"> â†©</a></span></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">3.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">Muduo æºç åˆ†æï¼šhttps://youjiali1995.github.io/network/muduo/<a href="#fnref:3" rev="footnote"> â†©</a></span></li><li id="fn:4"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">4.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">IO - Nettyçš„æ¨¡å‹ï¼šhttps://www.cnblogs.com/hlkawa/p/15303013.html<a href="#fnref:4" rev="footnote"> â†©</a></span></li><li id="fn:5"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">5.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">ã€muduoã€‘netç¯‡---TcpConnectionï¼šhttps://blog.csdn.net/daaikuaichuan/article/details/87822822<a href="#fnref:5" rev="footnote"> â†©</a></span></li><li id="fn:6"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">6.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">é«˜å¹¶å‘ä¹‹ç½‘ç»œIOæ¨¡å‹  https://www.cnblogs.com/xiekun/p/16593204.html<a href="#fnref:6" rev="footnote"> â†©</a></span></li></ol></div></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">Wanghui Huang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://hwh.zone/p/37224/">https://hwh.zone/p/37224/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://hwh.zone" target="_blank">royhuang's blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C++</a><a class="post-meta__tags" href="/tags/%E6%95%99%E7%A8%8B/">æ•™ç¨‹</a><a class="post-meta__tags" href="/tags/muduo/">muduo</a></div><div class="post_share"><div class="social-share" data-image="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/about-bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> æ‰“èµ</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/wechatPay.png" target="_blank"><img class="post-qr-code-img" src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/wechatPay.png" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/alipay.png" target="_blank"><img class="post-qr-code-img" src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/alipay.png" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/p/45495/"><img class="prev-cover" src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/about-bg.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">C++ä»é›¶å¼€å§‹ï¼ˆåäºŒï¼‰ï¼šLinuxç³»ç»Ÿç¼–ç¨‹å…¥é—¨</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/p/18652/" title="C++ä»é›¶å¼€å§‹ï¼ˆä¸€ï¼‰ï¼šç¯å¢ƒæ­å»ºï¼ˆä¸Šï¼‰VSCodeè¿œç¨‹å¼€å‘"><img class="cover" src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20211211214212828.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-05</div><div class="title">C++ä»é›¶å¼€å§‹ï¼ˆä¸€ï¼‰ï¼šç¯å¢ƒæ­å»ºï¼ˆä¸Šï¼‰VSCodeè¿œç¨‹å¼€å‘</div></div></a></div><div><a href="/p/17506/" title="C++ä»é›¶å¼€å§‹ï¼ˆä¸ƒï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸Šï¼‰å¿«é€Ÿå…¥é—¨"><img class="cover" src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/about-bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-24</div><div class="title">C++ä»é›¶å¼€å§‹ï¼ˆä¸ƒï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸Šï¼‰å¿«é€Ÿå…¥é—¨</div></div></a></div><div><a href="/p/60158/" title="C++ä»é›¶å¼€å§‹ï¼ˆä¹ï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸‹ï¼‰ç»§æ‰¿å’Œè™šå‡½æ•°"><img class="cover" src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/about-bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-08</div><div class="title">C++ä»é›¶å¼€å§‹ï¼ˆä¹ï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸‹ï¼‰ç»§æ‰¿å’Œè™šå‡½æ•°</div></div></a></div><div><a href="/p/2834/" title="C++ä»é›¶å¼€å§‹ï¼ˆäºŒï¼‰ï¼šç¯å¢ƒæ­å»ºï¼ˆä¸‹ï¼‰g++/Makefile/CMakeå¿«é€Ÿå…¥é—¨"><img class="cover" src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/image-20211211215040434.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-05</div><div class="title">C++ä»é›¶å¼€å§‹ï¼ˆäºŒï¼‰ï¼šç¯å¢ƒæ­å»ºï¼ˆä¸‹ï¼‰g++/Makefile/CMakeå¿«é€Ÿå…¥é—¨</div></div></a></div><div><a href="/p/43924/" title="C++ä»é›¶å¼€å§‹ï¼ˆå…«ï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸­ï¼‰è¿ç®—ç¬¦é‡è½½"><img class="cover" src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/about-bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-27</div><div class="title">C++ä»é›¶å¼€å§‹ï¼ˆå…«ï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸­ï¼‰è¿ç®—ç¬¦é‡è½½</div></div></a></div><div><a href="/p/6587/" title="C++ä»é›¶å¼€å§‹ï¼ˆå…­ï¼‰ï¼šåŠ¡å®åŸºç¡€ï¼ˆä¸‹ï¼‰å¤åˆç±»å‹åŠè½¬æ¢"><img class="cover" src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/about-bg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-16</div><div class="title">C++ä»é›¶å¼€å§‹ï¼ˆå…­ï¼‰ï¼šåŠ¡å®åŸºç¡€ï¼ˆä¸‹ï¼‰å¤åˆç±»å‹åŠè½¬æ¢</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://blog-imgs-1256686095.cos.ap-guangzhou.myqcloud.com/cat.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Wanghui Huang</div><div class="author-info__description">tech & life</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">31</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">43</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">12</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Wanghui-Huang"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Wanghui-Huang" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:hwh199601@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>å…¬å‘Š</span></div><div class="announcement_content">royhuang's studio</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">ä¸€ã€Muduoæ•´ä½“æ¶æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%BB%8EEchoServer%E8%AF%B4%E8%B5%B7"><span class="toc-text">1.1 ä»EchoServerè¯´èµ·</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-text">1.1.1 å¿«é€Ÿå¼€å§‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-%E2%80%9C%E5%A4%8D%E8%AF%BB%E6%9C%BA%E2%80%9C%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%9A%E5%8A%A1%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.1.2 â€œå¤è¯»æœºâ€œæœåŠ¡å™¨ä¸šåŠ¡å±‚å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%EF%BC%9AMulti-Reactor"><span class="toc-text">1.2 æ•´ä½“æ¶æ„ï¼šMulti-Reactor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B9%8B%E7%BD%91%E7%BB%9CIO%E6%A8%A1%E5%9E%8B"><span class="toc-text">1.2.1 é«˜å¹¶å‘ä¹‹ç½‘ç»œIOæ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%BD%91%E7%BB%9C-IO-%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-text">ä¼ ç»Ÿç½‘ç»œ IO æ¨¡å‹çš„ç¼ºé™·</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E4%BC%A0%E7%BB%9F%E7%BD%91%E7%BB%9C-IO-%E6%A8%A1%E5%9E%8B%E7%BC%BA%E9%99%B7%E7%9A%84%E6%94%B9%E8%BF%9B"><span class="toc-text">é’ˆå¯¹ä¼ ç»Ÿç½‘ç»œ IO æ¨¡å‹ç¼ºé™·çš„æ”¹è¿›</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B%EF%BC%9A%E9%81%BF%E5%85%8Dread-write%E9%98%BB%E5%A1%9E"><span class="toc-text">å¤šè¿›ç¨‹&#x2F;çº¿ç¨‹ï¼šé¿å…read&#x2F;writeé˜»å¡</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%EF%BC%9Aselect-poll-epoll"><span class="toc-text">IOå¤šè·¯å¤ç”¨ï¼šselect&#x2F;poll&#x2F;epoll</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Reactor%E6%A8%A1%E5%BC%8F%EF%BC%9A%E7%BB%A7%E7%BB%AD%E4%BC%98%E5%8C%96%E5%A4%9A%E8%B7%AFIO"><span class="toc-text">Reactoræ¨¡å¼ï¼šç»§ç»­ä¼˜åŒ–å¤šè·¯IO</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B-%E5%8D%95Reactor%E6%A8%A1%E5%BC%8F"><span class="toc-text">å•è¿›ç¨‹&#x2F;çº¿ç¨‹&amp;å•Reactoræ¨¡å¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B-%E5%8D%95Reactor%E6%A8%A1%E5%BC%8F"><span class="toc-text">å¤šè¿›ç¨‹&#x2F;çº¿ç¨‹&amp;å•Reactoræ¨¡å¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B-%E5%A4%9AReactor%E6%A8%A1%E5%BC%8F"><span class="toc-text">å¤šè¿›ç¨‹&#x2F;çº¿ç¨‹&amp;å¤šReactoræ¨¡å¼</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-Muduo%E4%B8%8EReactor%E6%A8%A1%E5%BC%8F"><span class="toc-text">1.2.2 Muduoä¸Reactoræ¨¡å¼</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Muduo%E6%A0%B8%E5%BF%83%E7%B1%BB"><span class="toc-text">1.3 Muduoæ ¸å¿ƒç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-Reactor%EF%BC%9APoller%E3%80%81EventLoop%E3%80%81EventLoopThread%E3%80%81TcpConnection%E3%80%81Channel"><span class="toc-text">1.3.1 Reactorï¼šPollerã€EventLoopã€EventLoopThreadã€TcpConnectionã€Channel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Poller%E7%B1%BB-EPollPoller%E7%B1%BB"><span class="toc-text">Pollerç±» &amp; EPollPollerç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EventLoop%E7%B1%BB"><span class="toc-text">EventLoopç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8E%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9C%8B%EF%BC%9AwakeupFd%E8%AE%BE%E8%AE%A1%E4%B8%8Etie%E5%88%9D%E8%AF%86"><span class="toc-text">ä»æ„é€ å‡½æ•°çœ‹ï¼šwakeupFdè®¾è®¡ä¸tieåˆè¯†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="toc-text">ææ„å‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#loop-%E5%87%BD%E6%95%B0"><span class="toc-text">loop() å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Channel-handleEvent%E5%AE%9E%E7%8E%B0"><span class="toc-text">Channel::handleEventå®ç°</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#tie%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3"><span class="toc-text">tieæ·±å…¥ç†è§£</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#doPendingFunctors-%EF%BC%9A%E7%BB%93%E5%90%88runInLoop-%E7%90%86%E8%A7%A3%E5%9B%9E%E8%B0%83%E9%98%9F%E5%88%97%E4%B8%AD%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5"><span class="toc-text">doPendingFunctors() ï¼šç»“åˆrunInLoop()ç†è§£å›è°ƒé˜Ÿåˆ—ä¸­çš„å¤šçº¿ç¨‹åŒæ­¥</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EventLoopThread%E7%B1%BB"><span class="toc-text">EventLoopThreadç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0-%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="toc-text">æ„é€ å‡½æ•° &amp; ææ„å‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#startLoop-threadFunc"><span class="toc-text">startLoop() &amp; threadFunc()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TcpConnection%E7%B1%BB"><span class="toc-text">TcpConnectionç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#TcpConnection%E5%AF%B9%E8%B1%A1%E4%B8%8A%E6%B8%B8%E8%B0%83%E7%94%A8%E9%93%BE"><span class="toc-text">TcpConnectionå¯¹è±¡ä¸Šæ¸¸è°ƒç”¨é“¾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%EF%BC%9Amuduo%E4%B8%AD%E7%9A%84%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C%E9%93%BE"><span class="toc-text">æ„é€ å‡½æ•°ï¼šmuduoä¸­çš„å›è°ƒæ³¨å†Œé“¾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%88%E8%B0%88%E6%95%B0%E6%8D%AE%E6%94%B6%E5%8F%91"><span class="toc-text">è°ˆè°ˆæ•°æ®æ”¶å‘</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Buff%E7%B1%BB"><span class="toc-text">Buffç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Buff%E7%B1%BB%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">Buffç±»åº•å±‚æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Buff%E7%B1%BB%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0"><span class="toc-text">Buffç±»å…³é”®å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Channel%E7%B1%BB"><span class="toc-text">Channelç±»</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-Main-Reactor%EF%BC%9AAcceptor%E3%80%81EventThreadPool"><span class="toc-text">1.3.2 Main Reactorï¼šAcceptorã€EventThreadPool</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Acceptor%E7%B1%BB"><span class="toc-text">Acceptorç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%92%8C%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0"><span class="toc-text">æ„é€ å‡½æ•°å’Œææ„å‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Acceptor-handleRead-%E5%87%BD%E6%95%B0"><span class="toc-text">Acceptor::handleRead  å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EventThreadPool%E7%B1%BB"><span class="toc-text">EventThreadPoolç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0-%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0-2"><span class="toc-text">æ„é€ å‡½æ•°&amp;ææ„å‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#start-%E5%87%BD%E6%95%B0"><span class="toc-text">start() å‡½æ•°</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">äºŒã€ ä»ä¸‰ä¸ªåŠäº‹ä»¶å¤„ç†å†çœ‹Muduo</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B"><span class="toc-text">2.1 è¿æ¥å»ºç«‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-%E9%97%AE%E9%A2%98%E5%BC%95%E5%85%A5"><span class="toc-text">2.1.1 é—®é¢˜å¼•å…¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E4%BB%8E%E2%80%9C%E5%A4%8D%E8%AF%BB%E6%9C%BA%E6%9C%8D%E5%8A%A1%E5%99%A8%E2%80%9D%E5%86%8D%E7%9C%8B%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B"><span class="toc-text">2.2.2 ä»â€œå¤è¯»æœºæœåŠ¡å™¨â€å†çœ‹è¿æ¥å»ºç«‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EchoServer-TcpServer%E4%BD%9C%E7%94%A8"><span class="toc-text">EchoServer&amp;TcpServerä½œç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%E6%B5%81%E7%A8%8B"><span class="toc-text">è¿æ¥å»ºç«‹æµç¨‹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E8%BF%9E%E6%8E%A5%E6%96%AD%E5%BC%80"><span class="toc-text">2.2 è¿æ¥æ–­å¼€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E9%97%AE%E9%A2%98%E5%BC%95%E5%85%A5"><span class="toc-text">2.2.1 é—®é¢˜å¼•å…¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E8%A2%AB%E5%8A%A8%E5%85%B3%E9%97%AD%E8%BF%9E%E6%8E%A5"><span class="toc-text">2.2.2 è¢«åŠ¨å…³é—­è¿æ¥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%84%9F%E7%9F%A5%EF%BC%9F"><span class="toc-text">å¦‚ä½•æ„ŸçŸ¥ï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%EF%BC%9F"><span class="toc-text">å¦‚ä½•å¤„ç†ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E4%B8%BB%E5%8A%A8%E5%85%B3%E9%97%AD%E8%BF%9E%E6%8E%A5"><span class="toc-text">2.2.3 ä¸»åŠ¨å…³é—­è¿æ¥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%BC%98%E9%9B%85%E5%85%B3%E9%97%AD%EF%BC%9F"><span class="toc-text">å¦‚ä½•å®ç°ä¼˜é›…å…³é—­ï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99muduo%E6%89%8D%E4%BC%9A%E7%9C%9F%E6%AD%A3%E7%9A%84close-fd-%E5%85%B3%E9%97%AD%E8%BF%9E%E6%8E%A5%EF%BC%9F"><span class="toc-text">ä»€ä¹ˆæ—¶å€™muduoæ‰ä¼šçœŸæ­£çš„close(fd)å…³é—­è¿æ¥ï¼Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%82%A3%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BC%9A%E8%A7%A6%E5%8F%91TcpConnection-%E5%AF%B9%E8%B1%A1%E6%9E%90%E6%9E%84%EF%BC%9F"><span class="toc-text">é‚£ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘TcpConnection å¯¹è±¡ææ„ï¼Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#connections-%E5%9C%A8%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BC%9A%E9%87%8A%E6%94%BE%E6%8C%81%E6%9C%89%E7%9A%84TcpConnection-%E5%AF%B9%E8%B1%A1%EF%BC%9F"><span class="toc-text">connections_ åœ¨ä»€ä¹ˆæ—¶å€™ä¼šé‡Šæ”¾æŒæœ‰çš„TcpConnection å¯¹è±¡ï¼Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%96%91%E9%97%AE"><span class="toc-text">ç–‘é—®</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%BB%E5%8A%A8%E5%85%B3%E9%97%AD%E6%97%B6%E6%AD%A3%E5%9C%A8%E5%8F%91%E7%94%9F%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8F%AF%E4%BB%A5%E5%85%A8%E9%83%A8%E5%8F%91%E7%94%9F%E5%AE%8C%EF%BC%9F"><span class="toc-text">å¦‚ä½•ä¿è¯ä¸»åŠ¨å…³é—­æ—¶æ­£åœ¨å‘ç”Ÿçš„æ•°æ®å¯ä»¥å…¨éƒ¨å‘ç”Ÿå®Œï¼Ÿ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%B6%88%E6%81%AF%E5%88%B0%E8%BE%BE"><span class="toc-text">2.3 æ¶ˆæ¯åˆ°è¾¾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E9%97%AE%E9%A2%98%E5%BC%95%E5%85%A5"><span class="toc-text">2.3.1 é—®é¢˜å¼•å…¥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BA%94%E7%94%A8%E5%B1%82%E6%8E%A5%E6%94%B6%E7%BC%93%E5%86%B2%E5%8C%BA%EF%BC%9F"><span class="toc-text">ä¸ºä»€ä¹ˆè¦åº”ç”¨å±‚æ¥æ”¶ç¼“å†²åŒºï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-muduo%E6%98%AF%E5%A6%82%E4%BD%95%E5%81%9A%E7%9A%84%EF%BC%9FTcpConnection-handleRead"><span class="toc-text">2.3.2 muduoæ˜¯å¦‚ä½•åšçš„ï¼ŸTcpConnection::handleRead</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81"><span class="toc-text">2.4 æ¶ˆæ¯å‘é€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-%E9%97%AE%E9%A2%98%E5%BC%95%E5%85%A5"><span class="toc-text">2.4.1 é—®é¢˜å¼•å…¥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BA%94%E7%94%A8%E5%B1%82%E5%8F%91%E9%80%81%E7%BC%93%E5%86%B2%E5%8C%BA%EF%BC%9F"><span class="toc-text">ä¸ºä»€ä¹ˆè¦åº”ç”¨å±‚å‘é€ç¼“å†²åŒºï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP%E5%8F%91%E9%80%81%E7%BC%93%E5%86%B2%E5%8C%BA%E4%B8%8D%E8%B6%B3%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86"><span class="toc-text">TCPå‘é€ç¼“å†²åŒºä¸è¶³å¦‚ä½•å¤„ç†?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-muduo%E6%98%AF%E5%A6%82%E4%BD%95%E5%81%9A%E7%9A%84%EF%BC%9ATcpConnetion-send"><span class="toc-text">2.4.2 muduoæ˜¯å¦‚ä½•åšçš„ï¼šTcpConnetion::send</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E5%85%B6%E5%AE%83%EF%BC%9ALT%E4%B8%8EET"><span class="toc-text">2.5  å…¶å®ƒï¼šLTä¸ET</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-1-LT%E4%B8%8EET%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.5.1 LTä¸ETä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LT%E4%B8%8EET%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-text">LTä¸ETè§¦å‘æ¡ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LT%E4%B8%8EET%E7%BC%96%E7%A8%8B"><span class="toc-text">LTä¸ETç¼–ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-2-muduo%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8ET%EF%BC%9F"><span class="toc-text">2.5.2 muduoä¸ºä»€ä¹ˆä½¿ç”¨ETï¼Ÿ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">ä¸‰ã€æ€»ç»“ä¸å±•æœ›</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%9C%AC%E6%96%87%E6%80%BB%E7%BB%93"><span class="toc-text">3.1 æœ¬æ–‡æ€»ç»“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B"><span class="toc-text">3.2 æœªæ¥å±•æœ›</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">å››ã€æ›´æ–°è®°å½•</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">äº”ã€å‚è€ƒæ–‡çŒ®</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/p/37224/" title="C++ä»é›¶å¼€å§‹ï¼ˆå¼€æºï¼‰ï¼šä¸€æ–‡è¯»æ‡‚muduo">C++ä»é›¶å¼€å§‹ï¼ˆå¼€æºï¼‰ï¼šä¸€æ–‡è¯»æ‡‚muduo</a><time datetime="2023-03-11T05:48:01.602Z" title="å‘è¡¨äº 2023-03-11 13:48:01">2023-03-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/p/45495/" title="C++ä»é›¶å¼€å§‹ï¼ˆåäºŒï¼‰ï¼šLinuxç³»ç»Ÿç¼–ç¨‹å…¥é—¨">C++ä»é›¶å¼€å§‹ï¼ˆåäºŒï¼‰ï¼šLinuxç³»ç»Ÿç¼–ç¨‹å…¥é—¨</a><time datetime="2022-04-03T05:45:34.660Z" title="å‘è¡¨äº 2022-04-03 13:45:34">2022-04-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/p/17467/" title="C++ä»é›¶å¼€å§‹ï¼ˆåä¸€ï¼‰ï¼šC++è¿›é˜¶ï¼ˆä¸‹ï¼‰STL">C++ä»é›¶å¼€å§‹ï¼ˆåä¸€ï¼‰ï¼šC++è¿›é˜¶ï¼ˆä¸‹ï¼‰STL</a><time datetime="2022-02-14T09:55:49.585Z" title="å‘è¡¨äº 2022-02-14 17:55:49">2022-02-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/p/51012/" title="C++ä»é›¶å¼€å§‹ï¼ˆåï¼‰ï¼šC++è¿›é˜¶ï¼ˆä¸Šï¼‰æ¨¡æ¿">C++ä»é›¶å¼€å§‹ï¼ˆåï¼‰ï¼šC++è¿›é˜¶ï¼ˆä¸Šï¼‰æ¨¡æ¿</a><time datetime="2022-02-11T08:17:22.936Z" title="å‘è¡¨äº 2022-02-11 16:17:22">2022-02-11</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By Wanghui Huang</div><div class="footer_custom_text">Support By <a target="_blank" rel="noopener" href="https://cloud.tencent.com/" style="text-decoration:underline; color:#476679;"> Tencent Cloud </a> |  <a target="_blank" rel="noopener" href="https://hexo.io/" style="text-decoration:underline; color:#476679;">Hexo</a> | <a target="_blank" rel="noopener" href="https://butterfly.js.org/" style="text-decoration:underline; color:#476679;">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="æ”¾å¤§å­—ä½“"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="ç¼©å°å­—ä½“"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'blog-comments-5g2cfsved8c0de34',
      region: 'ap-shanghai'
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'blog-comments-5g2cfsved8c0de34',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script src="https://cdn.jsdelivr.net/npm/hexo-widget-tree@0.2.2/js/index.js"></script><div id="widget-tree">
      <h1 id="tree-toc-title" style="text-align:center;margin:0;line-hight:1.5"> <a href="https://hwh.zone/categories/">ç›® å½• </a> </h1>
      <h5 id="tree-toc-subtitle" style="text-align:center;margin:0;line-hight:1.5"> <a href="https://hwh.zone/">royhuang's blog</a> </h5>
      <ul>
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/C/">
          C++
        </a>
      <ul class="tree-list-children">
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/C/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B/">
          ä»é›¶å¼€å§‹
        </a>
      <ul class="tree-list-children">
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/C/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B/C-%E5%9F%BA%E7%A1%80/">
          C++åŸºç¡€
        </a>
      <ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/p/6587/" title="C++ä»é›¶å¼€å§‹ï¼ˆå…­ï¼‰ï¼šåŠ¡å®åŸºç¡€ï¼ˆä¸‹ï¼‰å¤åˆç±»å‹åŠè½¬æ¢"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆå…­ï¼‰ï¼šåŠ¡å®åŸºç¡€ï¼ˆä¸‹ï¼‰å¤åˆç±»å‹åŠè½¬æ¢</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/26224/" title="C++ä»é›¶å¼€å§‹ï¼ˆä¸‰ï¼‰ï¼šåŠ¡å®åŸºç¡€ï¼ˆä¸Šï¼‰å¿«é€Ÿå…¥é—¨"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆä¸‰ï¼‰ï¼šåŠ¡å®åŸºç¡€ï¼ˆä¸Šï¼‰å¿«é€Ÿå…¥é—¨</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/51595/" title="C++ä»é›¶å¼€å§‹ï¼ˆäº”ï¼‰ï¼šåŠ¡å®åŸºç¡€ï¼ˆä¸‹ï¼‰å‡½æ•°"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆäº”ï¼‰ï¼šåŠ¡å®åŸºç¡€ï¼ˆä¸‹ï¼‰å‡½æ•°</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/24237/" title="C++ä»é›¶å¼€å§‹ï¼ˆå››ï¼‰ï¼šåŠ¡å®åŸºç¡€ï¼ˆä¸­ï¼‰æŒ‡é’ˆå’Œå¼•ç”¨"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆå››ï¼‰ï¼šåŠ¡å®åŸºç¡€ï¼ˆä¸­ï¼‰æŒ‡é’ˆå’Œå¼•ç”¨</a></li></ul></li>
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/C/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B/C-%E8%BF%9B%E9%98%B6/">
          C++è¿›é˜¶
        </a>
      <ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/p/51012/" title="C++ä»é›¶å¼€å§‹ï¼ˆåï¼‰ï¼šC++è¿›é˜¶ï¼ˆä¸Šï¼‰æ¨¡æ¿"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆåï¼‰ï¼šC++è¿›é˜¶ï¼ˆä¸Šï¼‰æ¨¡æ¿</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/17467/" title="C++ä»é›¶å¼€å§‹ï¼ˆåä¸€ï¼‰ï¼šC++è¿›é˜¶ï¼ˆä¸‹ï¼‰STL"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆåä¸€ï¼‰ï¼šC++è¿›é˜¶ï¼ˆä¸‹ï¼‰STL</a></li></ul></li>
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/C/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B/C-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">
          C++ç¯å¢ƒæ­å»º
        </a>
      <ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/p/18652/" title="C++ä»é›¶å¼€å§‹ï¼ˆä¸€ï¼‰ï¼šç¯å¢ƒæ­å»ºï¼ˆä¸Šï¼‰VSCodeè¿œç¨‹å¼€å‘"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆä¸€ï¼‰ï¼šç¯å¢ƒæ­å»ºï¼ˆä¸Šï¼‰VSCodeè¿œç¨‹å¼€å‘</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/2834/" title="C++ä»é›¶å¼€å§‹ï¼ˆäºŒï¼‰ï¼šç¯å¢ƒæ­å»ºï¼ˆä¸‹ï¼‰g++/Makefile/CMakeå¿«é€Ÿå…¥é—¨"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆäºŒï¼‰ï¼šç¯å¢ƒæ­å»ºï¼ˆä¸‹ï¼‰g++/Makefile/CMakeå¿«é€Ÿå…¥é—¨</a></li></ul></li>
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/C/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B/C-%E9%9D%A2%E5%AF%B9%E5%AF%B9%E8%B1%A1/">
          C++é¢å¯¹å¯¹è±¡
        </a>
      <ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/p/17506/" title="C++ä»é›¶å¼€å§‹ï¼ˆä¸ƒï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸Šï¼‰å¿«é€Ÿå…¥é—¨"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆä¸ƒï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸Šï¼‰å¿«é€Ÿå…¥é—¨</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/60158/" title="C++ä»é›¶å¼€å§‹ï¼ˆä¹ï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸‹ï¼‰ç»§æ‰¿å’Œè™šå‡½æ•°"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆä¹ï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸‹ï¼‰ç»§æ‰¿å’Œè™šå‡½æ•°</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/43924/" title="C++ä»é›¶å¼€å§‹ï¼ˆå…«ï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸­ï¼‰è¿ç®—ç¬¦é‡è½½"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆå…«ï¼‰ï¼šé¢å¯¹å¯¹è±¡ï¼ˆä¸­ï¼‰è¿ç®—ç¬¦é‡è½½</a></li></ul></li>
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/C/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/">
          Linuxç³»ç»Ÿç¼–ç¨‹
        </a>
      <ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/p/45495/" title="C++ä»é›¶å¼€å§‹ï¼ˆåäºŒï¼‰ï¼šLinuxç³»ç»Ÿç¼–ç¨‹å…¥é—¨"><i class="post-icon gg-file-document"></i>C++ä»é›¶å¼€å§‹ï¼ˆåäºŒï¼‰ï¼šLinuxç³»ç»Ÿç¼–ç¨‹å…¥é—¨</a></li></ul></li></ul></li></ul></li>
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/%E5%BB%BA%E7%AB%99/">
          å»ºç«™
        </a>
      <ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/p/56326/" title="Hexo+Github Pageså¿«é€Ÿæ‰“é€ å±äºè‡ªå·±çš„ç½‘ç«™"><i class="post-icon gg-file-document"></i>Hexo+Github Pageså¿«é€Ÿæ‰“é€ å±äºè‡ªå·±çš„ç½‘ç«™</a></li></ul></li>
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/Git/">
          Git
        </a>
      <ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/p/43848/" title="GitåŸºç¡€ç¬”è®°ï¼ˆåˆæ­¥æ•´ç†ï¼‰"><i class="post-icon gg-file-document"></i>GitåŸºç¡€ç¬”è®°ï¼ˆåˆæ­¥æ•´ç†ï¼‰</a></li></ul></li>
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/%E6%A0%A1%E6%8B%9B%E7%AC%94%E8%AE%B0/">
          æ ¡æ‹›ç¬”è®°
        </a>
      <ul class="tree-list-children">
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/%E6%A0%A1%E6%8B%9B%E7%AC%94%E8%AE%B0/JAVA/">
          JAVA
        </a>
      <ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/p/42516/" title="æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_JVM"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_JVM</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/8959/" title="æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_å¤šçº¿ç¨‹"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_å¤šçº¿ç¨‹</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/51787/" title="æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_Javaå…¥é—¨"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_Javaå…¥é—¨</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/7257/" title="æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_é¢å¯¹å¯¹è±¡"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_é¢å¯¹å¯¹è±¡</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/45493/" title="æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_é”"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_é”</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/21069/" title="æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_é›†åˆ"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆä¸€ï¼‰_Java_é›†åˆ</a></li></ul></li>
      <li class="tree-list-item">
        <i class="toggle-post-icon gg-folder-add"></i>
        <a class="tree-list-link" href="/categories/%E6%A0%A1%E6%8B%9B%E7%AC%94%E8%AE%B0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">
          è®¡ç®—æœºåŸºç¡€
        </a>
      <ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/p/61434/" title="æ ¡æ‹›ç¬”è®°ï¼ˆä¸ƒï¼‰_è®¡ç®—æœºåŸºç¡€_æ•°æ®ç»“æ„"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆä¸ƒï¼‰_è®¡ç®—æœºåŸºç¡€_æ•°æ®ç»“æ„</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/44980/" title="æ ¡æ‹›ç¬”è®°ï¼ˆäºŒï¼‰_è®¡ç®—æœºåŸºç¡€_Linux&Git"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆäºŒï¼‰_è®¡ç®—æœºåŸºç¡€_Linux&Git</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/5582/" title="æ ¡æ‹›ç¬”è®°ï¼ˆä¹ï¼‰_è®¡ç®—æœºåŸºç¡€_ç›¸å…³è¡¥å……"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆä¹ï¼‰_è®¡ç®—æœºåŸºç¡€_ç›¸å…³è¡¥å……</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/46361/" title="æ ¡æ‹›ç¬”è®°ï¼ˆä¸‰ï¼‰_è®¡ç®—æœºåŸºç¡€_è®¡ç®—æœºç½‘ç»œ"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆä¸‰ï¼‰_è®¡ç®—æœºåŸºç¡€_è®¡ç®—æœºç½‘ç»œ</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/31667/" title="æ ¡æ‹›ç¬”è®°ï¼ˆå…«ï¼‰_è®¡ç®—æœºåŸºç¡€_åœºæ™¯&æ™ºåŠ›é¢˜"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆå…«ï¼‰_è®¡ç®—æœºåŸºç¡€_åœºæ™¯&æ™ºåŠ›é¢˜</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/56848/" title="æ ¡æ‹›ç¬”è®°ï¼ˆäº”ï¼‰_è®¡ç®—æœºåŸºç¡€_MySQL"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆäº”ï¼‰_è®¡ç®—æœºåŸºç¡€_MySQL</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/31215/" title="æ ¡æ‹›ç¬”è®°ï¼ˆå…­ï¼‰_è®¡ç®—æœºåŸºç¡€_Redis"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆå…­ï¼‰_è®¡ç®—æœºåŸºç¡€_Redis</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/p/15646/" title="æ ¡æ‹›ç¬”è®°ï¼ˆå››ï¼‰_è®¡ç®—æœºåŸºç¡€_æ“ä½œç³»ç»Ÿ"><i class="post-icon gg-file-document"></i>æ ¡æ‹›ç¬”è®°ï¼ˆå››ï¼‰_è®¡ç®—æœºåŸºç¡€_æ“ä½œç³»ç»Ÿ</a></li></ul></li></ul></li></ul>
        <div id="widget-tree-button">
          <i class="gg-chevron-right"></i>
        </div>
      </div><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>